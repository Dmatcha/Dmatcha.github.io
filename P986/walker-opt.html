<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gameplay Guide - Linear Chance System</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }

body {
  background: #1C1C30;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  overflow: hidden;
}

    /* VIDEO BACKGROUND */
    .video-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
    }

    .video-bg {
      position: absolute;
      top: 50%;
      left: 50%;
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      transform: translate(-50%, -50%);
      object-fit: cover;
      filter: blur(2px) brightness(0.95) contrast(1.1);
      opacity: 0.99;
      pointer-events: none;
      transition: transform 0.3s ease;
    }

    @media (orientation: portrait) {
      .video-bg {
        transform: translate(-50%, -50%) rotate(90deg);
        min-width: 100%;
        min-height: 100%;
      }
    }

/* Main card container */
.container {
  width: 60vw;
  max-width: 520px;
  height: 80vh;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 0 25px rgba(0,0,0,0.6);
  text-align: center;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  transition: background 0.8s ease;
}

/* Day and night background themes */
.container.day-theme {
  background: linear-gradient(145deg, #943a09, #f29422);
  box-shadow: 0 0 40px rgba(240,200,30,0.5);
}

.container.night-theme {
  background: linear-gradient(135deg, #202050, #0E0E20);
  box-shadow: 0 0 40px rgba(100,100,255,0.5);
}

/* Header */
.header { display: flex; justify-content: space-between; margin-bottom: 12px; }
.day-label, .slot-label { font-size: 1.45rem; font-weight: bold; }

/* Central text area */
.text-area {
  flex: 1;
  margin: 16px 0;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 16px;
  overflow-y: auto;
  text-align: left;
  line-height: 1.5;
  font-size: 1.33rem;
}

/* Buttons */
.button {
  width: 100%;
  padding: 14px;
  margin: 8px 0;
  border: none;
  border-radius: 12px;
  font-size: 1.50rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.35s ease;
}
.button:disabled { opacity: 0.4; cursor: default; }

.act-btn { background: #ffb347; color: #1e1e2f; }
.map-btn { background: #ffd700; color: #1e1e2f; }
.next-btn { background: #ff7f50; color: #fff; }
.dawn-btn { background: #87ceeb; color: #1e1e2f; }
.night-btn { background: #6a5acd; color: #fff; }
.interstitial-btn { background: #ff6347; color: #fff; }

/* Checkbox styling */
.checkbox {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 12px;
  border: 2px solid #fff;
  cursor: pointer;
  transition: all 0.5s;
  user-select: none;
  font-size: 1.25rem;
}
.checkbox.checked {
  background: #32cd32;
  color: #1e1e2f;
}

/* Reset button */
.reset-btn {
  position: absolute;
  top: 16px;
  left: 16px;
  padding: 8px 12px;
  background: #ff4d4d;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  color: #fff;
  font-weight: bold;
  z-index: 5;
}

/* Scrollbar styling */
.text-area::-webkit-scrollbar { width: 8px; }
.text-area::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}
.text-area::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.4);
}
.button.interstitial-btn {
  opacity: 0.4;
  transition: all 0.5s ease;
}
.button.interstitial-btn.active {
  opacity: 1;
}

/* Mobile: use wider relative width */
@media (max-width: 600px) {
  .container {
    width: 92vw;
    max-width: none;
    min-width: 300px;
  }
}

/* Flavor text styling by pool */
.pool-0 { color: #87ceeb; font-style: italic; }
.pool-1 { color: #ffd700; font-style: italic; }
.pool-2 { color: #98fb98; font-style: italic; }
.pool-3 { color: #dda0dd; font-style: italic; }
.pool-4 { color: #ff69b4; font-style: italic; }
</style>

</head>
<body>
<body>
  <!-- üîÅ VIDEO BACKGROUND -->
  <div class="video-wrapper">
    <video class="video-bg" autoplay muted loop playsinline>
      <source src="../media/12530-239934669_medium.mp4" type="video/mp4" />
      Your browser does not support the video tag.
    </video>
  </div>
<button class="reset-btn" onclick="resetGame()">RESET</button>

<div class="container">
  <div class="header">
    <div class="day-label" id="dayLabel">DAWN of Cycle 1</div>
    <div class="slot-label" id="slotLabel">[0]</div>
  </div>

  <div class="text-area" id="textArea">ZERODAWN <br>YOU SHOULD NOT SEE THIS!
  </div>
  
  <div id="checkboxes" style="display:none;">
    <div class="checkbox" id="actCheckbox">ACT</div>
    <div class="checkbox" id="mapCheckbox">REVEAL</div>
  </div>
  
  <button class="button" id="mainButton">CONTINUE</button>
</div>

<script>
/* State */
let cycle = 1;
let slot = 0;
let isNight = false;
let nightStep = 0;
let phaseMode = null;

/* Theme container ref */
const container = document.querySelector('.container');

/* Helper: set container color theme */
function setContainerTheme(theme) {
  container.classList.remove('day-theme', 'night-theme');
  if (theme === 'day') container.classList.add('day-theme');
  else if (theme === 'night') container.classList.add('night-theme');
}

/* --- Linear Chance System --- */

// Calculate linear chance using formula: base + (rate * cycle)
// Returns percentage as decimal (0.0 to 1.0)
function calculateLinearChance(base, rate, cycle) {
  return Math.max(0, Math.min(1, base + (rate * cycle)));
}

// Calculate step chance using formula with step intervals
function calculateStepChance(startCycle, rate, cycle) {
  if (cycle < startCycle) return 0;
  const steps = Math.floor((cycle - startCycle) / 2); // Steps every 2 cycles
  return steps * rate;
}

// Main text options for each slot (3 exclusive options per slot)
const mainTextOptions = {
  1: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You must play an Adventure card.`, base: 0, rate: 1 },
    { text: `If you play an Adventure card, lose 1 stamina.`, base: 0, rate: 1 }
  ],
  2: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You may play any card. If you play an event, regain 1 life immediately.`, base: 0, rate: 1 },
    { text: `You may play any card. If you play a discovery, gain 1 coin.`, base: 0, rate: 1 }
  ],
  3: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `Gain 1 empower if you play a B or C card.`, base: 0, rate: 1 },
    { text: `You may play any card. If all cards played so far are the same type, everyone regains 3 life.`, base: 0, rate: 1 }
  ],
  4: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You may play any card. If you begin a combat encounter gain 1 empower.`, base: 0, rate: 1 },
    { text: `You may play any card. If you have no empower, lose 1 life.`, base: 0, rate: 1 }
  ],
  5: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You must play a B or C card.`, base: 0, rate: 1 },
    { text: `You may play any card. Flip a coin: if heads gain 1 coin, if tails lose 1 coin.`, base: 0, rate: 1 }
  ],
  6: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You must play a B or C card. Add 1 to the loot pile.`, base: 0, rate: 1 },
    { text: `You may play any card. If you play a B card, remove all your empower and add that many coins to the loot pile.`, base: 0, rate: 1 }
  ],
  7: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You must play a B card.`, base: 0, rate: 1 },
    { text: `You must play a A card.`, base: 0, rate: 1 }
  ],
  8: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You may play any card. If you have no coins, lose 1 madness.`, base: 0, rate: 1 },
    { text: `You may play any card. If you have more madness than coins, lose 1 life.`, base: 0, rate: 1 }
  ],
  9: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You may play any card. If you have a buddy, regain 1 life.`, base: 0, rate: 1 },
    { text: `You may play any card. If you have a blessing, regain 1 stamina.`, base: 0, rate: 1 }
  ],
  10: [
    { text: `You may play any card.`, base: 100, rate: -2 },
    { text: `You may play any card. Regain 1 life per relationship rank 6 or higher.`, base: 0, rate: 1 },
    { text: `You may play any card. Add 1 coin to the loot pile per relationship rank 5 or lower.`, base: 0, rate: 1 }
  ],
  11: [
    { text: `You must play a B or C card.`, base: 100, rate: -2 },
    { text: `You must play a B card.`, base: 0, rate: 1 },
    { text: `You must play a C card.`, base: 0, rate: 1 }
  ]
};

// Night main text options (different from day)
const nightMainTextOptions = {
  12: [
    { text: `You must play a B card. <br><i>Add +1 coin to reward pile.</i>`, base: 100, rate: -2 },
    { text: `You must play a B card. <br><i>Add +2 coins to reward pile.</i>`, base: 0, rate: 1 },
    { text: `You must play a B card. <br><i>Add no coins to reward pile.</i>`, base: 0, rate: 1 }
  ],
  13: [
    { text: `You must play a C card. <br><i>Double reward pile.</i>`, base: 100, rate: -2 },
    { text: `You must play a C card. <br><i>Add +1 coin to reward pile.</i>`, base: 0, rate: 1 },
    { text: `You must play a C card. <br><i>An eerie howl creeps across the horizon...</i>`, base: 0, rate: 1 }
  ],
  14: [
    { text: `You must play a B card. <br><i>Double reward pile.</i>`, base: 100, rate: -2 },
    { text: `You must play a B card. <br><i>Add +1 coin to reward pile.</i>`, base: 0, rate: 1 },
    { text: `You must play a B card. <br><i>A foul stench creeps through the air...</i>`, base: 0, rate: 1 }
  ],
  15: [
    { text: `You must play a C card. <br><i>Double reward pile.</i>`, base: 100, rate: -2 },
    { text: `You must play a C card. <br><i>Add +1 coin to reward pile.</i>`, base: 0, rate: 1 },
    { text: `You must play a C card. <br><i>Chills bite at the hairs on your flesh...</i>`, base: 0, rate: 1 }
  ],
  16: [
    { text: `You must play a B card. <br><i>Double reward pile.</i>`, base: 100, rate: -2 },
    { text: `You must play a B card. <br><i>Add +1 coin to reward pile.</i>`, base: 0, rate: 1 },
    { text: `You must play a B card. <br><i>Shadows beckon at the edge of your vision...</i>`, base: 0, rate: 1 }
  ],
  17: [
    { text: `You must play a C card. <br><i>The night coils and twists, the end is near...</i>`, base: 100, rate: -2 },
    { text: `You must play a C card. <br><i>The night air sneers, knowing you intend to return...</i>`, base: 0, rate: 1 },
    { text: `You must play a C card. <br><i>The night coils and twists, the end is near...</i>`, base: 0, rate: 1 }
  ]
};

// Flavor text pools (Day vs Night) - 5 Pools √ó 5 Texts each
const flavorPools = {
  day: {
    0: [ // basic mechanics - High frequency, early game focus
      { text: `üí° <span class='pool-0'>Camp cards provide essential resources.
      </span>`, base: 1, rate: 1.8 },    // 1+(1.8*Cycle) - High growth
      { text: `üí° <span class='pool-0'>Camp cards require additional resources.
      </span>`, base: 1, rate: 1.5 },      // 1+(1.5*Cycle) - Medium-high
      { text: `üí° <span class='pool-0'>Camp cards recover 1 physicks.
      </span>`, base: 1, rate: 1.2 },  // 1+(1.2*Cycle) - Steady growth
      { text: `üí° <span class='pool-0'>Camp cards recover 1 magicks.
      </span>`, base: 1, rate: 1.0 },               // 1+(1.0*Cycle) - Moderate
      { text: `üí° <span class='pool-0'>Camp cards recover 1 of all stats.
      </span>`, base: 1, rate: 0.8 }    // 0+(0.8*Cycle) - Slower, later
    ],
    1: [ // Strategic - Medium frequency, mid game focus
      { text: `üéØ <span class='pool-1'>Merchants offer discounted items.
      </span>`, base: 0, rate: 1.2 }, // 0+(1.2*Cycle)
      { text: `üéØ <span class='pool-1'>If you have any equipment, regain 1 stamina.
      </span>`, base: 0, rate: 1.0 },  // 0+(1.0*Cycle)
      { text: `üéØ <span class='pool-1'>If you have any items, gain 1 energy.
      </span>`, base: 0, rate: 0.8 }, // 0+(0.8*Cycle)
      { text: `üéØ <span class='pool-1'>If you have any arcane items, regain 1 energy.
      </span>`, base: 2, rate: 0.6 },                   // 2+(0.6*Cycle)
      { text: `üéØ <span class='pool-1'>Regain 1 energy per soulgem and arcane item in your possession.
      </span>`, base: 0, rate: 0.9 }                // 0+(0.9*Cycle)
    ],
    2: [ // elements - Low frequency, builds gradually
      { text: `üìñ <span class='pool-2'>If you are enchanted, become blessed.
      </span>`, base: 0, rate: 0.8 },          // 0+(0.8*Cycle)
      { text: `üìñ <span class='pool-2'>If you have any quick cards: after revealing you, may discard a map card once this turn.
      </span>`, base: 0, rate: 0.6 },                   // 0+(0.6*Cycle)
      { text: `üìñ <span class='pool-2'>If you have more spells than madness, ignore madness resolves.
      </span>`, base: 0, rate: 0.9 },             // 0+(0.9*Cycle)
      { text: `üìñ <span class='pool-2'>If you have any quick cards, gain 1 empower.
      </span>`, base: 0, rate: 0.5 },           // 0+(0.5*Cycle)
      { text: `üìñ <span class='pool-2'>History repeats, but wisdom evolves. If you have the highest mastery, you may recycle a spell.
      </span>`, base: 0, rate: 0.7 }                    // 0+(0.7*Cycle)
    ],
    3: [ // Atmospheric/mysterious - Very low frequency, late game emphasis
      { text: `‚ú® <span class='pool-3'>The air tingles with anticipation... All players with less coalesce than you regain 1 coalesce.
      </span>`, base: 0, rate: 0.5 },     // 0+(0.5*Cycle)
      { text: `‚ú® <span class='pool-3'>Something stirs beyond the horizon. If you do not have a weapon, regain 1 coalesce.
      </span>`, base: 0, rate: 0.4 },      // 0+(0.4*Cycle)
      { text: `‚ú® <span class='pool-3'>Fate weaves its tapestry unseen. Regain 1 coalesce if you have more mastery than potency.
      </span>`, base: 0, rate: 0.6 },         // 0+(0.6*Cycle)
      { text: `‚ú® <span class='pool-3'>The boundary between dreams and reality blurs. Regain 3 coalesce if you have none. 
      </span>`, base: 0, rate: 0.3 }, // 0+(0.3*Cycle)
      { text: `‚ú® <span class='pool-3'>Destiny whispers to those who listen. You may regain 1 coalesce during your ACT.
      </span>`, base: 0, rate: 0.7 }     // 0+(0.7*Cycle)
    ],
    4: [ // Advanced mechanics - Medium frequency, builds with experience
      { text: `‚öôÔ∏è <span class='pool-4'>Your vision dims. You cannot activate your iris power.
      </span>`, base: 0, rate: 1.1 },           // 0+(1.1*Cycle)
      { text: `‚öôÔ∏è <span class='pool-4'>Discovery cards hold secrets yet uncovered: regain 1 more energy.
      </span>`, base: 0, rate: 0.9 },          // 0+(0.9*Cycle)
      { text: `‚öôÔ∏è <span class='pool-4'>Insight reveals hidden patterns in chaos: you may ignore an event's negative consequences.
      </span>`, base: 0, rate: 0.7 },            // 0+(0.7*Cycle)
      { text: `‚öôÔ∏è <span class='pool-4'>Advanced strategies emerge from mastering the basics: basic and simple actions are free during combat.
      </span>`, base: 0, rate: 0.8 }, // 0+(0.8*Cycle)
      { text: `‚öôÔ∏è <span class='pool-4'>Reward both boldness and haste: players with quick succeed instantly.
      </span>`, base: 0, rate: 1.0 }       // 0+(1.0*Cycle)
    ]
  },
  night: {
    0: [ // Night - Higher frequency, starts earlier
      { text: `üåô <span class='pool-0'>A chill up youre spine. Cards without empower injure the user if used.
      </span>`, base: 3, rate: 2.0 },      // 3+(2.0*Cycle) - High base + growth
      { text: `üåô <span class='pool-0'>Bony fingers around your neck. Cards with mana injure the user if used.
      </span>`, base: 2, rate: 1.8 }, // 2+(1.8*Cycle) - High
      { text: `üåô <span class='pool-0'>The caw of far off crows. Cards with energy injure the user if used. 
      </span>`, base: 1, rate: 1.5 },     // 1+(1.5*Cycle) - Medium-high
      { text: `üåô <span class='pool-0'>Lay down and never rise again. Cards with stamina injure the user if used. 
      </span>`, base: 0, rate: 1.2 },    // 0+(1.2*Cycle) - Steady
      { text: `üåô <span class='pool-0'>Suffocate in the night air. Physical actions cripple the user until dawn.
      </span>`, base: 2, rate: 1.4 }     // 2+(1.4*Cycle) - Good base
    ],
    1: [ // Night - High frequency, intensifies rapidly
      { text: `‚ö†Ô∏è <span class='pool-1'>The darkness judges you, all players with a curse take 1 damage.
      </span>`, base: 0, rate: 2.0 },       // 0+(2.0*Cycle)
      { text: `‚ö†Ô∏è <span class='pool-1'>Fear can be as dangerous as any enemy. Players wil the highest madness take 1 damage.
      </span>`, base: 0, rate: 1.8 },       // 0+(1.8*Cycle)
      { text: `‚ö†Ô∏è <span class='pool-1'>What you cannot see may yet harm you. Gain dread until dawn.
      </span>`, base: 0, rate: 1.6 },        // 0+(1.6*Cycle)
      { text: `‚ö†Ô∏è <span class='pool-1'>The night remembers every mistake. Fail any resolve.
      </span>`, base: 1, rate: 1.9 },           // 1+(1.9*Cycle)
      { text: `‚ö†Ô∏è <span class='pool-1'>Courage must overcome doubt in darkness. Lose 1 madness.
      </span>`, base: 0, rate: 1.7 }     // 0+(1.7*Cycle)
    ],
    2: [ // Night lore - Medium frequency, story elements
      { text: `üìö <span class='pool-2'>Old tales speak of those who conquered the night. Lose 1 madness if you have more potency than madness.
      </span>`, base: 0, rate: 1.2 },   // 0+(1.2*Cycle)
      { text: `üìö <span class='pool-2'>The night has memory and seeks revenge. Panic if you have more madness than potency.
      </span>`, base: 0, rate: 1.0 },             // 0+(1.0*Cycle)
      { text: `üìö <span class='pool-2'>Some say the night is eternal, others disagree. Lose 1 madness if you have more mastery than madness.
      </span>`, base: 0, rate: 0.8 },      // 0+(0.8*Cycle)
      { text: `üìö <span class='pool-2'>The darkest hour comes just before dawn. Untap one card.
      </span>`, base: 0, rate: 1.1 },            // 0+(1.1*Cycle)
      { text: `üìö <span class='pool-2'>Legends are born from those who survive the night. Gain quick until dawn.
      </span>`, base: 0, rate: 0.9 }    // 0+(0.9*Cycle)
    ],
    3: [ // Night atmosphere - Lower frequency, atmospheric focus
      { text: `üåå <span class='pool-3'>Stars peek behind clouds. Everyone regains 1 life per camp revealed so far this night.
      </span>`, base: 0, rate: 0.9 },        // 0+(0.9*Cycle)
      { text: `üåå <span class='pool-3'>The void between worlds grows thinner. The player with the lowest mastery must resolve madness.
      </span>`, base: 0, rate: 0.7 },    // 0+(0.7*Cycle)
      { text: `üåå <span class='pool-3'>The night sky offers no comfort to the lost. Lose mana equal to your current madness.
      </span>`, base: 0, rate: 0.6 }, // 0+(0.6*Cycle)
      { text: `üåå <span class='pool-3'>Silence carries a boiling terror. The player with the lowest strength must resolve madness.
      </span>`, base: 0, rate: 0.8 },    // 0+(0.8*Cycle)
      { text: `üåå <span class='pool-3'>A sense of doom befalls you. If you are cursed, lose all mana.
      </span>`, base: 0, rate: 0.5 } // 0+(0.5*Cycle)
    ],
    4: [ // Night mechanics - Specialized advice
      { text: `üåü <span class='pool-4'>Night battles favor the prepared and decisive. If you have a weapon regain mana equal to your strength.
      </span>`, base: 0, rate: 1.3 },          // 0+(1.3*Cycle)
      { text: `üåü <span class='pool-4'>Quick actions carry greater weight in darkness. If you have a weapon regain mana equal to your skill.
      </span>`, base: 0, rate: 1.1 },          // 0+(1.1*Cycle)
      { text: `üåü <span class='pool-4'>The night rewards those who adapt quickly. If you have an arcane item regain mana and energy equal to your mastery.
      </span>`, base: 0, rate: 0.9 },               // 0+(0.9*Cycle)
      { text: `üåü <span class='pool-4'>Strategic retreat often leads to victory. Gain 1 empower. Gain 1 more if your highest trait is skill.
      </span>`, base: 0, rate: 0.8 },               // 0+(0.8*Cycle)
      { text: `üåü <span class='pool-4'>The night teaches lessons that daylight cannot. Resolve: if you fail, gaze up at the moon; mouth agape.
      </span>`, base: 1, rate: 1.0 }          // 0+(1.0*Cycle)
    ]
  }
};

// Get main text for specific slot using independent chance calculation
function getMainText(slotNum, isNight = false) {
  const textOptions = isNight ? nightMainTextOptions[slotNum] : mainTextOptions[slotNum];
  if (!textOptions) return "No text available for this slot.";
  
  // Calculate individual chances for each text
  const chances = textOptions.map(option => {
    const chancePercent = Math.max(0, option.base + (option.rate * cycle));
    return {
      text: option.text,
      chance: Math.min(100, chancePercent) / 100 // Convert to decimal 0-1
    };
  });
  
  // Convert percentages to weighted selection
  const totalChance = chances.reduce((sum, c) => sum + c.chance, 0);
  
  if (totalChance === 0) return textOptions[0].text; // Fallback
  
  const random = Math.random() * totalChance;
  let cumulative = 0;
  
  for (const chance of chances) {
    cumulative += chance.chance;
    if (random <= cumulative) {
      return chance.text;
    }
  }
  
  // Fallback to first option
  return chances[0].text;
}

// Get flavor text from pools using independent dice rolls
function getFlavorText(slotNum, isNight = false) {
  const pools = isNight ? flavorPools.night : flavorPools.day;
  let result = "";
  
  // Each pool rolls independently - multiple texts can appear or none
  for (let poolIndex = 0; poolIndex < 5; poolIndex++) {
    const poolTexts = pools[poolIndex];
    if (!poolTexts) continue;
    
    // Roll for each text in the pool independently
    for (const textObj of poolTexts) {
      const chancePercent = Math.max(0, textObj.base + (textObj.rate * cycle));
      const probability = Math.min(100, chancePercent) / 100;
      
      if (Math.random() < probability) {
        result += "<br><br>" + textObj.text;
      }
    }
  }
  
  return result;
}

/* Text composition functions */
function getDayText(slot) {
  let baseText = getMainText(slot, false);
  baseText += getFlavorText(slot, false);
  return baseText;
}

function getNightText(nightStep) {
  const slotNum = 12 + nightStep;
  let baseText = getMainText(slotNum, true);
  baseText += getFlavorText(slotNum, true);
  return baseText;
}

/* --- UI Update --- */
function updateUI() {
  cleanupTransientButtons();

  if (slot === 0) {
    setContainerTheme('day');
    dayLabel.innerText = `DAWN of Cycle ${cycle}`;
    slotLabel.innerText = '[0]';
    textArea.innerHTML = "All players gain <strong>one level!</strong> <br>All players regain all <strong>light mana!</strong>";
    checkboxesDiv.style.display = 'none';
    mainButton.style.display = 'block';
    mainButton.innerText = 'CONTINUE';
    mainButton.disabled = false;
    phaseMode = null;
    return;
  }

  if (!isNight && slot > 0 && slot <= daySlots) {
    setContainerTheme('day');
    dayLabel.innerText = `The ${ordinal(cycle)} Day`;
    slotLabel.innerText = `[${slot}]`;
    textArea.innerHTML = getDayText(slot);
    checkboxesDiv.style.display = 'flex';
    restoreStableCheckboxes();
    actCheckbox.classList.remove('checked');
    mapCheckbox.classList.remove('checked');
    mainButton.innerText = 'NEXT PLAYER';
    mainButton.disabled = true;
    mainButton.style.display = 'block';
    phaseMode = null;
    return;
  }

  if (isNight) {
    setContainerTheme('night');
    dayLabel.innerText = `The ${ordinal(cycle)} Night`;
    slotLabel.innerText = `[${12 + nightStep}]`;
    textArea.innerHTML = getNightText(nightStep);
    checkboxesDiv.style.display = 'flex';
    restoreStableCheckboxes();
    actCheckbox.classList.remove('checked');
    mapCheckbox.classList.remove('checked');
    mainButton.innerText = (nightStep === nightSlots - 1) ? 'END THE NIGHT' : 'NEXT PLAYER';
    mainButton.disabled = true;
    mainButton.style.display = 'block';
    phaseMode = null;
    return;
  }
}

const daySlots = 11;
const nightSlots = 6;

/* Elements */
const dayLabel = document.getElementById('dayLabel');
const slotLabel = document.getElementById('slotLabel');
const textArea = document.getElementById('textArea');
const mainButton = document.getElementById('mainButton');
const checkboxesDiv = document.getElementById('checkboxes');
let actCheckbox = document.getElementById('actCheckbox');
let mapCheckbox = document.getElementById('mapCheckbox');

/* Helpers */
function ordinal(n) {
  return ["First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh","Twelfth","Thirteenth"][n - 1] || n + "th";
}

function enableMainIfBothChecked() {
  if (!actCheckbox || !mapCheckbox) { mainButton.disabled = true; return; }
  mainButton.disabled = !(actCheckbox.classList.contains('checked') && mapCheckbox.classList.contains('checked'));
}

/* Core transitions */
function goToDawn(increment = true) {
  if (increment) cycle++;
  isNight = false;
  nightStep = 0;
  slot = 0;
  phaseMode = null;
  cleanupTransientButtons();
  restoreStableCheckboxes();
  updateUI();
}

function restoreStableCheckboxes() {
  if (!document.getElementById('actCheckbox') || !document.getElementById('mapCheckbox')) {
    checkboxesDiv.innerHTML = '<div class="checkbox" id="actCheckbox">ACT</div><div class="checkbox" id="mapCheckbox">REVEAL</div>';
    actCheckbox = document.getElementById('actCheckbox');
    mapCheckbox = document.getElementById('mapCheckbox');
    actCheckbox.addEventListener('click', toggleCheckbox);
    mapCheckbox.addEventListener('click', toggleCheckbox);
  }
  actCheckbox.classList.remove('checked');
  mapCheckbox.classList.remove('checked');
}

function cleanupTransientButtons() {
  document.querySelectorAll('.container button.dawn-btn, .container button.night-btn, .container button.interstitial-btn').forEach(b => b.remove());
}

function toggleCheckbox() {
  this.classList.toggle('checked');
  enableMainIfBothChecked();
}

/* DUSK */
function showDuskChoice() {
  checkboxesDiv.style.display = 'none';
  mainButton.style.display = 'none';
  textArea.innerHTML = "<strong>DUSK: </strong><br>Choose to proceed to DAWN... <br>...or enter the NIGHT.";

  const dawnBtn = document.createElement('button');
  dawnBtn.className = 'button dawn-btn';
  dawnBtn.innerText = 'Proceed to DAWN';
  dawnBtn.disabled = true;

  const nightBtn = document.createElement('button');
  nightBtn.className = 'button night-btn';
  nightBtn.innerText = 'Enter the NIGHT';
  nightBtn.disabled = true;

  container.appendChild(dawnBtn);
  container.appendChild(nightBtn);

  setContainerTheme('night'); // transition during dusk

  let cooldown = 3;
  const interval = setInterval(() => {
    cooldown--;
    if (cooldown <= 0) {
      dawnBtn.disabled = false;
      nightBtn.disabled = false;
      clearInterval(interval);
    }
  }, 1000);

  dawnBtn.addEventListener('click', () => {
    dawnBtn.remove(); nightBtn.remove();
    goToDawn(true);
  });

  nightBtn.addEventListener('click', () => {
    dawnBtn.remove(); nightBtn.remove();
    isNight = true;
    nightStep = 0;
    slot = 12;
    updateUI();
  });
}

/* Night interstitial */
function showContinueNightInterstitial() {
  checkboxesDiv.style.display = 'none';
  mainButton.style.display = 'none';
  textArea.innerHTML = "Choose your next action wisely...";

  const endBtn = document.createElement('button');
  endBtn.className = 'button interstitial-btn';
  endBtn.innerText = 'Loot rewards, proceed to the DAWN!';
  endBtn.disabled = true;

  const contBtn = document.createElement('button');
  contBtn.className = 'button interstitial-btn';
  contBtn.innerText = 'Continue deeper into the NIGHT...';
  contBtn.disabled = true;

  container.appendChild(endBtn);
  container.appendChild(contBtn);

  let cooldown = 1;
  const interval = setInterval(() => {
    cooldown--;
    if (cooldown <= 0) {
      endBtn.disabled = false;
      contBtn.disabled = false;
      endBtn.classList.add('active');
      contBtn.classList.add('active');
      clearInterval(interval);
    }
  }, 1000);

  endBtn.addEventListener('click', () => {
    endBtn.remove(); contBtn.remove();
    goToDawn(true);
  });

  contBtn.addEventListener('click', () => {
    endBtn.remove(); contBtn.remove();
    nightStep++;
    slot++;
    updateUI();
  });
}

/* Deep of Night */
function showDeepOfNight() {
  phaseMode = 'deep';
  setContainerTheme('night');
  dayLabel.innerText = `The Deep Of The ${ordinal(cycle)} Night`;
  slotLabel.innerText = "[17]";
  textArea.innerHTML = "Congratulations, you have survived the night...";

  checkboxesDiv.innerHTML = '';
  const lootBtn = document.createElement('div');
  lootBtn.className = 'checkbox';
  lootBtn.innerText = 'Loot the rewards!!';

  const levelBtn = document.createElement('div');
  levelBtn.className = 'checkbox';
  levelBtn.innerText = 'Everyone gain 1 level!';

  checkboxesDiv.appendChild(lootBtn);
  checkboxesDiv.appendChild(levelBtn);
  checkboxesDiv.style.display = 'flex';

  mainButton.innerText = 'NEXT PLAYER';
  mainButton.disabled = true;
  mainButton.style.display = 'block';

  function checkDeep() {
    mainButton.disabled = !(lootBtn.classList.contains('checked') && levelBtn.classList.contains('checked'));
  }

  lootBtn.addEventListener('click', () => { lootBtn.classList.toggle('checked'); checkDeep(); });
  levelBtn.addEventListener('click', () => { levelBtn.classList.toggle('checked'); checkDeep(); });
}

/* Main button */
function handleMainButton() {
  if (phaseMode === 'deep') { goToDawn(true); return; }

  if (!isNight) {
    if (slot === 0) { slot = 1; updateUI(); return; }
    if (slot < daySlots) { slot++; updateUI(); return; }
    showDuskChoice();
    return;
  } else {
    if (nightStep < nightSlots - 1) { showContinueNightInterstitial(); return; }
    else { showDeepOfNight(); return; }
  }
}

/* Reset */
function resetGame() {
  if (!confirm("Are you sure you want to reset all game data?")) return;
  cycle = 1; slot = 0; isNight = false; nightStep = 0; phaseMode = null;
  cleanupTransientButtons();
  checkboxesDiv.innerHTML = '<div class="checkbox" id="actCheckbox">ACT</div><div class="checkbox" id="mapCheckbox">REVEAL</div>';
  actCheckbox = document.getElementById('actCheckbox');
  mapCheckbox = document.getElementById('mapCheckbox');
  actCheckbox.addEventListener('click', toggleCheckbox);
  mapCheckbox.addEventListener('click', toggleCheckbox);
  actCheckbox.classList.remove('checked');
  mapCheckbox.classList.remove('checked');
  checkboxesDiv.style.display = 'none';
  dayLabel.innerText = "DAWN of Cycle 1";
  slotLabel.innerText = "[0]";
  textArea.innerHTML = "All players gain <strong>one level!</strong> <br>All players regain all <strong>light mana!</strong>";
  mainButton.innerText = "CONTINUE";
  mainButton.disabled = false;
  mainButton.style.display = 'block';
  setContainerTheme('day');
}

/* Attach listeners + init */
mainButton.addEventListener('click', handleMainButton);
actCheckbox.addEventListener('click', toggleCheckbox);
mapCheckbox.addEventListener('click', toggleCheckbox);
updateUI();
</script>

</body>
</html>
