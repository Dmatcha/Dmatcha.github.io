<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Player</title>

<style>
  :root{
    /* Base font size for rem calculations */
    font-size: 1rem;
    
    --bg:#121212;
    --card:#1f1f1f;
    --muted:#9aa3ad;
    --accent-purple: rgba(106,27,154,0.22);
    --gold: #D4AF37;
    --blue-cool:#66ccff;
    --glass: rgba(255,255,255,0.04);
    --heart-white: #ffffff;
    --heart-blue: #4da6ff;
    --heart-purple: #9b59b6;
    --heart-red: #ff8fa3;
    --scarlet-pink: #ff8fa3;
    
    /* Mind button purple colors */
    --mind-bright-purple: #d4a5ff;
    --mind-dark-purple: #5e2a8c;
    --mind-border-active: #3d1a5c;
    
    /* Animation timing variables for consistency */
    --fade-in-duration: 0.3s;
    --fade-out-duration: 2s;
    --icon-linger-duration: 3s;
    --easing-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    --easing-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    
    /* Professional press-and-hold timing */
    --hold-duration: 2.5s; /* 2.5 seconds as requested */
    --hold-easing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
    /* Note: Stats only increase when hold completes, not on click */
    --progress-color: #ffffff; /* White for regular attributes */
    --progress-bg: rgba(255, 255, 255, 0.2);
    --flash-color: #ffffff; /* White flash */
  }

  html,body{height:100%;margin:0;}
  body{
    margin:0;
    min-height:100%;
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    background: linear-gradient(180deg,#0f0f12 0%, #141417 60%);
    color:#e9eef6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .wrap{
    max-width:56.25rem; /* 900px */
    margin:0.875rem auto;
    padding:1rem;
  }

  /* Player name */
  #playerName{
    width:100%;
    display:block;
    font-size:2.0rem;
    text-align:center;
    background:transparent;
    color: #fff;
    border: 0;
    outline:0;
    padding:0.3rem 0.3rem;
    margin-top:1.5rem;
    margin-bottom:0.5rem;
  }
  #playerName::placeholder{ color: rgba(255,255,255,0.35); }

  /* ---------- Bars layout: grid 2 cols on wide, 1 col + reorder on small ---------- */
  .bars {
    display:grid;
    grid-template-columns: repeat(2, minmax(13.75rem, 1fr)); /* 220px */
    gap:1.2rem; /* 20px */
    margin-bottom:1rem; /* 16px */
  }

  @media (max-width: 45.1rem) { /* 720px */
    .bars { grid-template-columns: 1fr; }

    .bar-card[data-key="life"]     { order: 1; }
    .bar-card[data-key="stamina"]  { order: 2; }
    .bar-card[data-key="empower"]  { order: 3; }
    .bar-card[data-key="mana"]     { order: 4; }
    .bar-card[data-key="energy"]   { order: 5; }
    .bar-card[data-key="coalesce"] { order: 6; }
  }

  @media (min-width: 45rem) { /* 721px */
    .bar-card { order: initial; }
  }

  .bar-card{
    background: linear-gradient(180deg, rgba(100,100,100,0.03), rgba(200,200,200,0.07));
    border-radius:1.25rem; /* 20px */
    padding:0.625rem 0.75rem; /* 10px 12px */
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:1.25rem; /* 20px */
    box-shadow: 0 0.375rem 1.125rem rgba(0,0,0,0.6); /* 6px 18px */
    transition: transform .2s ease, box-shadow .25s ease;
    position: relative;
    overflow: hidden;
  }
  .bar-card:hover{ transform: translateY(-0.125rem); box-shadow: 0 1.25rem 1.875rem rgba(0,0,0,0.7); }

  .bar-left{
    display:flex;
    align-items:center;
    gap:0.875rem; /* 14px */
    min-width: 0;
    position: relative;
  }

  .bar-dot{
    width: 2.2rem; /* 35px */
    height: 2.2rem; /* 35px */
    border-radius:50%;
    box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.6), inset 0 -0.0625rem 0 rgba(255,255,255,0.05); /* 2px 6px */
    flex: 0 0 auto;
    position: relative;
  }
  .dot-life{ background: linear-gradient(180deg,#5fd08f,#2fb96b); }
  .dot-stamina{ background: linear-gradient(180deg,#6fb8ff,#2b74ff); }
  .dot-mana{ background: linear-gradient(180deg,#ffc46b,#ff9a2b); }
  .dot-energy{ background: linear-gradient(180deg,#6ff0ff,#13b6ff); }
  .dot-empower{ background: linear-gradient(180deg,#ff4d4d,#DC143C); }
  .dot-coalesce{ background: linear-gradient(180deg,#f5f7fa,#d9dde6); border:0.0625rem solid rgba(255,255,255,0.06); }

  /* ===== ICON OVERLAY SYSTEM ===== */
  
  .bar-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.85);
    width: 2.3rem; /* 37px */
    height: 2.3rem; /* 37px */
    opacity: 0;
    pointer-events: none;
    z-index: 10;
    filter: drop-shadow(0 0.25rem 0.5rem rgba(0, 0, 0, 0.3));
    
    will-change: opacity, transform;
    backface-visibility: hidden;
    
    transition: 
      opacity var(--fade-in-duration) var(--easing-smooth),
      transform var(--fade-in-duration) var(--easing-bounce);
  }

  .bar-icon.visible {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }

  .bar-icon.fading {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
    transition: 
      opacity var(--fade-out-duration) var(--easing-smooth),
      transform var(--fade-out-duration) var(--easing-smooth);
  }

  .bar-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    filter: drop-shadow(0 0.125rem 0.25rem rgba(0, 0, 0, 0.2));
    transition: filter var(--fade-in-duration) var(--easing-smooth);
  }

  .bar-card:hover .bar-icon img {
    filter: drop-shadow(0 0.25rem 0.5rem rgba(0, 0, 0, 0.3)) brightness(1.1);
  }

  .bar-label{ font-weight:600; font-size:1.38rem; color:#f1f5fb; white-space:nowrap; }
  .bar-controls{ display:flex; align-items:center; gap:0.1rem; padding-right: 0.125rem; }

  .bar-value{
    width:5rem; /* 80px */
    text-align:center;
    font-weight:700;
    font-size:1.10rem;
    color:#ffffff;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  }

  .btn {
    -webkit-appearance:none;
    appearance:none;
    border:0;
    background: rgba(255,255,255,0.09);
    color: #fff;
    padding:0.375rem 0.625rem; /* 6px 10px */
    border-radius:0.5rem; /* 8px */
    cursor:pointer;
    font-weight:700;
    transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
  }
  .btn:active{ transform: scale(.97); }
  .btn:focus{ outline:none; box-shadow:0 0 0 0.1875rem rgba(102,204,255,0.12); }
  .btn:disabled{ opacity: 0.3; cursor: not-allowed; }
  .btn:hover { background: #ff00ff; }
  .btn-icon:hover { background: rgba(255,255,255,0.11); }

  .btn-icon {
    padding: 0.125rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn-icon svg {
    width: 2rem;
    height: 2rem;
    color: white;
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .btn-icon:hover svg {
    transform: scale(1.10);
    color: #ff00ff;
  }

  .btn-icon:disabled svg {
    opacity: 0.6;
  }

  /* ========= SIMPLIFIED ATTRIBUTE PRESS-AND-HOLD STYLES ========= */
  
  .attributes{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(4.6rem, 1fr)); /* 120px */
    gap:1rem; /* 15px */
    margin-top:0.5rem; /* 20px */
    
    /* 2025 Performance Optimization: CSS Containment */
    contain: layout style;
  }
  
  /* 2025 Container Queries for Enhanced Responsiveness */
  @container (max-width: 48rem) {
    .attributes {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.875rem;
    }
  }
  
  @container (max-width: 32rem) {
    .attributes {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
  }

  .attr{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border-radius:0.75rem; /* 12px */
    padding:1rem; /* 16px */
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:0.5rem; /* 8px */
    cursor:pointer;
    transition: box-shadow .16s ease, border-color .16s ease;
    user-select:none;
    
    /* Professional touch target sizing */
    min-height: 1rem; /* 48px */
    min-width: 1rem;  /* 48px */
    
    touch-action: manipulation;
    
    position: relative;
    overflow: visible;
    
    /* 2025 Performance: GPU Acceleration for animations */
    will-change: transform, box-shadow;
    backface-visibility: hidden;
    transform-style: preserve-3d;
  }
  
  /* Hover state - desktop only (purple shadow) */
  .attr:hover:not(.mobile-only) {
    box-shadow: 0 0 0.75rem rgba(106, 27, 154, 0.6);
  }
  
  /* Press-and-hold visual states - progressive shadow animation */
  .attr.holding {
    /* Start with white shadow that grows and brightens during hold */
    box-shadow: 0 0 1rem rgba(255, 255, 255, 0.5);
    /* Progressive shadow animation during hold */
    animation: progressiveShadow var(--hold-duration) ease-out forwards;
  }
  
  /* Success flash animation - gold flash at completion */
  .attr.flash {
    animation: goldFlash 1.0s ease-out forwards;
  }

  .attr .attr-label{ 
    font-weight:700; 
    color:#f4f6fb; 
    white-space: nowrap;
    font-size: 0.8rem;
  }

  .attr .attr-val{ 
    font-weight:800; 
    font-size:1.05rem; 
    color:#eaeef8; 
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  }

  /* ========= CLOCK-STYLE PROGRESS RING ANIMATION ========= */
  
  .progress-ring {
    position: absolute;
    top: -0.25rem;
    left: -0.25rem;
    right: -0.25rem;
    bottom: -0.25rem;
    border-radius: 0.75rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.25s ease;
    /* 2025 Performance: Optimize SVG rendering */
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  .attr.holding .progress-ring {
    opacity: 1;
  }
  
  .progress-ring svg {
    width: 100%;
    height: 100%;
    border-radius: 0.75rem;
  }
  
  .progress-ring circle {
    fill: none;
    stroke-width: 0.25rem; /* 3px */
    stroke-linecap: round;
    transform-origin: center;
    /* Start at 12 o'clock position */
    transform: rotate(-90deg);
  }
  
  .progress-ring .progress-bg {
    stroke: var(--progress-bg);
  }
  
  .progress-ring .progress-bar {
    stroke: var(--progress-color);
    /* Will be set dynamically via JavaScript */
    stroke-dasharray: 251.327; /* Default - will be calculated */
    stroke-dashoffset: 251.327; /* Default - will be calculated */
    animation: none;
  }
  
  .attr.holding .progress-bar {
    animation: fillProgress var(--hold-duration) var(--hold-easing) forwards;
  }
  
  /* Clock-style animation: fills from 0° to 360° clockwise */
  @keyframes fillProgress {
    0% {
      stroke-dashoffset: var(--circumference, 251.327); /* Full circumference - no progress */
    }
    100% {
      stroke-dashoffset: 0; /* No offset - full circle filled */
    }
  }

  /* Progressive shadow during hold: white → larger/brighter white */
  @keyframes progressiveShadow {
    0% { box-shadow: 0 0 1rem rgba(255, 255, 255, 0.4); /* Starting white */ }
    50% { box-shadow: 0 0 1.5rem rgba(255, 255, 255, 0.7); /* Growing brighter */  }
    100% { box-shadow: 0 0 2rem rgba(255, 255, 255, 0.9); /* Largest and brightest */  }
  }
  
  /* Flash animation at completion: gold flash */
  @keyframes goldFlash {
    0% { box-shadow: 0 0 2rem rgba(255, 255, 255, 0.9); /* From bright white */ }
    50% { box-shadow: 0 0 2.5rem rgba(255, 215, 0, 1.0); /* Gold flash */ }
    100% { box-shadow: 0 0 1.5rem rgba(255, 215, 0, 0.6); /* Gold fade */ }
  }
  
  /* Apply the gold flash animation for completion */
  .pulse { animation: goldFlash 0.6s ease-out forwards; }

  .attr.luck{
    border: 0.0625rem solid var(--gold);
    box-shadow: 0 0.375rem 1.5rem rgba(212,175,55,0.12), inset 0 0.0625rem 0 rgba(255,255,255,0.03);
    /* 2025 Enhancement: Set gold colors for progress ring */
    --progress-color: var(--gold);
    --progress-bg: rgba(212, 175, 55, 0.2);
    --flash-color: var(--gold);
    /* 2025 Enhancement: Subtle gold shimmer effect */
    background: linear-gradient(135deg, rgba(212,175,55,0.05), rgba(212,175,55,0.02));
  }
  
  /* 2025 Enhancement: Special hover effect for luck */
  .attr.luck:hover:not(.cooling) {
    box-shadow: 0 0.5rem 2rem rgba(212,175,55,0.25), inset 0 0.0625rem 0 rgba(255,255,255,0.05);
    border-color: rgba(212,175,55,0.8);
  }
  .attr.luck.cooling{ 
    border: none; /* 2025 Fix: No border during cooldown */
    box-shadow: 0 0.375rem 1rem rgba(255, 255, 255, 0.15), inset 0 0.0625rem 0 rgba(255,255,255,0.02);
    /* 2025 Enhancement: Subtle white shadow during cooldown */
    background: linear-gradient(135deg, rgba(212,175,55,0.02), rgba(212,175,55,0.01));
  }
  .attr.luck.holding {
    border-color: var(--gold);
    /* 2025 Enhancement: Gold-themed progress with luxurious glow */
    box-shadow: 0 0 1.5rem rgba(212, 175, 55, 0.6);
    animation: progressiveShadowLuck var(--hold-duration) ease-out forwards;
  }
  
  /* 2025 Enhancement: Gold-themed progressive shadow animation for luck */
  @keyframes progressiveShadowLuck {
    0% { 
      box-shadow: 0 0 1.5rem rgba(212, 175, 55, 0.6);
      transform: scale(1.02);
    }
    50% { 
      box-shadow: 0 0 2rem rgba(212, 175, 55, 0.8);
      transform: scale(1.04);
    }
    100% { 
      box-shadow: 0 0 2.5rem rgba(212, 175, 55, 1.0);
      transform: scale(1.06);
    }
  }
  .attr.luck.flash {
    border-color: var(--gold);
    box-shadow: 0 0 1.35rem var(--gold);
  }
  .luck-timer {
  display: inline-block;
  width: 4ch; /* fixed width for '(30s)' */
  }

  .muted{ color: rgba(255,255,255,0.54); font-size:0.88rem; }
  .center{ text-align:center; }

  @media(max-width:28rem){ /* >440px */
    .bar-card{ padding:0.35rem; }
    .bar-controls{ padding-right: 0.5rem; }
    .attributes{ gap:1rem; margin-top:2rem; grid-template-columns: repeat(3, 1fr); }
      #playerName{ margin-top:2.0rem; margin-bottom:0.2rem; }
    .attr {
      min-height: 1rem;
      min-width: 1rem;
    }
    
    .attr .attr-label {
      font-size: 0.8rem;
    }
    
    .attr .attr-val {
      font-size: 1rem;
    }
  }

  /* Mobile-specific touch handling */
  @media (pointer: coarse) {
    .attr {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    
    .attr.mobile-only:hover {
      box-shadow: 0 0 0.5rem rgba(140, 50, 230, 0.6);
    }
  }

  #resetBtn {
    position: fixed;
    top: 0.6rem;
    left: 0.6rem;
    background: #1f1f1f;
    color: white;
    border: none;
    border-radius: 0.4rem;
    padding: 0.4rem 0.8rem;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    z-index: 1000;
    transition: background 0.25s;
  }
  #resetBtn:hover { background: #ff4d4d; }

  /* Heart Button - Top Right */
  #heartBtn {
    position: fixed;
    top: 0.6rem;
    right: 1.6rem;
    width: 3rem;
    height: 3rem;
    background: transparent;
    border: 0.1875rem solid white;
    border-radius: 0.5rem;
    cursor: pointer;
    z-index: 1001;
    transition: all 0.4s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  #heartBtn svg {
    width: 2rem;
    height: 2rem;
    fill: transparent;
    stroke: white;
    stroke-width: 2;
    transition: all 0.5s ease;
  }
  #heartBtn.active {
    background: var(--scarlet-pink);
    border-color: #333;
  }
  #heartBtn.active svg {
    fill: var(--scarlet-pink);
    stroke: #333;
  }
/*  #heartBtn:hover:not(.disabled) {
    transform: scale(1.05);
  }*/
  #heartBtn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Star Button - Left of Backpack */
  #starBtn {
    position: fixed;
    top: 0.6rem;
    right: 9.6rem; /* sits LEFT of inventory/backpack */
    width: 3rem;
    height: 3rem;
    background: transparent;
    border: 0.1875rem solid white;
    border-radius: 0.5rem;
    cursor: pointer;
    z-index: 1001;
    transition: all 0.4s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  #starBtn svg {
    width: 2rem;
    height: 2rem;
    fill: transparent;
    stroke: white;
    stroke-width: 2;
    transition: all 0.5s ease;
  }
  #starBtn.active {
    background: rgba(212, 175, 55, 0.3);
    border-color: #D4AF37;
  }
  #starBtn.active svg {
    fill: #FFD700;
    stroke: #D4AF37;
  }
  #starBtn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Mind Button - Purple themed */
  #mindBtn {
    position: fixed;
    top: 0.6rem;
    right: 13.6rem;
    width: 3rem;
    height: 3rem;
    background: transparent;
    border: 0.1875rem solid var(--mind-bright-purple);
    border-radius: 0.5rem;
    cursor: pointer;
    z-index: 1001;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  #mindBtn img {
    width: 2rem;
    height: 2rem;
    transition: all 0.5s ease;
    filter: brightness(1) saturate(0.8);
  }
  #mindBtn.active {
    background: var(--mind-dark-purple);
    border-color: var(--mind-border-active);
  }
  #mindBtn.active img {
    filter: brightness(1.4) saturate(1.2);
  }
  #mindBtn:hover:not(.active):not(.disabled) {
    border-color: #e0b8ff;
    box-shadow: 0 0 0.5rem rgba(212, 165, 255, 0.4);
  }
  #mindBtn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Mind Overlay */
  #mindOverlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 15, 18, 0.85);
    backdrop-filter: blur(0.5rem);
    -webkit-backdrop-filter: blur(0.5rem);
    z-index: 999;
    display: none;
    overflow-y: auto;
    padding: 3.75rem 1rem 1.25rem;
  }
  #mindOverlay.visible { display: block; }
  .mind-content { max-width: 50rem; margin: 0 auto; }
  .mind-title {
    text-align: center;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--mind-bright-purple);
  }
  .mind-capacity {
    text-align: center;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 1rem;
  }
  .mind-capacity .capacity-full { color: #ff6b6b; }
  .spell-slot {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 1rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
    position: relative;
  }
  .spell-slot.legendary {
    border: 0.125rem solid rgba(212, 175, 55, 0.3);
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(255, 255, 255, 0.02));
  }
  .spell-left-column {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: stretch;
  }
  .spell-image {
    width: 7.6rem;
    height: 10.6rem;
    min-width: 7.6rem;
    background: rgba(255, 255, 255, 0.05);
    border: 0.125rem dashed rgba(155, 89, 182, 0.3);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
  }
  .spell-image:hover {
    border-color: rgba(155, 89, 182, 0.6);
    background: rgba(155, 89, 182, 0.08);
  }
  .spell-image.has-image { border-style: solid; border-color: rgba(155, 89, 182, 0.2); }
  .spell-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 0.625rem; }
  .spell-image svg { width: 2rem; height: 2rem; stroke: rgba(155, 89, 182, 0.4); stroke-width: 2; fill: none; }
  .spell-info { flex: 1; display: flex; flex-direction: column; gap: 0.3rem; min-width: 0; }
  .spell-name { font-size: 1.1rem; font-weight: 700; color: #fff; background: transparent; border: none; outline: none; padding: 0.25rem 0; width: 100%; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; }
  .spell-name::placeholder { color: rgba(155, 89, 182, 0.5); }
  .spell-name.locked { color: var(--mind-bright-purple); pointer-events: none; }
  .spell-type { font-size: 1rem; color: var(--muted); padding-left: 0.25rem; }
  .spell-description { font-size: 1rem; color: rgba(255, 255, 255, 0.7); white-space: pre-line; line-height: 1.4; margin-top: 0.25rem; padding-left: 0.25rem; flex: 1; }
  .spell-confirm-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 1.5rem; height: 1.5rem; background: rgba(76, 175, 80, 0.2); border: 0.0625rem solid rgba(76, 175, 80, 0.5); border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; opacity: 0; pointer-events: none; }
  .spell-confirm-btn.visible { opacity: 1; pointer-events: auto; }
  .spell-confirm-btn:hover { background: rgba(76, 175, 80, 0.4); border-color: rgba(76, 175, 80, 0.8); }
  .spell-confirm-btn svg { width: 1rem; height: 1rem; stroke: #4caf50; stroke-width: 3; fill: none; }
  .spell-delete-btn { position: absolute; bottom: 0.5rem; right: 0.5rem; width: 1.5rem; height: 1.5rem; background: rgba(255, 0, 0, 0.25); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.2s ease; }
  .spell-slot:hover .spell-delete-btn { opacity: 1; }
  .spell-delete-btn:hover { background: rgba(255, 0, 0, 0.5); }
  .spell-delete-btn svg { width: 0.75rem; height: 0.75rem; stroke: white; stroke-width: 2; fill: none; }
  .spell-section-title { font-size: 1.1rem; font-weight: 600; color: var(--mind-bright-purple); margin: 1.5rem 0 0.75rem; padding-bottom: 0.5rem; border-bottom: 0.0625rem solid rgba(212, 165, 255, 0.2); }
  .spell-subtitle { font-size: 0.85rem; color: rgba(155, 89, 182, 0.7); font-style: italic; padding-left: 0.25rem; }
  .spell-footer { display: flex; align-items: center; margin-top: auto; padding-top: 0.5rem; gap: 0.5rem; }
  .spell-cost { display: flex; align-items: center; gap: 0.25rem; flex-wrap: wrap; }
  .cost-item { display: inline-flex; align-items: center; gap: 0.125rem; }
  .cost-icon { width: 1.25rem; height: 1.25rem; object-fit: contain; vertical-align: middle; }
  .desc-icon { width: 1rem; height: 1rem; object-fit: contain; vertical-align: middle; margin: 0 0.125rem; cursor: pointer; transition: transform 0.15s ease; }
  .desc-icon:hover { transform: scale(1.2); }
  .cost-amount { font-size: 0.9rem; font-weight: 600; color: var(--mind-bright-purple); margin-left: 0.125rem; }
  .cost-x, .cost-generic { background: rgba(155, 89, 182, 0.15); padding: 0.125rem 0.375rem; border-radius: 0.25rem; cursor: pointer; }
  .cost-x:hover, .cost-generic:hover { background: rgba(155, 89, 182, 0.3); }
  .spell-cast-btn { 
    width: 100%;
    padding: 0.5rem 1rem; 
    background: rgba(155, 89, 182, 0.3); 
    border: 0.0625rem solid var(--mind-bright-purple); 
    border-radius: 0.5rem; 
    color: #fff; 
    font-weight: 600; 
    font-size: 0.9rem; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    white-space: nowrap; 
  }
  .spell-cast-btn:hover:not(.disabled) { background: rgba(155, 89, 182, 0.5); transform: scale(1.05); }
  .spell-cast-btn.disabled { opacity: 0.4; cursor: not-allowed; background: rgba(100, 100, 100, 0.3); border-color: rgba(150, 150, 150, 0.3); }
  #addSpellBtn { width: 100%; padding: 1rem; background: rgba(155, 89, 182, 0.1); border: 0.125rem dashed rgba(155, 89, 182, 0.5); border-radius: 1rem; color: rgba(155, 89, 182, 0.9); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
  #addSpellBtn:hover { background: rgba(155, 89, 182, 0.15); border-color: rgba(155, 89, 182, 0.7); color: rgba(155, 89, 182, 1); transform: translateY(-1px); }
  #addSpellBtn:active { transform: translateY(0); }
  #addSpellBtn svg { width: 1.5rem; height: 1.5rem; stroke: currentColor; stroke-width: 2; fill: none; }

  /* Character Options Overlay */
  #characterOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 15, 18, 0.85);
    backdrop-filter: blur(0.5rem);
    -webkit-backdrop-filter: blur(0.5rem);
    z-index: 999;
    display: none;
    overflow-y: auto;
    padding: 3.75rem 1rem 1.25rem;
  }
  #characterOverlay.visible {
    display: block;
  }

  .character-content {
    max-width: 41.25rem;
    margin: 0 auto;
  }

  .character-title {
    text-align: center;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #FFD700;
  }

  .character-section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .character-section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 0.0625rem solid rgba(255, 255, 255, 0.1);
  }

  .character-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .character-option:hover {
    background: rgba(255, 255, 255, 0.06);
  }

  .character-option.selected {
    background: rgba(212, 175, 55, 0.15);
    border: 0.0625rem solid rgba(212, 175, 55, 0.4);
  }

  .character-option input[type="radio"] {
    accent-color: #FFD700;
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  .character-option label {
    flex: 1;
    cursor: pointer;
    color: #e9eef6;
    font-size: 1rem;
  }

  .character-desc {
    font-size: 0.85rem;
    color: var(--muted);
    margin-top: 0.25rem;
  }

  /* Traits Grid Layout */
  .traits-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .traits-row {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
    transition: all 0.4s ease;
  }

  .traits-row.disabled {
    opacity: 0.4;
    pointer-events: none;
    filter: grayscale(0.5);
  }

  .traits-row-title {
    width: 100%;
    text-align: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: #FFD700;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
  }

  .traits-option {
    background: rgba(255, 255, 255, 0.03);
    border: 0.125rem solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    padding: 0.75rem 1.25rem;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 6rem;
    text-align: center;
    font-size: 0.95rem;
    color: #e9eef6;
  }

  .traits-option:hover:not(.disabled) {
    background: rgba(212, 175, 55, 0.1);
    border-color: rgba(212, 175, 55, 0.4);
    transform: translateY(-0.125rem);
  }

  .traits-option.selected {
    background: rgba(212, 175, 55, 0.2);
    border-color: #FFD700;
    color: #FFD700;
    font-weight: 600;
  }

  .traits-option.disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .traits-lock-btn {
    display: block;
    margin: 1.5rem auto 0;
    padding: 0.875rem 2rem;
    background: rgba(212, 175, 55, 0.2);
    border: 0.125rem solid #FFD700;
    border-radius: 0.5rem;
    color: #FFD700;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .traits-lock-btn:hover {
    background: rgba(212, 175, 55, 0.4);
    transform: scale(1.05);
  }

  .traits-lock-btn:disabled {
    opacity: 0;
    pointer-events: none;
  }

  /* Traits Description */
  .traits-description {
    background: rgba(255, 255, 255, 0.03);
    border: 0.0625rem solid rgba(212, 175, 55, 0.3);
    border-radius: 1rem;
    padding: 1.5rem;
    line-height: 1.8;
    color: #e9eef6;
    font-size: 1rem;
  }

  .traits-description-name {
    color: #FFD700;
    font-weight: 600;
  }

#inventoryBtn {
  position: fixed;
  top: 0.6rem;
  right: 5.6rem; /* sits LEFT of heart */
  width: 3rem;
  height: 3rem;
  background: transparent;
  border: 0.1875rem solid white;
  border-radius: 0.5rem;
  cursor: pointer;
  z-index: 1001;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

#inventoryBtn svg {
  width: 2rem;
  height: 2rem;
  color: white;
  transition: all 0.5s ease;
}

#inventoryBtn.active {
  background: #8b5a2b; /* rich brown */
  border-color: #2b1a0e;
}

#inventoryBtn.active svg {
  color: #d2a679; /* brighter brown */
}

/*#inventoryBtn:hover {
  transform: scale(1.05);
}*/

  /* Relationship Overlay */
  #relationshipOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 15, 18, 0.85);
    backdrop-filter: blur(0.5rem);
    -webkit-backdrop-filter: blur(0.5rem);
    z-index: 999;
    display: none;
    overflow-y: auto;
    padding: 3.75rem 1rem 1.25rem;
  }
  #relationshipOverlay.visible {
    display: block;
  }

  .relationship-content {
    max-width: 41.25rem;
    margin: 0 auto;
  }

  .relationship-title {
    text-align: center;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #fff;
  }

  /* NPC Card */
  .npc-card {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 1rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
    position: relative;
  }

  .npc-image {
      width: 9.375rem;
      height: 9.375rem;
      min-width: 9.375rem;
      background: rgba(255, 255, 255, 0.05);
      border: 0.125rem dashed rgba(255, 255, 255, 0.2);
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      overflow: hidden;
  }

  .npc-image:hover {
    border-color: rgba(255, 255, 255, 0.4);
    background: rgba(255, 255, 255, 0.08);
  }
  
  .npc-image svg {
    width: 4rem;
    height: 4rem;
    stroke: rgba(255, 255, 255, 0.3);
    stroke-width: 2;
    fill: none;
  }
  
  .npc-image.has-image {
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.1);
  }
  
  .npc-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0.625rem;
      max-width: 20rem;
      max-height: 12.5rem;
      min-width: 9.375rem;
      min-height: 9.375rem;
  }

  /* NPC Info */
  .npc-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .npc-name-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .npc-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: #fff;
    background: transparent;
    border: none;
    outline: none;
    padding: 0.25rem 0;
    padding-left: 0.5rem;
    flex: 1;
  }
  .npc-name::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .name-confirm-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 1.5rem;
    height: 1.5rem;
    min-width: 1.5rem;
    background: rgba(76, 175, 80, 0.2);
    border: 0.0625rem solid rgba(76, 175, 80, 0.5);
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0;
    pointer-events: none;
  }
  .name-confirm-btn.visible {
    opacity: 1;
    pointer-events: auto;
  }
  .name-confirm-btn:hover {
    background: rgba(76, 175, 80, 0.4);
    border-color: rgba(76, 175, 80, 0.8);
  }
  .name-confirm-btn svg {
    width: 1rem;
    height: 1rem;
    stroke: #4caf50;
    stroke-width: 3;
    fill: none;
  }

  .npc-status {
    font-size: 1rem;
    color: var(--muted);
    background: transparent;
    border: none;
    outline: none;
    padding: 0.125rem 0;
    padding-left: 0.5rem;
    width: 100%;
  }
  .npc-status::placeholder {
    color: rgba(255, 255, 255, 0.3);
  }

  /* Hearts Container */
  .npc-hearts {
    display: flex;
    gap: 0.375rem;
    margin-top: auto;
    padding-top: 0.25rem;
    flex-wrap: wrap;
  }

  .heart-icon {
    width: 3.5rem;
    height: 3.5rem;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .heart-icon:hover:not(.locked) {
    transform: scale(1.1);
  }
  .heart-icon.locked {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .heart-icon svg {
    width: 100%;
    height: 100%;
    stroke-width: 2;
    transition: all 0.3s ease;
  }

  /* Heart states */
  .heart-icon.empty svg {
    fill: transparent;
    stroke: rgba(255, 255, 255, 0.3);
  }
  .heart-icon.filled-white svg {
    fill: var(--heart-white);
    stroke: var(--heart-white);
  }
  .heart-icon.filled-blue svg {
    fill: var(--heart-blue);
    stroke: var(--heart-blue);
  }
  .heart-icon.filled-purple svg {
    fill: var(--heart-purple);
    stroke: var(--heart-purple);
  }
  .heart-icon.filled-red svg {
    fill: var(--heart-red);
    stroke: var(--heart-red);
  }

  /* Heart number label inside heart */
  .heart-number {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.85rem;
    font-weight: 700;
    color: #333;
    pointer-events: none;
    user-select: none;
  }
  .heart-icon.empty .heart-number {
    color: rgba(255, 255, 255, 0.4);
  }

  /* Pulsing animation for heart 7 */
  @keyframes heartPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  .heart-icon.pulse-heart {
    animation: heartPulse 2s ease-in-out infinite;
  }

  /* Add NPC Button */
  .add-npc-btn {
    width: 100%;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 0.125rem dashed rgba(255, 255, 255, 0.25);
    border-radius: 1rem;
    color: rgba(255, 255, 255, 0.4);
    font-size: 3rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
  }
  .add-npc-btn:hover {
    background: rgba(255, 255, 255, 0.07);
    border-color: rgba(255, 255, 255, 0.5);
    color: rgba(255, 255, 255, 0.6);
  }
  .add-npc-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
  }
  .add-npc-btn svg {
    width: 2rem;
    height: 2rem;
    stroke: currentColor;
    stroke-width: 3;
    fill: none;
  }

  /* Delete NPC Button */
  .delete-npc-btn {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    width: 1.5rem;
    height: 1.5rem;
    background: rgba(255, 0, 0, 0.25);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
  }

  .npc-card:hover .delete-npc-btn {
    opacity: 1;
  }
  .delete-npc-btn:hover {
    background: rgba(255, 0, 0, 0.5);
  }
  .delete-npc-btn svg {
    width: 0.75rem;
    height: 0.75rem;
    stroke: white;
    stroke-width: 2;
    fill: none;
  }

  @media (max-width: 32rem) { /* 500px */
    .npc-card {
      flex-direction: column;
      align-items: center;
    }
    .npc-image {
      width: 9.375rem;
      height: 9.375rem;
      min-width: 9.375rem;
    }
    .npc-info {
      width: 100%;
      align-items: center;
      text-align: center;
    }
    .npc-name, .npc-status {
      text-align: center;
    }
    .npc-hearts {
      justify-content: center;
    }
  }

  @media (max-width: 40rem) { /* 640px */
    .npc-card {
      flex-direction: row;
      align-items: stretch;
      max-width: 25rem;
      padding: 0.25rem;
    }
    .npc-image {
      min-width: 9.375rem;
      width: 9.375rem;
      height: 9.375rem;
    }
    .npc-info {
      flex: 1;
      align-items: flex-start;
      padding-left: 0.5rem;
    }
    .npc-name {
      font-size: 1rem;
      text-align: left;
    }
    .npc-status {
      font-size: 0.85rem;
      text-align: left;
    }
    .npc-hearts {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.125rem;
      justify-content: flex-start;
      margin-top: 0.0625rem;
      padding-left: 0;
    }
    .heart-icon {
      width: 2.75rem;
      height: 2rem;
    }
    .heart-number {
      font-size: 0.7rem;
    }
    .heart-icon:nth-child(5) {
      grid-column: 1;
    }
    .heart-icon:nth-child(6) {
      grid-column: 2;
    }
    .heart-icon:nth-child(7) {
      grid-column: 3;
    }
    .name-confirm-btn {
      top: 0.375rem;
      right: 0.375rem;
    }
    .delete-npc-btn {
      bottom: 0.375rem;
      right: 0.375rem;
    }
  }

  #inventoryOverlay {
    position: fixed;
    inset: 0;
    background: rgba(15,15,18,0.85);
    backdrop-filter: blur(0.5rem);
    z-index: 999;
    display: none;
    padding: 3.75rem 1rem 1.25rem;
    overflow-y: auto;
  }

  #inventoryOverlay.visible {
    display: block;
  }

  .inventory-capacity {
    text-align: center;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 1rem;
  }
  
  .inventory-capacity .capacity-full {
    color: #ff6b6b;
  }

  .inventory-slot {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    background: rgba(255,255,255,0.04);
    border-radius: 0.75rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .inventory-slot input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 1rem;
    outline: none;
  }

  .inventory-slot .clear-btn {
    background: rgba(255,0,0,0.25);
    border: none;
    border-radius: 50%;
    width: 1.5rem;
    height: 1.5rem;
    cursor: pointer;
    color: white;
  }

.inventory-item img {
  object-fit: cover;
  border-radius: 0.5rem;
}

.inventory-item[data-slot="artefact"] img {
  width: 6rem;
  height: 6rem;
}

.inventory-item[data-slot="iris"] img {
  width: 5rem;
  height: 5rem;
}

.inventory-item[data-slot="item"] img {
  width: 7.6rem;
  height: 10.6rem;
  /* 2025 Enhancement: Maintain aspect ratio for item images (1218x1698) */
  object-fit: cover;
}

/* Ensure item inv-image container matches the new size */
.inventory-item[data-slot="item"] .inv-image {
  width: 7.6rem;
  height: 10.6rem;
}

/* Inventory cards - match NPC card layout */
.inventory-item {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 1rem;
  padding: 0.5rem;
  margin-bottom: 0.5rem;
  display: flex;
  gap: 0.5rem;
  align-items: stretch;
  position: relative;
}

.inventory-item .inv-image {
  width: 7.6rem;
  height: 10.6rem;
/*  aspect-ratio: 1218 / 1698;
  -webkit-aspect-ratio: 1218 / 1698;
  perspective: 1000px;
  -webkit-perspective: 1000px;*/
  min-width: 3.8rem;
  background: rgba(255, 255, 255, 0.05);
  border: 0.125rem dashed rgba(255, 255, 255, 0.2);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  overflow: hidden;
}

.inventory-item .inv-image:hover {
  border-color: rgba(255, 255, 255, 0.4);
  background: rgba(255, 255, 255, 0.08);
}

.inventory-item .inv-image.has-image {
  border-style: solid;
  border-color: rgba(255, 255, 255, 0.1);
}

.inventory-item .inv-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0.625rem;
}

.inventory-item .inv-image svg {
  width: 2rem;
  height: 2rem;
  stroke: rgba(255, 255, 255, 0.3);
  stroke-width: 2;
  fill: none;
}

/* Image Zoom Overlay */
#imageZoomOverlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 2rem;
}

#imageZoomOverlay.visible {
  display: flex;
}

#imageZoomOverlay img {
  max-height: calc(100vh - 4rem);
  max-width: 100%;
  object-fit: contain;
  border-radius: 0.5rem;
  box-shadow: 0 0 2rem rgba(0, 0, 0, 0.5);
  transition: transform 0.3s ease;
}

#imageZoomOverlay:hover img {
  transform: scale(1.02);
}

#imageZoomOverlay .zoom-hint {
  position: absolute;
  bottom: 1.5rem;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.9rem;
  pointer-events: none;
}

.inventory-item .inv-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  min-width: 0;
}

.inventory-item .inv-name {
  font-size: 1.1rem;
  font-weight: 700;
  color: #fff;
  background: transparent;
  border: none;
  outline: none;
  padding: 0.25rem 0;
  width: 100%;
}

.inventory-item .inv-name::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.inventory-item .inv-name.locked {
  color: var(--gold);
  pointer-events: none;
}

.inventory-item .inv-type {
  font-size: 1rem;
  color: var(--muted);
  padding-left: 0.25rem;
}

.inventory-item .inv-description {
  font-size: 1rem;
  color: rgba(255, 255, 255, 0.7);
  white-space: pre-line;
  line-height: 1.4;
  margin-top: 0.25rem;
  padding-left: 0.25rem;
  flex: 1;
}

.inventory-item .inv-confirm-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 1.5rem;
  height: 1.5rem;
  background: rgba(76, 175, 80, 0.2);
  border: 0.0625rem solid rgba(76, 175, 80, 0.5);
  border-radius: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  opacity: 0;
  pointer-events: none;
}

.inventory-item .inv-confirm-btn.visible {
  opacity: 1;
  pointer-events: auto;
}

.inventory-item .inv-confirm-btn:hover {
  background: rgba(76, 175, 80, 0.4);
  border-color: rgba(76, 175, 80, 0.8);
}

.inventory-item .inv-confirm-btn svg {
  width: 1rem;
  height: 1rem;
  stroke: #4caf50;
  stroke-width: 3;
  fill: none;
}

.inventory-item .inv-delete-btn {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  width: 1.5rem;
  height: 1.5rem;
  background: rgba(255, 0, 0, 0.25);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.2s ease;
}

.inventory-item:hover .inv-delete-btn {
  opacity: 1;
}

.inventory-item .inv-delete-btn:hover {
  background: rgba(255, 0, 0, 0.5);
}

.inventory-item .inv-delete-btn svg {
  width: 0.75rem;
  height: 0.75rem;
  stroke: white;
  stroke-width: 2;
  fill: none;
}


  /* Bottom Stats Bar */
  #bottomStats {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(18, 18, 18, 0.95);
    padding: 0.5rem 0.25rem;
    text-align: center;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    border-top: 0.0625rem solid rgba(255, 255, 255, 0.1);
    z-index: 1;
  }
  #bottomStats span {
    display: inline-block;
    margin: 0.0625rem 0.125rem;
    font-weight: bold;
    color: #fff;
  }
  #bottomStats .stat-label {
    color: #FFF;
    font-weight: 600;
  }

  #bottomStats .stat-value {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 5ch;
    padding: 0.125rem 1rem;
    box-sizing: border-box;
    border-radius: 0.25rem;
    border: 0.125rem solid rgba(230, 227, 200, 0.25);
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
  }

  /* ===== ACCESSIBILITY & PERFORMANCE ===== */

  /* Respect user's motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .bar-icon,
    .bar-card,
    .attr,
    .heart-icon,
    .btn {
      transition: none !important;
      animation: none !important;
    }
    
    .bar-icon {
      opacity: 1 !important;
      transform: translate(-50%, -50%) scale(1) !important;
    }
    
    .progress-ring .progress-bar {
      animation: none !important;
      stroke-dashoffset: 0 !important;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .bar-icon {
      filter: drop-shadow(0 0.125rem 0.25rem rgba(0, 0, 0, 0.8));
    }
    
    .progress-ring circle {
      stroke-width: 0.25rem;
    }
  }

  /* Focus management for accessibility */
  .bar-card:focus-within .bar-icon {
    /* Optionally show icon on keyboard focus */
  }

  /* ===== ATTRIBUTE ICONS ===== */
  .attr-value-wrap {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .attr-icon {
    width: 2rem;
    height: 2rem;
    padding: 0.0625rem;
    object-fit: contain;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    filter: drop-shadow(0 0.125rem 0.1875rem rgba(0,0,0,0.4));
    flex-shrink: 0;
  }

  /* 2025 Enhanced Focus Indicators for Accessibility */
  .attr:focus-visible {
    outline: 0.125rem solid var(--accent-purple);
    outline-offset: 0.125rem;
    /* Modern focus ring with better visual hierarchy */
    box-shadow: 0 0 0.75rem rgba(106, 27, 154, 0.6);
    /* Enhanced focus state with scale transform */
    transform: translateY(-0.125rem);
  }
  
  /* 2025 Enhancement: Special gold focus for luck attribute */
  .attr.luck:focus-visible {
    outline: 0.125rem solid var(--gold);
    outline-offset: 0.125rem;
    box-shadow: 0 0 0.75rem rgba(212, 175, 55, 0.6);
    transform: translateY(-0.125rem);
  }

  .attr:focus-visible .progress-ring {
    opacity: 1;
  }
  
  /* 2025 Modern Hover Enhancement */
  .attr:is(:hover, :focus-visible) {
    transform: translateY(-0.125rem);
    box-shadow: 0 0.75rem 1.5rem rgba(106, 27, 154, 0.4);
  }
  
  /* 2025 Enhancement: Special gold hover for luck */
  .attr.luck:is(:hover, :focus-visible) {
    transform: translateY(-0.125rem);
    box-shadow: 0 0.75rem 1.5rem rgba(212, 175, 55, 0.5);
  }
  
  /* 2025 Enhanced Press-and-Hold Animation */
  .attr.holding {
    animation: progressiveShadow var(--hold-duration) var(--hold-easing) forwards;
    /* Enhanced holding state with subtle scale */
    transform: scale(1.02);
  }
  
  /* Modern keyframe animation with improved easing */
  @keyframes progressiveShadow {
    0% { 
      box-shadow: 0 0 1rem rgba(255, 255, 255, 0.4);
      transform: scale(1.02);
    }
    50% { 
      box-shadow: 0 0 1.5rem rgba(255, 255, 255, 0.7);
      transform: scale(1.04);
    }
    100% { 
      box-shadow: 0 0 2rem rgba(255, 255, 255, 0.9);
      transform: scale(1.06);
    }
  }
<!-- Add this CSS to your existing styles -->
<style>
  /* Image Zoom System - Simplified */
  .spell-image {
    cursor: pointer;
    transition: transform 0.3s ease;
    position: relative;
    z-index: 1;
  }
  
  .spell-image:hover {
    transform: scale(1.03);
  }
  
  /* Zoom overlay */
  .image-zoom-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .image-zoom-overlay.visible {
    display: flex;
    animation: fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .image-zoom-content {
    position: relative;
    max-height: 90vh;
    max-width: 90vw;
    animation: zoomIn 0.3s ease;
  }
  
  @keyframes zoomIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  
  .image-zoom-content img {
    max-height: 90vh;
    max-width: 90vw;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
  }
  
  .zoom-close-btn {
    position: absolute;
    top: -40px;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }
  
  .zoom-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  .zoom-hint {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
    color: rgba(255, 255, 255, 0.6);
    font-size: 14px;
    pointer-events: none;
  }

  /* Choice cost styling */
  .cost-choice-group {
    display: inline-flex;
    align-items: center;
    background: rgba(255,255,255,0.08);
    padding: 2px 4px;
    border-radius: 4px;
    margin: 0 2px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .cost-icon.mini {
    width: 14px;
    height: 14px;
    background-size: contain;
    background-repeat: no-repeat;
  }
  .choice-slash {
    font-size: 0.7rem;
    color: var(--muted);
    margin: 0 1px;
    opacity: 0.6;
  }
</style>
</style>
</head>
<body>
  <button id="resetBtn">RESET</button>
  
  <!-- Star Button - Character Options -->
  <button id="starBtn" class="disabled" aria-label="Toggle Character Options">
    <svg viewBox="0 0 24 24">
      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
    </svg>
  </button>

  <!-- Mind Button - Spells -->
  <button id="mindBtn" class="disabled" aria-label="Toggle Mind/Spells">
    <img src="../icons/card-pickup.svg" alt="Mind" />
  </button>

  <!-- Mind Overlay -->
  <div id="mindOverlay">
    <div class="mind-content">
      <div class="mind-title">Mind & Spells</div>
      <div id="mindCapacity" class="mind-capacity"></div>
      <div id="spellList"></div>
      <button id="addSpellBtn">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Learn New Spell
      </button>
    </div>
  </div>

  <!-- Character Overlay -->
  <div id="characterOverlay">
    <div class="character-content">
      <div class="character-title" id="traitsTitle">Player's Traits</div>
      
      <!-- Traits Selection Grid -->
      <div class="traits-grid" id="traitsGrid">
        <!-- Innate Row -->
        <div class="traits-row" data-row="innate">
          <div class="traits-row-title">Innate</div>
          <div class="traits-option" data-row="innate" data-value="studious">Studious</div>
          <div class="traits-option" data-row="innate" data-value="insight">Insight</div>
          <div class="traits-option" data-row="innate" data-value="wayfinding">Wayfinding</div>
          <div class="traits-option" data-row="innate" data-value="revelry">Revelry</div>
        </div>
        
        <!-- Proficiency Row -->
        <div class="traits-row disabled" data-row="proficiency">
          <div class="traits-row-title">Proficiency</div>
          <div class="traits-option" data-row="proficiency" data-value="magicks">Magicks</div>
          <div class="traits-option" data-row="proficiency" data-value="weapons">Weapons</div>
          <div class="traits-option" data-row="proficiency" data-value="archery">Archery</div>
          <div class="traits-option" data-row="proficiency" data-value="hands">Hands</div>
        </div>
        
        <!-- Interest Row -->
        <div class="traits-row disabled" data-row="interest">
          <div class="traits-row-title">Interest</div>
          <div class="traits-option" data-row="interest" data-value="animalist">Animalist</div>
          <div class="traits-option" data-row="interest" data-value="naturalist">Naturalist</div>
          <div class="traits-option" data-row="interest" data-value="chemist">Chemist</div>
          <div class="traits-option" data-row="interest" data-value="avarist">Avarist</div>
        </div>
        
        <!-- Fear Row -->
        <div class="traits-row disabled" data-row="fear">
          <div class="traits-row-title">Fear</div>
          <div class="traits-option" data-row="fear" data-value="beasts">Beasts</div>
          <div class="traits-option" data-row="fear" data-value="insects">Insects</div>
          <div class="traits-option" data-row="fear" data-value="abominations">Abominations</div>
          <div class="traits-option" data-row="fear" data-value="spirits">Spirits</div>
        </div>
        
        <!-- Hate Row -->
        <div class="traits-row disabled" data-row="hate">
          <div class="traits-row-title">Hate</div>
          <div class="traits-option" data-row="hate" data-value="authority">Authority</div>
          <div class="traits-option" data-row="hate" data-value="aggression">Aggression</div>
          <div class="traits-option" data-row="hate" data-value="sickness">Sickness</div>
          <div class="traits-option" data-row="hate" data-value="religion">Religion</div>
        </div>
      </div>
      
      <!-- Lock Button -->
      <button class="traits-lock-btn" id="traitsLockBtn" disabled>Lock Choices?</button>
      
      <!-- Traits Description (hidden initially) -->
      <div class="traits-description" id="traitsDescription" style="display: none;"></div>
    </div>
  </div>

  <!-- Backpack Button -->
  <button id="inventoryBtn" aria-label="Toggle Inventory">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
   viewBox="0 0 512 512" xml:space="preserve">
<g>
  <path style="fill:#C8A27D;" d="M409.934,8.017h-34.205c-4.722,0-8.551,3.829-8.551,8.551v145.37h51.307V16.568
    C418.485,11.845,414.656,8.017,409.934,8.017z"/>
  <path style="fill:#C8A27D;" d="M136.297,8.017h-34.205c-4.722,0-8.551,3.829-8.551,8.551v145.37h51.307V16.568
    C144.848,11.845,141.019,8.017,136.297,8.017z"/>
</g>
<g>
  <path style="fill:#DCB991;" d="M119.169,161.937H93.541V16.568c0-4.722,3.829-8.551,8.551-8.551h17.077V161.937z"/>
  <path style="fill:#DCB991;" d="M418.485,161.937h-25.679V8.017h17.128c4.722,0,8.551,3.829,8.551,8.551V161.937z"/>
  <path style="fill:#DCB991;" d="M67.862,298.756c-9.445,0-17.102,7.656-17.102,17.102v136.818c0,9.445,7.658,17.102,17.102,17.102
    h17.102V298.756H67.862z"/>
</g>
<rect x="50.762" y="350.063" style="fill:#C8A27D;" width="34.205" height="25.653"/>
<path style="fill:#DCB991;" d="M444.112,298.756H427.01v171.023h17.102c9.445,0,17.102-7.658,17.102-17.102V315.858
  C461.215,306.412,453.557,298.756,444.112,298.756z"/>
<rect x="427.012" y="350.063" style="fill:#C8A27D;" width="34.205" height="25.653"/>
<path style="fill:#EBC9A0;" d="M392.831,503.983H119.194c-18.891,0-34.205-15.314-34.205-34.205V161.937
  c0-56.672,45.942-102.614,102.614-102.614h136.818c56.672,0,102.614,45.942,102.614,102.614v307.841
  C427.036,488.669,411.722,503.983,392.831,503.983z"/>
<path style="fill:#DCB991;" d="M401.382,94.222c-18.804-21.354-46.27-34.898-76.961-34.898H187.603
  c-30.689,0-58.154,13.544-76.959,34.897v67.717c0,61.297,49.868,111.165,111.165,111.165h68.409
  c61.297,0,111.165-49.868,111.165-111.165V94.222z"/>
<path style="fill:#F5DCB4;" d="M367.178,469.779h-222.33c-9.446,0-17.102-7.656-17.102-17.102V315.858
  c0-9.446,7.656-17.102,17.102-17.102h222.33c9.446,0,17.102,7.656,17.102,17.102v136.818
  C384.28,462.122,376.624,469.779,367.178,469.779z"/>
<path style="fill:#C8A27D;" d="M367.178,298.756h-222.33c-9.446,0-17.102,7.656-17.102,17.102v34.205H384.28v-34.205
  C384.28,306.412,376.624,298.756,367.178,298.756z"/>
<path style="fill:#F5DCB4;" d="M358.627,59.324H153.399c-9.445,0-17.102,7.656-17.102,17.102v85.511
  c0,47.227,38.285,85.511,85.511,85.511h68.409c47.227,0,85.512-38.285,85.512-85.511V76.426
  C375.729,66.98,368.071,59.324,358.627,59.324z"/>
<g>
  <path style="fill:#C8A27D;" d="M256.013,264.551L256.013,264.551c-9.446,0-17.102-7.656-17.102-17.102v-34.205h34.205v34.205
    C273.115,256.895,265.459,264.551,256.013,264.551z"/>
  <circle style="fill:#C8A27D;" cx="307.318" cy="392.818" r="17.102"/>
</g>
<path d="M367.165,290.739h-222.33c-13.851,0-25.119,11.268-25.119,25.119v136.818c0,13.851,11.268,25.119,25.119,25.119h222.33
  c13.851,0,25.119-11.268,25.119-25.119V315.858C392.284,302.007,381.016,290.739,367.165,290.739z M376.251,452.676
  c0,5.01-4.076,9.086-9.086,9.086h-222.33c-5.01,0-9.086-4.076-9.086-9.086V315.858c0-5.01,4.076-9.086,9.086-9.086h222.33
  c5.01,0,9.086,4.076,9.086,9.086V452.676z"/>
<path d="M350.063,342.046H161.937c-4.427,0-8.017,3.589-8.017,8.017c0,4.427,3.589,8.017,8.017,8.017H299.29v10.939
  c-9.93,3.354-17.102,12.752-17.102,23.8c0,13.851,11.268,25.119,25.119,25.119c13.851,0,25.119-11.268,25.119-25.119
  c0-11.048-7.172-20.446-17.102-23.8v-10.939h34.739c4.427,0,8.017-3.589,8.017-8.017
  C358.079,345.635,354.49,342.046,350.063,342.046z M307.307,401.904c-5.01,0-9.086-4.076-9.086-9.086s4.076-9.086,9.086-9.086
  s9.086,4.076,9.086,9.086S312.317,401.904,307.307,401.904z"/>
<path d="M444.125,290.739h-9.086V161.937c0-14.813-3.003-29.249-8.562-42.548c0.002-0.069,0.011-0.138,0.011-0.207V16.568
  C426.489,7.432,419.057,0,409.921,0h-34.205c-9.136,0-16.568,7.432-16.568,16.568v34.753c-0.178-0.003-0.355-0.014-0.534-0.014
  h-34.739V33.67c0-18.566-15.105-33.67-33.67-33.67h-68.409c-18.566,0-33.67,15.105-33.67,33.67v17.637h-34.739
  c-0.18,0-0.356,0.01-0.534,0.014V16.568C152.852,7.432,145.42,0,136.284,0h-34.205c-9.136,0-16.568,7.432-16.568,16.568v102.614
  c0,0.069,0.009,0.137,0.011,0.206c-5.559,13.299-8.562,27.736-8.562,42.549v128.802h-9.086c-13.851,0-25.119,11.268-25.119,25.119
  v136.818c0,13.851,11.268,25.119,25.119,25.119h9.858C81.49,497.255,98.642,512,119.182,512h273.637
  c20.54,0,37.691-14.745,41.448-34.205h9.858c13.851,0,25.119-11.268,25.119-25.119V315.858
  C469.244,302.007,457.976,290.739,444.125,290.739z M444.125,306.772c5.01,0,9.086,4.076,9.086,9.086v26.188H435.04v-35.273H444.125
  z M375.182,16.568c0-0.295,0.239-0.534,0.534-0.534h34.205c0.295,0,0.534,0.239,0.534,0.534v75.916
  c-7.859-9.76-17.405-18.24-28.351-24.946c-1.469-3.869-3.867-7.282-6.922-9.97V16.568z M204.159,33.67
  c0-9.725,7.912-17.637,17.637-17.637h68.409c9.725,0,17.637,7.912,17.637,17.637v17.637H204.159V33.67z M358.614,67.34
  c5.01,0,9.086,4.076,9.086,9.086v85.511c0,42.731-34.764,77.495-77.495,77.495h-9.086v-26.188c0-4.427-3.589-8.017-8.017-8.017
  h-34.205c-4.427,0-8.017,3.589-8.017,8.017v26.188h-9.086c-42.731,0-77.495-34.764-77.495-77.495V76.426
  c0-5.01,4.076-9.086,9.086-9.086H358.614z M265.086,247.438c0,0.003,0,0.006,0,0.011c0,0.002,0,0.003,0,0.005
  c-0.003,5.008-4.077,9.08-9.086,9.08c-5.01,0-9.086-4.076-9.086-9.086v-26.188h18.171V247.438z M101.545,16.568
  c0-0.295,0.239-0.534,0.534-0.534h34.205c0.295,0,0.534,0.239,0.534,0.534v41.001c-3.055,2.687-5.453,6.1-6.922,9.97
  c-10.947,6.706-20.493,15.186-28.351,24.946V16.568z M67.875,306.772h9.086v35.273H58.789v-26.188
  C58.789,310.848,62.865,306.772,67.875,306.772z M58.789,452.676v-94.597H76.96v103.683h-9.086
  C62.865,461.762,58.789,457.686,58.789,452.676z M392.818,495.967H119.182c-14.44,0-26.188-11.748-26.188-26.188V161.937
  c0-28.758,13.233-55.853,35.273-73.665v73.665c0,51.572,41.956,93.528,93.528,93.528H232.2c3.354,9.93,12.752,17.102,23.8,17.102
  c11.048,0,20.446-7.172,23.8-17.102h10.405c51.572,0,93.528-41.956,93.528-93.528V88.272c22.041,17.812,35.273,44.907,35.273,73.665
  v307.841C419.006,484.218,407.258,495.967,392.818,495.967z M444.125,461.762h-9.086V358.079h18.171v94.597
  C453.211,457.686,449.135,461.762,444.125,461.762z"/>
</svg>
  </button>

  <!-- Heart Button -->
  <button id="heartBtn" aria-label="Toggle Relationships">
    <svg viewBox="0 0 24 24">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
  </button>

  <!-- Relationship Overlay -->
  <div id="relationshipOverlay">
    <div class="relationship-content">
      <div class="relationship-title" id="relationshipTitle">Relationships</div>
      <div id="npcList"></div>
      <button class="add-npc-btn" id="addNpcBtn">
        <svg viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add Character
      </button>
    </div>
  </div>

  <!-- Backpack Overlay -->
<div id="inventoryOverlay">
  <div class="relationship-content">
    <div class="relationship-title">Inventory</div>
    <div id="inventoryCapacity" class="inventory-capacity"></div>
    <div id="inventoryList"></div>

    <button class="add-npc-btn" id="addInventoryItem">
      <svg viewBox="0 0 24 24">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      Add Item
    </button>
  </div>
  
  <!-- Image Zoom Overlay -->
  <div id="imageZoomOverlay">
    <img id="zoomedImage" src="" alt="Zoomed view" />
    <div class="zoom-hint">_</div>
  </div>
</div>

  <div class="wrap">
    <input id="playerName" placeholder="PLAYER" aria-label="Player name" />

    <div class="bars" id="bars"></div>

    <div class="attributes" id="attributes"></div>
  </div>
    <!-- Bottom spacer to provide breathing room for the last entry -->
    <div style="height: 3rem;"></div>
  <!-- Bottom Stats Bar -->
  <div id="bottomStats">
    <span class="stat-label">Level:</span><span class="stat-value" id="levelValue" style="background-color: rgba(106, 27, 154, 0.3)">1</span>
    <span class="stat-label">Tinge:</span><span class="stat-value" id="tingeValue" style="background: linear-gradient(180deg,#F5B727,#F57927)">0</span>
    <span class="stat-label">Arcane:</span><span class="stat-value" id="arcaneValue" style="background: linear-gradient(45deg,#27F5CC,#133bbb)">0</span>
  </div>

<script>
/* ========= MODERN TOUCH INTERACTION MANAGER ========= */

/**
 * Simplified Press-and-Hold Manager
 * Implements clean 2.5-second hold with progress ring and flash
 */
class SimpleTouchManager {
  constructor(options = {}) {
    this.config = {
      holdDuration: options.holdDuration || 2500, // 2.5 seconds
      moveThreshold: options.moveThreshold || 10,
      showProgress: options.showProgress !== false,
      hapticFeedback: options.hapticFeedback !== false,
      ...options
    };
    
    this.activeHolds = new Map();
    this.isTouchDevice = this.detectTouchDevice();
    
    this.handlePointerDown = this.handlePointerDown.bind(this);
    this.handlePointerMove = this.handlePointerMove.bind(this);
    this.handlePointerUp = this.handlePointerUp.bind(this);
    this.handlePointerCancel = this.handlePointerCancel.bind(this);
  }
  
  detectTouchDevice() {
    return (
      'ontouchstart' in window ||
      navigator.maxTouchPoints > 0 ||
      navigator.msMaxTouchPoints > 0
    );
  }
  
  attach(element, onActivate, options = {}) {
    const elementOptions = { ...this.config, ...options };
    
    element.setAttribute('role', 'button');
    element.setAttribute('aria-label', options.ariaLabel || 'Press and hold to activate');
    element.setAttribute('tabindex', '0');
    
    // Set custom colors if provided
    if (options.progressColor) {
      element.style.setProperty('--progress-color', options.progressColor);
      element.style.setProperty('--progress-bg', options.progressColor + '33'); // Add transparency
    }
    if (options.flashColor) {
      element.style.setProperty('--flash-color', options.flashColor);
    }
    
    element.addEventListener('contextmenu', (e) => e.preventDefault());
    
    element.addEventListener('pointerdown', (e) => this.handlePointerDown(e, element, onActivate, elementOptions));
    element.addEventListener('pointermove', (e) => this.handlePointerMove(e, element));
    element.addEventListener('pointerup', (e) => this.handlePointerUp(e, element));
    element.addEventListener('pointercancel', (e) => this.handlePointerCancel(e, element));
    element.addEventListener('pointerleave', (e) => this.handlePointerCancel(e, element));
    
    element.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Enter') {
        e.preventDefault();
        this.simulateHold(element, onActivate, elementOptions);
      }
    });
    
    // Removed click-based activation - stats only increase when hold completes
    // This prevents premature stat increases on desktop clicks
    
    // Desktop users can use keyboard: Space or Enter keys to activate
    
    if (this.isTouchDevice) {
      element.classList.add('mobile-only');
    }
  }
  
  handlePointerDown(e, element, onActivate, options) {
    if (!this.isTouchDevice && e.pointerType !== 'mouse') return;
    
    e.preventDefault();
    
    const startX = e.clientX;
    const startY = e.clientY;
    const startTime = Date.now();
    
    if (options.showProgress) {
      this.createProgressRing(element);
    }
    
    element.classList.add('holding');
    
    const holdState = {
      timer: null,
      startX,
      startY,
      startTime,
      element,
      onActivate,
      options
    };
    
    this.activeHolds.set(element, holdState);
    
    holdState.timer = setTimeout(() => {
      this.completeHold(element, holdState);
    }, options.holdDuration);
    
    if (options.hapticFeedback && 'vibrate' in navigator) {
      navigator.vibrate(50);
    }
  }
  
  handlePointerMove(e, element) {
    const holdState = this.activeHolds.get(element);
    if (!holdState) return;
    
    const deltaX = Math.abs(e.clientX - holdState.startX);
    const deltaY = Math.abs(e.clientY - holdState.startY);
    
    if (deltaX > this.config.moveThreshold || deltaY > this.config.moveThreshold) {
      this.cancelHold(element, holdState);
    }
  }
  
  handlePointerUp(e, element) {
    const holdState = this.activeHolds.get(element);
    if (!holdState) return;
    
    const duration = Date.now() - holdState.startTime;
    
    if (duration >= holdState.options.holdDuration) {
      element.setAttribute('data-hold-activated', 'true');
    }
    
    this.cancelHold(element, holdState);
  }
  
  handlePointerCancel(e, element) {
    const holdState = this.activeHolds.get(element);
    if (!holdState) return;
    
    this.cancelHold(element, holdState);
  }
  
  completeHold(element, holdState) {
    if (holdState.options.hapticFeedback && 'vibrate' in navigator) {
      navigator.vibrate([100, 50, 100]);
    }
    
    element.classList.remove('holding');
    element.classList.add('flash');
    
    holdState.onActivate();
    
    setTimeout(() => {
      element.classList.remove('flash');
    }, 400); /* Match the goldFlash animation duration */
    
    this.activeHolds.delete(element);
  }
  
  cancelHold(element, holdState) {
    clearTimeout(holdState.timer);
    element.classList.remove('holding');
    this.removeProgressRing(element);
    this.activeHolds.delete(element);
  }
  
  simulateHold(element, onActivate, options) {
    element.classList.add('holding');
    
    if (options.showProgress) {
      this.createProgressRing(element);
    }
    
    setTimeout(() => {
      element.classList.remove('holding');
      element.classList.add('flash');
      onActivate();
      
      setTimeout(() => {
        element.classList.remove('flash');
      }, 400); /* Match the goldFlash animation duration */
    }, options.holdDuration);
  }
  
  createProgressRing(element) {
    if (element.querySelector('.progress-ring')) return;
    
    const progressRing = document.createElement('div');
    progressRing.className = 'progress-ring';
    
    // Fixed dimensions for consistent circular progress
    const radius = 42;
    const circumference = 2 * Math.PI * radius;
    
    // Get colors from CSS variables or use defaults
    const progressColor = getComputedStyle(element).getPropertyValue('--progress-color').trim() || '#ffffff';
    const progressBg = getComputedStyle(element).getPropertyValue('--progress-bg').trim() || 'rgba(255, 255, 255, 0.2)';
    
    progressRing.innerHTML = `
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle class="progress-bg" cx="50" cy="50" r="${radius}" stroke="${progressBg}"/>
        <circle class="progress-bar" cx="50" cy="50" r="${radius}" 
                stroke="${progressColor}"
                stroke-dasharray="${circumference} ${circumference}" 
                stroke-dashoffset="${circumference}"/>
      </svg>
    `;
    
    element.appendChild(progressRing);
    
    // Set CSS custom property for animation
    const progressBar = progressRing.querySelector('.progress-bar');
    progressBar.style.setProperty('--circumference', circumference);
  }
  
  removeProgressRing(element) {
    const progressRing = element.querySelector('.progress-ring');
    if (progressRing) {
      progressRing.remove();
    }
  }
}

/* ========= touchscreen misclick prevention ========= */
const touchManager = new SimpleTouchManager({
  holdDuration: 2600,
  showProgress: true,
  hapticFeedback: true,
  moveThreshold: 10
});

/* ========= SVG buttons ========= */
const minusSVG = `
<svg viewBox="0 0 24 24" aria-hidden="true">
  <path opacity="0.5"
        d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447
           C4.92893 2 7.28595 2 12 2
           C16.714 2 19.0711 2 20.5355 3.46447
           C22 4.92893 22 7.28595 22 12
           C22 16.714 22 19.0711 20.5355 20.5355
           C19.0711 22 16.714 22 12 22
           C7.28595 22 4.92893 22 3.46447 20.5355
           C2 19.0711 2 16.714 2 12Z"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"/>
  <path d="M15 12H9"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"/>
</svg>
`;

const plusSVG = `
<svg viewBox="0 0 24 24" aria-hidden="true">
  <path opacity="0.5"
        d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447
           C4.92893 2 7.28595 2 12 2
           C16.714 2 19.0711 2 20.5355 3.46447
           C22 4.92893 22 7.28595 22 12
           C22 16.714 22 19.0711 20.5355 20.5355
           C19.0711 22 16.714 22 12 22
           C7.28595 22 4.92893 22 3.46447 20.5355
           C2 19.0711 2 16.714 2 12Z"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"/>
  <path d="M12 9V15M9 12H15"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"/>
</svg>
`;

/* ========= Persistence helpers ========= */
function saveState(key,value){ try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){} }
function loadState(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; } }

/* ========= Bottom Stats Calculations ========= */
function calculateLevel() {
  const endurance = Number(loadState('Endurance', 0)) || 0;
  const skill = Number(loadState('Skill', 0)) || 0;
  const strength = Number(loadState('Strength', 0)) || 0;
  const mastery = Number(loadState('Mastery', 0)) || 0;
  const potency = Number(loadState('Potency', 0)) || 0;
  
  return 1 + endurance + skill + strength + mastery + potency;
}

function calculateTinge() {
  const potency = Number(loadState('Potency', 0)) || 0;
  const currentMana = Number(loadState('mana', 0)) || 0;
  
  console.log('Tinge calc - Potency:', potency, 'Current Mana:', currentMana, 'Total:', potency + currentMana);
  return potency + currentMana;
}

function calculateArcane() {
  const mastery = Number(loadState('Mastery', 0)) || 0;
  const currentEnergy = Number(loadState('energy', 0)) || 0;
  
  console.log('Arcane calc - Mastery:', mastery, 'Current Energy:', currentEnergy, 'Total:', mastery + currentEnergy);
  return mastery + currentEnergy;
}

function updateBottomStats() {
  const level = calculateLevel();
  const tinge = calculateTinge();
  const arcane = calculateArcane();
  
  console.log('Bottom Stats Update - Level:', level, 'Tinge:', tinge, 'Arcane:', arcane);
  document.getElementById('levelValue').textContent = level;
  document.getElementById('tingeValue').textContent = tinge;
  document.getElementById('arcaneValue').textContent = arcane;
}

/* ========= Stat Bonus Tables ========= */
const enduranceBonuses = [
  null,
  { life: 2, stamina: 1, mana: 0, energy: 0 },
  { life: 2, stamina: 1, mana: 0, energy: 0 },
  { life: 2, stamina: 1, mana: 0, energy: 0 },
  { life: 2, stamina: 1, mana: 0, energy: 0 },
  { life: 2, stamina: 1, mana: 0, energy: 0 },
  { life: 2, stamina: 1, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
];

const skillBonuses = [
  null,
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 1, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 0, stamina: 0, mana: 0, energy: 0 },
  { life: 0, stamina: 0, mana: 0, energy: 0 },
  { life: 0, stamina: 0, mana: 0, energy: 0 },
];

const strengthBonuses = [
  null,
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 1, stamina: 1, mana: 0, energy: 0 },
  { life: 1, stamina: 0, mana: 0, energy: 0 },
  { life: 0, stamina: 0, mana: 0, energy: 0 },
  { life: 0, stamina: 0, mana: 0, energy: 0 },
  { life: 0, stamina: 0, mana: 0, energy: 0 },
];

const potencyBonuses = [
  null,
  { life: 0, stamina: 0, mana: 3, energy: 0 },
  { life: 0, stamina: 0, mana: 2, energy: 1 },
  { life: 0, stamina: 0, mana: 3, energy: 0 },
  { life: 0, stamina: 0, mana: 2, energy: 1 },
  { life: 0, stamina: 0, mana: 3, energy: 0 },
  { life: 0, stamina: 0, mana: 3, energy: 0 },
  { life: 0, stamina: 0, mana: 2, energy: 0 },
  { life: 0, stamina: 0, mana: 2, energy: 0 },
  { life: 0, stamina: 0, mana: 3, energy: 0 },
];

const masteryBonuses = [
  null,
  { life: 0, stamina: 0, mana: 1, energy: 2 },
  { life: 0, stamina: 0, mana: 0, energy: 3 },
  { life: 0, stamina: 0, mana: 1, energy: 3 },
  { life: 0, stamina: 0, mana: 0, energy: 3 },
  { life: 0, stamina: 0, mana: 1, energy: 2 },
  { life: 0, stamina: 0, mana: 0, energy: 3 },
  { life: 0, stamina: 0, mana: 0, energy: 2 },
  { life: 0, stamina: 0, mana: 1, energy: 2 },
  { life: 0, stamina: 0, mana: 0, energy: 2 },
];

/* ========= Calculate Maximum Limits ========= */
function calculateLimits() {
  const limits = {
    life: 3,
    stamina: 1,
    mana: 3,
    energy: 2
  };

  const endurance = Number(loadState('Endurance', 0)) || 0;
  const skill = Number(loadState('Skill', 0)) || 0;
  const strength = Number(loadState('Strength', 0)) || 0;
  const potency = Number(loadState('Potency', 0)) || 0;
  const mastery = Number(loadState('Mastery', 0)) || 0;

  function sumBonuses(bonusTable, rank) {
    let total = { life: 0, stamina: 0, mana: 0, energy: 0 };
    for (let i = 1; i <= rank && i < bonusTable.length; i++) {
      if (bonusTable[i]) {
        total.life += bonusTable[i].life;
        total.stamina += bonusTable[i].stamina;
        total.mana += bonusTable[i].mana;
        total.energy += bonusTable[i].energy;
      }
    }
    return total;
  }

  const endBonus = sumBonuses(enduranceBonuses, endurance);
  const skillBonus = sumBonuses(skillBonuses, skill);
  const strBonus = sumBonuses(strengthBonuses, strength);
  const potBonus = sumBonuses(potencyBonuses, potency);
  const mastBonus = sumBonuses(masteryBonuses, mastery);

  limits.life += endBonus.life + skillBonus.life + strBonus.life + potBonus.life + mastBonus.life;
  limits.stamina += endBonus.stamina + skillBonus.stamina + strBonus.stamina + potBonus.stamina + mastBonus.stamina;
  limits.mana += endBonus.mana + skillBonus.mana + strBonus.mana + potBonus.mana + mastBonus.mana;
  limits.energy += endBonus.energy + skillBonus.energy + strBonus.energy + potBonus.energy + mastBonus.energy;

  return limits;
}

/* ========= Bar Update Registry ========= */
const barUpdateFunctions = {};

/* ========= Bars config with min/max ranges and defaults ========= */
const barsConfig = [
  { key:'life', label:'Life', dotClass:'dot-life', min: -10, max: 30, default: 1, dynamic: true },
  { key:'mana', label:'Mana', dotClass:'dot-mana', min: -1, max: 30, default: 0, dynamic: true },
  { key:'stamina', label:'Stamina', dotClass:'dot-stamina', min: -3, max: 9, default: 0, dynamic: true },
  { key:'energy', label:'Energy', dotClass:'dot-energy', min: -1, max: 30, default: 0, dynamic: true },
  { key:'empower', label:'Empower', dotClass:'dot-empower', min: 0, max: 12, default: 0, dynamic: false },
  { key:'coalesce', label:'Coalesce', dotClass:'dot-coalesce', min: 0, max: 12, default: 3, dynamic: false }
];

const barsContainer = document.getElementById('bars');

/* ========= ICON MANAGEMENT SYSTEM ========= */

function createBarIcon(barKey, barLabel) {
  const iconContainer = document.createElement('div');
  iconContainer.className = `bar-icon bar-icon--${barKey}`;
  iconContainer.setAttribute('role', 'img');
  iconContainer.setAttribute('aria-label', `${barLabel} icon`);
  
  const img = document.createElement('img');
  img.alt = `${barLabel} icon`;
  img.decoding = 'async';
  img.loading = 'lazy';
  
  const iconPaths = {
    life: '../icons/life1.png',
    mana: '../icons/mana1.png',
    stamina: '../icons/stamina1.png',
    energy: '../icons/energy1.png',
    empower: '../icons/empower1.png',
    coalesce: '../icons/crys.svg'
  };
  
  img.src = iconPaths[barKey] || iconPaths.life;
  iconContainer.appendChild(img);
  
  return iconContainer;
}

class IconAnimationManager {
  constructor() {
    this.activeAnimations = new Map();
    this.animationConfig = {
      fadeInDuration: 300,
      lingerDuration: 3000,
      fadeOutDuration: 2000
    };
  }

  showIcon(iconElement) {
    this.clearAnimation(iconElement);
    
    iconElement.classList.add('visible');
    iconElement.classList.remove('fading');
    
    const timer = setTimeout(() => {
      this.fadeOutIcon(iconElement);
    }, this.animationConfig.lingerDuration);
    
    this.activeAnimations.set(iconElement, timer);
  }

  fadeOutIcon(iconElement) {
    this.clearAnimation(iconElement);
    
    iconElement.classList.add('fading');
    
    setTimeout(() => {
      iconElement.classList.remove('visible', 'fading');
      this.activeAnimations.delete(iconElement);
    }, this.animationConfig.fadeOutDuration);
  }

  clearAnimation(iconElement) {
    const timer = this.activeAnimations.get(iconElement);
    if (timer) {
      clearTimeout(timer);
      this.activeAnimations.delete(iconElement);
    }
  }

  handleBarHover(barCard, isHovering) {
    const icon = barCard.querySelector('.bar-icon');
    if (!icon) return;

    if (isHovering) {
      this.showIcon(icon);
    } else {
      this.clearAnimation(icon);
      icon.classList.remove('visible', 'fading');
    }
  }

  cleanup() {
    this.activeAnimations.forEach((timer) => clearTimeout(timer));
    this.activeAnimations.clear();
  }
}

const iconManager = new IconAnimationManager();

barsConfig.forEach(cfg => {
  let value = Number(loadState(cfg.key, cfg.default));
  value = Math.max(cfg.min, Math.min(cfg.max, value));
  console.log('Bar loaded - Key:', cfg.key, 'Value:', value, 'Default:', cfg.default);
  
  const card = document.createElement('div');
  card.className = 'bar-card';
  card.dataset.key = cfg.key;
  card.setAttribute('tabindex', '0');

  const left = document.createElement('div'); left.className='bar-left';
  const dot = document.createElement('div'); dot.className = 'bar-dot ' + cfg.dotClass;
  const label = document.createElement('div'); label.className='bar-label'; label.textContent = cfg.label;

  left.appendChild(dot);
  left.appendChild(label);

  const icon = createBarIcon(cfg.key, cfg.label);
  dot.appendChild(icon);

  const controls = document.createElement('div'); controls.className='bar-controls';

  const valSpan = document.createElement('div'); valSpan.className='bar-value';
  const minus = document.createElement('button');
  minus.className = 'btn btn-icon';
  minus.innerHTML = minusSVG;
  minus.setAttribute('aria-label', 'Decrease');

  const plus = document.createElement('button');
  plus.className = 'btn btn-icon';
  plus.innerHTML = plusSVG;
  plus.setAttribute('aria-label', 'Increase');

  function getCurrentMax() {
    if (cfg.dynamic) {
      const limits = calculateLimits();
      return limits[cfg.key];
    }
    return cfg.max;
  }

  function updateDisplay() {
    if (cfg.dynamic) {
      const currentMax = getCurrentMax();
      valSpan.textContent = `${value} / ${currentMax}`;
    } else {
      valSpan.textContent = String(value);
    }
  }

  function updateButtonStates() {
    const currentMax = getCurrentMax();
    minus.disabled = (value <= cfg.min);
    plus.disabled = (value >= currentMax);
  }

  function updateBar() {
    // Reload value from state in case it was changed externally (e.g., by spell casting)
    value = Number(loadState(cfg.key, cfg.default));
    value = Math.max(cfg.min, Math.min(getCurrentMax(), value));
    
    const currentMax = getCurrentMax();
    if (value > currentMax) {
      value = currentMax;
      saveState(cfg.key, value);
    }
    updateDisplay();
    updateButtonStates();
  }

  // NEW CODE - Register update function for ALL bars
    barUpdateFunctions[cfg.key] = () => {
      updateBar();
      // Update bottom stats if relevant bars change
      if (cfg.key === 'mana' || cfg.key === 'energy') {
        updateBottomStats();
      }
    };

  minus.addEventListener('click', ()=> {
    const newValue = value - 1;
    if (newValue >= cfg.min) {
      value = newValue;
      updateDisplay();
      saveState(cfg.key, value);
      console.log('Bar decreased - Key:', cfg.key, 'New Value:', value);
      updateButtonStates();
      
      if (cfg.key === 'mana' || cfg.key === 'energy') {
        updateBottomStats();
      }
      
      flashElement(card);
    }
  });
  
  plus.addEventListener('click', ()=> {
    const currentMax = getCurrentMax();
    const newValue = value + 1;
    if (newValue <= currentMax) {
      value = newValue;
      updateDisplay();
      saveState(cfg.key, value);
      console.log('Bar increased - Key:', cfg.key, 'New Value:', value);
      updateButtonStates();
      
      if (cfg.key === 'mana' || cfg.key === 'energy') {
        updateBottomStats();
      }
      
      flashElement(card);
    }
  });

  updateDisplay();
  updateButtonStates();

  controls.appendChild(minus);
  controls.appendChild(valSpan);
  controls.appendChild(plus);

  card.appendChild(left);
  card.appendChild(controls);

  card.addEventListener('mouseenter', () => iconManager.handleBarHover(card, true));
  card.addEventListener('mouseleave', () => iconManager.handleBarHover(card, false));
  
  card.addEventListener('focus', () => iconManager.handleBarHover(card, true));
  card.addEventListener('blur', () => iconManager.handleBarHover(card, false));

  barsContainer.appendChild(card);
});

function updateAllBars() {
  // This iterates over every registered update function and runs it
  Object.values(barUpdateFunctions).forEach(updateFn => updateFn());
}

function flashElement(el){
  el.style.transition = 'box-shadow .18s ease, transform .12s ease';
  el.style.transform = 'translateY(-0.125rem)';
  el.style.boxShadow = '0 0.875rem 2.25rem rgba(0,0,0,0.55)';
  setTimeout(()=>{ el.style.transform=''; el.style.boxShadow=''; }, 160);
}

/* ===== ATTRIBUTE ICON MAP ===== */
const STAT_ICONS = {
  Endurance: '../icons/heart-shield.png',
  Skill: '../icons/skl.png',
  Strength: '../icons/str.png',
  Potency: '../icons/potency8.png',
  Mastery: '../icons/mastery4.png'
};

/* ========= Attributes (including Luck) ========= */
const attrConfig = ["Endurance","Potency","Mastery","Strength","Skill","Luck"];
const attrsContainer = document.getElementById('attributes');

const limitAffectingAttrs = ["Endurance", "Skill", "Strength", "Potency", "Mastery"];

attrConfig.forEach(name => {
  let stored = loadState(name, name==='Luck' ? null : 0);
  if(name!=='Luck') stored = Number(stored) || 0;

  const card = document.createElement('div');
  card.className = 'attr';
  card.dataset.name = name;
  
  /* 2025 Accessibility Enhancement: ARIA Labels */
  card.setAttribute('role', 'button');
  card.setAttribute('aria-label', `${name === 'Luck' ? 'Press and hold to activate luck' : 'Press and hold to level up'}`);
  card.setAttribute('tabindex', '0');

  const label = document.createElement('div');
  label.className = 'attr-label';
  label.textContent = name;

  const valWrap = document.createElement('div');
  valWrap.className = 'attr-value-wrap';

  const icon = document.createElement('img');
  icon.className = 'attr-icon';

  if (STAT_ICONS[name]) {
    icon.src = STAT_ICONS[name];
    icon.alt = `${name} icon`;
  } else {
    icon.style.display = 'none';
  }

  const val = document.createElement('span');
  val.className = 'attr-val';
  val.textContent = (name === 'Luck' ? '--' : stored);

  valWrap.appendChild(icon);
  valWrap.appendChild(val);

  card.appendChild(label);
  card.appendChild(valWrap);
  attrsContainer.appendChild(card);

    if(name === 'Luck'){
card.classList.add('luck');

let luckValue = loadState('Luck', null);
let showing = Boolean(loadState('luckShowing', false));
let lastLuck = loadState('luckLast', null);
let cooldownUntil = loadState('luckCooldownUntil', null);
let timerId = null;
let expired = false; // ✅ FIX #1

function formatLuck(n){ return (n>=0 ? '+'+n : String(n)); }

function getRemainingSec(){
  if(!cooldownUntil) return 0;
  const rem = Math.ceil((cooldownUntil - Date.now())/1000);
  return rem > 0 ? rem : 0;
}

function updateLuckDisplay(){
  const rem = getRemainingSec();

  if (showing && rem > 0) {
    label.innerHTML = 'Luck <span class="luck-timer"></span>';
    label.querySelector('.luck-timer').textContent = `(${rem}s)`;
    val.textContent = formatLuck(luckValue);
    card.classList.add('cooling');
    expired = false;
  }
  else if (showing && expired) {
    label.innerHTML = 'Luck <span class="luck-timer"></span>';

    val.textContent = formatLuck(luckValue);
    card.classList.remove('cooling');
  }
  else {
    label.innerHTML = 'Luck <span class="luck-timer"></span>';

    val.textContent = '--';
    card.classList.remove('cooling');
  }
}

function startCooldown(seconds){
  cooldownUntil = Date.now() + seconds*1000;
  saveState('luckCooldownUntil', cooldownUntil);

  if(timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    if(getRemainingSec() <= 0){
      clearInterval(timerId);
      timerId = null;
      cooldownUntil = null;
      saveState('luckCooldownUntil', null);
      expired = true;
      updateLuckDisplay();
    } else {
      updateLuckDisplay();
    }
  }, 1000);
}

function rollLuckWeighted(){
  const options = [
    {value:-2, weight:10},
    {value:-1,  weight:10},
    {value:1,  weight:23},
    {value:2,  weight:23},
    {value:3,  weight:23},
    {value:4,  weight:10},
    {value:10, weight:1}
  ];
  const total = options.reduce((s,o)=>s+o.weight,0);
  let r = Math.random()*total;
  for(const o of options){
    if(r < o.weight) return o.value;
    r -= o.weight;
  }
  return options[options.length-1].value;
}

function pickNewLuck(){
  let newVal;
  do { newVal = rollLuckWeighted(); }
  while(newVal === lastLuck);
  lastLuck = newVal;
  saveState('luckLast', lastLuck);
  return newVal;
}

function activateLuck(){
  const rem = getRemainingSec();

  // STATE 2: cooling
  if(rem > 0) return;

  // STATE 3: expired → reset
  if(showing && expired){
    showing = false;
    expired = false;
    luckValue = null;
    saveState('luckShowing', false);
    saveState('Luck', null);
    updateLuckDisplay();
    return;
  }

  // STATE 1: ready → roll
  luckValue = pickNewLuck();
  saveState('Luck', luckValue);
  showing = true;
  expired = false;
  saveState('luckShowing', true);
  updateLuckDisplay();

  card.classList.add('flash');
  setTimeout(()=>card.classList.remove('flash'),400);

  startCooldown(99);
}

card.setAttribute('tabindex','0');

// 2025 Enhancement: Use same press-and-hold mechanism as other attributes
const activateLuckWithHold = () => {
  activateLuck();
};

// Apply touch handling to luck with press-and-hold animation
touchManager.attach(card, activateLuckWithHold, {
  ariaLabel: 'Luck attribute - Press and hold to activate',
  role: 'button'
});

updateLuckDisplay();

    } else {
    let valNum = stored;
    let lockout = false;

    function incrementAttribute() {
      if (lockout) return;
      valNum = (valNum + 1) % 10;
      val.textContent = String(valNum);
      saveState(name, valNum);

      if (limitAffectingAttrs.includes(name)) {
        updateAllBars();
        updateBottomStats();
      }

      card.classList.add('pulse');
      setTimeout(()=> card.classList.remove('pulse'), 420);

      lockout = true;
      setTimeout(()=> { lockout = false; }, 3000);
    }

    // Apply touch handling to regular attributes with 2025 enhancements
    touchManager.attach(card, incrementAttribute, {
      ariaLabel: `${name} attribute - Press and hold to level up`,
      role: 'button'
    });
  }
});

/* ========= Player name persistence and Enter handling ========= */
const playerNameInput = document.getElementById('playerName');
const existingName = loadState('playerName', '');
if(existingName) playerNameInput.value = existingName;
playerNameInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const nm = playerNameInput.value.trim();
    saveState('playerName', nm);
    playerNameInput.blur();
  }
});
playerNameInput.addEventListener('blur', ()=>{
  const nm = playerNameInput.value.trim();
  saveState('playerName', nm);
});

/* Reset button */
document.getElementById("resetBtn").onclick = () => {
  if (confirm("Are you sure you want to RESET ALL DATA?")) {
    localStorage.clear();
    location.reload();
  }
};

/* ========= Relationship System ========= */
const heartBtn = document.getElementById('heartBtn');
const relationshipOverlay = document.getElementById('relationshipOverlay');
const npcList = document.getElementById('npcList');
const addNpcBtn = document.getElementById('addNpcBtn');
const relationshipTitle = document.getElementById('relationshipTitle');

function updateRelationshipTitle() {
  const name = playerNameInput.value.trim() || 'Player';
  relationshipTitle.textContent = `${name}'s Relationships`;
}

updateRelationshipTitle();

let isRelationshipOpen = false;

function hasPlayerName() {
  return playerNameInput.value.trim().length > 0;
}

function updateHeartButtonState() {
  if (hasPlayerName()) {
    heartBtn.classList.remove('disabled');
  } else {
    heartBtn.classList.add('disabled');
  }
}

heartBtn.addEventListener('click', () => {
  if (!hasPlayerName()) {
    alert('Please enter a player name first!');
    return;
  }
  
  isRelationshipOpen = !isRelationshipOpen;
  if (isRelationshipOpen) {
    relationshipOverlay.classList.add('visible');
    heartBtn.classList.add('active');
    updateRelationshipTitle();
  } else {
    relationshipOverlay.classList.remove('visible');
    heartBtn.classList.remove('active');
  }
});

playerNameInput.addEventListener('input', () => {
  updateHeartButtonState();
  updateRelationshipTitle();
  updateStarButtonState();
  updateTraitsTitle();
});
updateHeartButtonState();

/* ========= Character Options System ========= */
const starBtn = document.getElementById('starBtn');
const characterOverlay = document.getElementById('characterOverlay');

let characterOpen = false;

// Load saved character options (new traits system)
let characterOptions = loadState('characterOptions', {
  innate: '',
  proficiency: '',
  interest: '',
  fear: '',
  hate: '',
  locked: false
});

function hasPlayerName() {
  return playerNameInput.value.trim().length > 0;
}

function updateStarButtonState() {
  if (hasPlayerName()) {
    starBtn.classList.remove('disabled');
  } else {
    starBtn.classList.add('disabled');
  }
}

// Traits System
const traitsOrder = ['innate', 'proficiency', 'interest', 'fear', 'hate'];
const traitsLockBtn = document.getElementById('traitsLockBtn');
const traitsGrid = document.getElementById('traitsGrid');
const traitsDescription = document.getElementById('traitsDescription');
const traitsTitle = document.getElementById('traitsTitle');

const traitsDescriptions = {
  // Innate
  studious: {
    name: 'Studious',
    desc: (name) => `${name} is a studious scholar, and spells are always revealed when picking new ones. When at a camp, regain one additional energy.`
  },
  insight: {
    name: 'Insightful',
    desc: (name) => `${name} possesses keen insight, able to perceive possible solutions to puzzles. When at a camp, you may progress some quests.`
  },
  wayfinding: {
    name: 'Wayfinding',
    desc: (name) => `${name} has an uncanny sense of direction, and can show one hidden map card once per day. When at a camp, you may briefly visit a town or village before resting at camp.`
  },
  revelry: {
    name: 'Revelry',
    desc: (name) => `${name} finds joy in celebration and the pleasures of life, gain benefits from celebratory substances and all relationships start at 2 hearts. When at camp, you may briefly visit a Stormcrow Tavern before resting at camp.`
  },
  // Proficiency
  magicks: {
    name: 'Magicks',
    desc: (name) => `Proficient with magicks, ${name} may request specific subtypes of cards be provided when picking spells.`
  },
  weapons: {
    name: 'Weapons',
    desc: (name) => `Trained with weapons, ${name} may critically strike once per cycle on any successful hit.`
  },
  archery: {
    name: 'Archery',
    desc: (name) => `A skilled archer, ${name} never misses their mark: on a miss, deal reduced damage instead.`
  },
  hands: {
    name: 'Hands',
    desc: (name) => `${name} is handy with... hands! When ${name} possesses no combat equipment: capable of sleight of hand and close-quarters-combat, counter non-weapon melee attacks; all unarmed melee strikes gain swift.`
  },
  // Interest
  animalist: {
    name: 'Animalist',
    desc: (name) => `With an affinity for animals, ${name} is a walking bestiary and begins with a buddy. If this buddy's life is ever zero, set it to 1 instead and stun the buddy for the remainder of the cycle.`
  },
  naturalist: {
    name: 'Naturalist',
    desc: (name) => `A devoted naturalist, ${name} can forage at camps and recover additional stats. ${name} succeeds any camp challenges.`
  },
  chemist: {
    name: 'Chemist',
    desc: (name) => `A self-proclaimed chemist, ${name} occasionally avoids negative effects from imbibing. As negotiator, ${name} can offer drinks to increase interest or patience.`
  },
  avarist: {
    name: 'Avarist',
    desc: (name) => `Driven by avarice, ${name} seeks to maximize their wealth, occasionally striking deals with merchants. If ${name} is responsible for a change in fame or infamy, gain one coin.`
  },
  // Fear
  beasts: {
    name: 'Beasts',
    desc: (name) => `${name} becomes terrified in the presence of beasts and ferocious creatures. (Gain dread and panic.)`
  },
  insects: {
    name: 'Insects',
    desc: (name) => `Crippled by fear of insects, ${name} panics at the sight of creepy crawlies. (Gain panic.)`
  },
  abominations: {
    name: 'Abominations',
    desc: (name) => `${name} is disgusted by the sight of monsters, abominations, and the unnatural horrors of the world. (Lose stamina at the start of your turn.)`
  },
  spirits: {
    name: 'Spirits',
    desc: (name) => `${name} becomes terrified in the presence of ghosts, spirits, apparitions, and other spooky phenomenon. (Gain dread and panic.)`
  },
  // Hate
  authority: {
    name: 'Authority',
    desc: (name) => `${name} despises authority, and feels compelled to resist any form of structured power. (During relevent situations, resolve to prevent self from outbursts or madness.)`
  },
  aggression: {
    name: 'Aggression',
    desc: (name) => `${name} cannot cope with any form of aggression, becoming enraged or shutting down completely. (During relevent situations, resolve to prevent self from outbursts or madness.)`
  },
  sickness: {
    name: 'Sickness',
    desc: (name) => `${name} has an intense aversion to sickness and disease, always maintaining meticulous hygiene no matter the situation. (During relevent situations, lose stamina at the start of your turn.)`
  },
  religion: {
    name: 'Religion',
    desc: (name) => `${name} despises religion, and feels compelled to act out when encountering religious things. (During relevent situations, gain madness or lose stamina to prevent self from outbursts.)`
  }
};

function updateTraitsTitle() {
  const name = playerNameInput.value.trim() || 'Player';
  traitsTitle.textContent = `${name}'s Traits`;
}

function generateTraitsDescription() {
  const name = playerNameInput.value.trim() || 'Player';
  let description = '';
  
  // Generate description for each selected trait
  traitsOrder.forEach(row => {
    const value = characterOptions[row];
    if (value && traitsDescriptions[value]) {
      const traitDesc = traitsDescriptions[value].desc(name);
      description += traitDesc + ' ';
    }
  });
  
  return description.trim();
}

function checkAllTraitsSelected() {
  return traitsOrder.every(row => characterOptions[row] && characterOptions[row] !== '');
}

function updateTraitsLockButton() {
  if (checkAllTraitsSelected()) {
    traitsLockBtn.disabled = false;
  } else {
    traitsLockBtn.disabled = true;
  }
}

function enableNextRow(completedRow) {
  const rowIndex = traitsOrder.indexOf(completedRow);
  if (rowIndex >= 0 && rowIndex < traitsOrder.length - 1) {
    const nextRow = traitsOrder[rowIndex + 1];
    const nextRowElement = document.querySelector(`.traits-row[data-row="${nextRow}"]`);
    if (nextRowElement) {
      nextRowElement.classList.remove('disabled');
    }
  }
}

function applyTraitsSelection() {
  traitsOrder.forEach(row => {
    const value = characterOptions[row];
    
    // Enable rows up to the current selection
    const rowIndex = traitsOrder.indexOf(row);
    if (rowIndex === 0 || (rowIndex > 0 && characterOptions[traitsOrder[rowIndex - 1]])) {
      const rowElement = document.querySelector(`.traits-row[data-row="${row}"]`);
      if (rowElement) {
        rowElement.classList.remove('disabled');
      }
    }
    
    // Mark selected option
    if (value) {
      const optionElement = document.querySelector(`.traits-option[data-row="${row}"][data-value="${value}"]`);
      if (optionElement) {
        optionElement.classList.add('selected');
      }
    }
  });
  
  updateTraitsLockButton();
}

// Close overlay when clicking outside content
characterOverlay.addEventListener('click', (e) => {
  if (e.target === characterOverlay) {
    characterOpen = false;
    characterOverlay.classList.remove('visible');
    starBtn.classList.remove('active');
  }
});

// Traits option selection
document.querySelectorAll('.traits-option').forEach(option => {
  option.addEventListener('click', () => {
    if (option.classList.contains('disabled')) return;
    
    const row = option.dataset.row;
    const value = option.dataset.value;
    
    // Update state
    characterOptions[row] = value;
    saveState('characterOptions', characterOptions);
    
    // Update UI - clear previous selection in this row and select new one
    document.querySelectorAll(`.traits-option[data-row="${row}"]`).forEach(opt => {
      opt.classList.remove('selected');
    });
    option.classList.add('selected');
    
    // Enable next row
    enableNextRow(row);
    
    // Check if all traits are selected
    updateTraitsLockButton();
  });
});

// Lock choices button
traitsLockBtn.addEventListener('click', () => {
  const description = generateTraitsDescription();
  
  // Save locked state
  characterOptions.locked = true;
  saveState('characterOptions', characterOptions);
  
  // Hide grid and lock button
  traitsGrid.style.display = 'none';
  traitsLockBtn.style.display = 'none';
  
  // Show description
  traitsDescription.innerHTML = description;
  traitsDescription.style.display = 'block';
});

// Check if traits are already locked and show description
function checkTraitsLocked() {
  if (characterOptions.locked) {
    traitsGrid.style.display = 'none';
    traitsLockBtn.style.display = 'none';
    traitsDescription.innerHTML = generateTraitsDescription();
    traitsDescription.style.display = 'block';
  } else {
    traitsGrid.style.display = 'flex';
    traitsLockBtn.style.display = 'block';
    traitsDescription.style.display = 'none';
  }
}

// Update starBtn click handler to check locked state
starBtn.addEventListener('click', () => {
  if (!hasPlayerName()) {
    alert('Please enter a player name first!');
    return;
  }
  
  characterOpen = !characterOpen;
  if (characterOpen) {
    characterOverlay.classList.add('visible');
    starBtn.classList.add('active');
    updateTraitsTitle();
    checkTraitsLocked();
  } else {
    characterOverlay.classList.remove('visible');
    starBtn.classList.remove('active');
  }
});

// Initialize traits display
applyTraitsSelection();
updateStarButtonState();
checkTraitsLocked();

const heartPath = 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z';

let npcs = loadState('npcs', []);

function saveNpcs() {
  saveState('npcs', npcs);
}

function getRelationshipStatus(hearts, npcName) {
  let filledCount = 0;
  for (let i = 0; i < hearts.length; i++) {
    if (hearts[i] === 1) {
      filledCount++;
    } else {
      break;
    }
  }

  if (npcName === "Naya" && filledCount === 7) {
    return "Best Friend";
  }

  const statusMap = {
    0: 'No Relationship',
    1: 'Familiar',
    2: 'Friendly',
    3: 'Friends',
    4: 'Accomplice',
    5: 'Companion',
    6: 'Partner',
    7: 'Lover'
  };
  
  return statusMap[filledCount] || 'No Relationship';
}

function updateNpcStatus(npcIndex) {
  if (npcs[npcIndex]) {
    npcs[npcIndex].status = getRelationshipStatus(
    npcs[npcIndex].hearts,
    npcs[npcIndex].name
    );
  }
}

const officialNpcImages = {
  "Hitomi":           "hearts/000.webp",
  "Tsubasa":          "hearts/001.webp",
  "Tress Bien":       "hearts/002.webp",
  "Dante Alimor":     "hearts/003.webp",
  "Evelynn":          "hearts/004.webp",
  "Flare vey Byornn": "hearts/005.webp",
  "Guy":              "hearts/006.webp",
  "Hector Havel":     "hearts/007.webp",
  "Jiu-lin Fan":      "hearts/008.webp",
  "Shang Tian":       "hearts/009.webp",
  "Marco":            "hearts/010.webp",
  "Lumiere":          "hearts/011.webp",
  "Anjali":           "hearts/012.webp",
  "Chinara Ekine":    "hearts/013.webp",
  "Ohm":              "hearts/014.webp",
  "Jon Quixote":      "hearts/015.webp",
  "Naya":             "hearts/016.webp",
  "Million Redgate":  "hearts/017.webp",
  "Captain Thiffany": "hearts/018.webp",
  "The Courier":      "hearts/019.webp",
  "Kleo Petra":       "hearts/030.webp",
  "Paarthi Lomedi":   "hearts/035.webp",
  "Qing Xi":          "hearts/036.webp",
  "Reeve S Basilisk": "hearts/037.webp",
  "Vincent Pererez":  "hearts/038.webp",
  "Taeonora 9C":      "hearts/039.webp"
}

function createNpcCard(npc, index) {
  const card = document.createElement('div');
  card.className = 'npc-card';
  card.dataset.index = index;

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'delete-npc-btn';
  deleteBtn.innerHTML = '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
  deleteBtn.addEventListener('click', () => {
    if (confirm('Delete this character?')) {
      if (npcs[index]) {
        npcs[index].official = false;
      }
      npcs.splice(index, 1);

      saveNpcs();
      renderNpcs();
      updateAddButtonVisibility();
    }
  });

  const imageDiv = document.createElement('div');
  imageDiv.className = 'npc-image' + (npc.image ? ' has-image' : '');
  
  if (npc.image) {
    const img = document.createElement('img');
    img.src = npc.image;
    imageDiv.appendChild(img);
  } else {
    imageDiv.innerHTML = '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
  }
  
  imageDiv.style.cursor = 'pointer'; // Indicate it's clickable for upload

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';
  
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }
      
      if (file.size > 6 * 2160 * 2160) {
        alert('Image file size must be less than 5MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        npcs[index].image = event.target.result;
        saveNpcs();
        renderNpcs();
      };
      reader.readAsDataURL(file);
    }
  });

  imageDiv.addEventListener('click', (e) => {
    // Allow upload only
    if (npcs[index].official) {
      alert("This is an official character. Their portrait cannot be changed.");
      return;
    }
    if (!npcs[index].name || npcs[index].name.trim().length === 0) {
      alert("Please enter a name before selecting an image.");
      return;
    }
    fileInput.click();
  });

  const infoDiv = document.createElement('div');
  infoDiv.className = 'npc-info';

  const nameInput = document.createElement('input');
  nameInput.className = 'npc-name';
  nameInput.placeholder = 'Character Name';
  nameInput.value = npc.name || '';
  const nameRow = document.createElement('div');
  nameRow.className = 'npc-name-row';

  const confirmBtn = document.createElement('button');
  confirmBtn.className = 'name-confirm-btn';
  confirmBtn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
  confirmBtn.title = 'Save name';

  function saveName() {
    const oldName = npcs[index].name || '';
    const newName = nameInput.value.trim();

    npcs[index].name = newName;

    if (oldName.length === 0 && newName.length > 0) {
      npcs[index].hearts[0] = 1;
    } else if (newName.length === 0) {
      npcs[index].hearts = [0,0,0,0,0,0,0];
      npcs[index].image = null;
    }

    // 2025 Enhancement: Case-insensitive NPC name matching
    const findOfficialNpc = (searchName) => {
      const searchLower = searchName.toLowerCase();
      for (const [npcName, imagePath] of Object.entries(officialNpcImages)) {
        if (npcName.toLowerCase() === searchLower) {
          return { name: npcName, image: imagePath };
        }
      }
      return null;
    };
    
    const foundNpc = findOfficialNpc(newName);
    if (foundNpc) {
      npcs[index].image = foundNpc.image;
      npcs[index].official = true;
    } else {
      if (!npcs[index].official) {
        // Leave existing custom image unchanged
      }
      npcs[index].official = false;
    }

    updateNpcStatus(index);
    saveNpcs();
    renderNpcs();
  }

  nameInput.addEventListener('input', () => {
    const currentValue = nameInput.value.trim();
    const savedName = npcs[index].name || '';
    
    if (currentValue !== savedName && currentValue.length > 0) {
      confirmBtn.classList.add('visible');
    } else {
      confirmBtn.classList.remove('visible');
    }
  });

  nameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveName();
      nameInput.blur();
    }
  });

  confirmBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    saveName();
  });

  nameRow.appendChild(nameInput);
  nameRow.appendChild(confirmBtn);

  const statusInput = document.createElement('div');
  statusInput.className = 'npc-status';
  statusInput.textContent = npc.status || 'No Relationship';

  const heartsDiv = document.createElement('div');
  heartsDiv.className = 'npc-hearts';

  if (!npc.hearts || npc.hearts.length !== 7) {
    npc.hearts = [0, 0, 0, 0, 0, 0, 0];
  }

  const hasName = npc.name && npc.name.trim().length > 0;
  if (hasName && npc.hearts[0] === 0) {
    npc.hearts[0] = 1;
    updateNpcStatus(index);
    saveNpcs();
  }

  if (!npc.status) {
    updateNpcStatus(index);
    saveNpcs();
  }

  for (let i = 0; i < 7; i++) {
    const heartIcon = document.createElement('div');
    heartIcon.className = 'heart-icon';
    heartIcon.dataset.heartIndex = i;
    
    const heartLevel = npc.hearts[i];
    
    if (heartLevel === 0) {
      heartIcon.classList.add('empty');
    } else {
      if (i === 0) {
        heartIcon.classList.add('filled-white');
      } else if (i >= 1 && i <= 2) {
        heartIcon.classList.add('filled-blue');
      } else if (i >= 3 && i <= 4) {
        heartIcon.classList.add('filled-purple');
      } else if (i >= 5 && i <= 6) {
        heartIcon.classList.add('filled-red');
      }
    }

    if (i === 6 && heartLevel === 1) {
      heartIcon.classList.add('pulse-heart');
    }

    const isLocked = !hasName || (i > 0 && npc.hearts[i - 1] === 0);
    if (isLocked) {
      heartIcon.classList.add('locked');
    }

    heartIcon.innerHTML = `<svg viewBox="0 0 24 24"><path d="${heartPath}"/></svg><div class="heart-number">${i + 1}</div>`;

    heartIcon.addEventListener('click', () => {
      if (!hasName) {
        alert('Please enter a character name first!');
        return;
      }

      if (i === 0) {
        return;
      }

      if (i > 0 && npc.hearts[i - 1] === 0) {
        return;
      }

      npcs[index].hearts[i] = npcs[index].hearts[i] === 0 ? 1 : 0;
      
      if (npcs[index].hearts[i] === 0) {
        for (let j = i + 1; j < 7; j++) {
          npcs[index].hearts[j] = 0;
        }
      }
      
      updateNpcStatus(index);
      
      saveNpcs();
      renderNpcs();
    });

    heartsDiv.appendChild(heartIcon);
  }

  infoDiv.appendChild(nameRow);
  infoDiv.appendChild(statusInput);
  infoDiv.appendChild(heartsDiv);

  card.appendChild(deleteBtn);
  card.appendChild(imageDiv);
  card.appendChild(fileInput);
  card.appendChild(infoDiv);

  return card;
}

function renderNpcs() {
  npcList.innerHTML = '';
  npcs.forEach((npc, index) => {
    npcList.appendChild(createNpcCard(npc, index));
  });
  updateAddButtonVisibility();
}

addNpcBtn.addEventListener('click', () => {
  if (npcs.length >= 3) {
    alert('Maximum of 3 characters allowed');
    return;
  }
  npcs.push({
    name: '',
    status: 'No Relationship',
    image: null,
    hearts: [0, 0, 0, 0, 0, 0, 0]
  });
  saveNpcs();
  renderNpcs();
  updateAddButtonVisibility();
});

function updateAddButtonVisibility() {
  if (npcs.length >= 3) {
    addNpcBtn.style.display = 'none';
  } else {
    addNpcBtn.style.display = 'flex';
  }
}

renderNpcs();
updateAddButtonVisibility();

updateBottomStats();

window.addEventListener('beforeunload', () => {
  iconManager.cleanup();
});

const artefacts = [
  "The Darkflame","The Wintergrace","The Bronze Ring of Smiles","The Wand",
  "The Pair and a Half","The Trickblade","The Fisherman's Flask",
  "Scathe's Memo Book","The Prismatic Glasses","The Coin"
];

const irises = [
  "Steady Sky Blue","Bravely Bold Gold","Radiant Emerald Green","Softly Strange Violet",
  "Feverspin Crimson","Amberbright Hazel","Honeydark Smoulder","Silver Slivers",
  "Otherworldly Odd","Absolute Cloying Dark"
];

const inventoryOverlay = document.getElementById('inventoryOverlay');
const inventoryBtn = document.getElementById('inventoryBtn');
const inventoryList = document.getElementById('inventoryList');
const addItemBtn = document.getElementById('addItemBtn');

let inventoryOpen = false;
let inventory = loadState('inventory', []);

function renderInventory() {
  inventoryList.innerHTML = '';
  inventory.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'inventory-slot';

    const input = document.createElement('input');
    input.value = item || '';
    input.placeholder =
      i === 0 ? 'Soulbound Artefact' :
      i === 1 ? 'Iris' : 'Item';

    input.onblur = () => {
      inventory[i] = input.value.trim();
      saveState('inventory', inventory);
    };

    const clear = document.createElement('button');
    clear.className = 'clear-btn';
    clear.textContent = '×';
    clear.onclick = () => {
      inventory[i] = '';
      saveState('inventory', inventory);
      renderInventory();
    };

    row.append(input, clear);
    inventoryList.appendChild(row);
  });
}

inventoryBtn.onclick = () => {
  inventoryOpen = !inventoryOpen;
  inventoryOverlay.classList.toggle('visible', inventoryOpen);
  inventoryBtn.classList.toggle('active', inventoryOpen);
  renderInventory();
};

const addInventoryBtn = document.getElementById('addInventoryItem');

// 2025 Fix: Only enable "Add Item" when ALL existing slots are populated
function updateAddItemButtonState() {
  const maxSlots = Math.min(getMaxItemSlots(), 20);
  const currentCount = getCurrentItemCount();
  const totalSlots = getTotalItemSlots();
  const allSlotsPopulated = areAllSlotsPopulated();
  
  const canAddSlot = allSlotsPopulated && totalSlots < maxSlots && totalSlots < 20;
  
  // Update button state
  addInventoryBtn.disabled = !canAddSlot;
  addInventoryBtn.classList.toggle('disabled', !canAddSlot);
  
  // Update button text and tooltip
  if (!allSlotsPopulated) {
    addInventoryBtn.textContent = 'Fill Item Slots First';
    addInventoryBtn.title = `Fill all ${totalSlots} slot${totalSlots !== 1 ? 's' : ''} before adding more`;
  } else if (totalSlots >= maxSlots) {
    addInventoryBtn.textContent = 'Capacity Full';
    addInventoryBtn.title = `Maximum capacity reached (${maxSlots} slots). Level up Endurance to carry more.`;
  } else if (totalSlots >= 20) {
    addInventoryBtn.textContent = 'Hard Limit';
    addInventoryBtn.title = `Hard limit of 20 slots reached`;
  } else {
    addInventoryBtn.textContent = '+ Add Item Slot';
    addInventoryBtn.title = `Add new item slot (${currentCount}/${maxSlots} items, ${totalSlots} slots)`;
  }
  
  // Visual indicators
  if (!allSlotsPopulated) {
    addInventoryBtn.style.backgroundColor = 'rgba(255, 165, 0, 0.3)';
  } else if (totalSlots >= maxSlots || totalSlots >= 20) {
    addInventoryBtn.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
  } else {
    addInventoryBtn.style.backgroundColor = '';
  }
}

addInventoryBtn.onclick = () => {
  const maxSlots = Math.min(getMaxItemSlots(), 20);
  const currentCount = getCurrentItemCount();
  const totalSlots = getTotalItemSlots();
  const allSlotsPopulated = areAllSlotsPopulated();
  
  // Check if all slots are populated
  if (!allSlotsPopulated) {
    alert(`Please complete all ${totalSlots} existing slot${totalSlots !== 1 ? 's' : ''} before adding more items!`);
    return;
  }
  
  // Check capacity limits
  if (totalSlots >= maxSlots) {
    alert(`Inventory capacity reached! You can carry a maximum of ${maxSlots} items. Level up Endurance to increase capacity.`);
    return;
  }
  
  if (totalSlots >= 20) {
    alert('Hard limit of 20 inventory slots reached!');
    return;
  }
  
  // Add new slot
  inventory.push({});
  saveState('inventory', inventory);
  renderInventory();
  updateAddItemButtonState(); // Refresh button state
};

if (inventory.length === 0) {
  inventory = ['', '']; // artefact + iris
  saveState('inventory', inventory);
}
const inventoryDB = {
  artefacts: {
    "The Darkflame": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Scales with arcane or tinge.
Immune to high temperatures, burns, inflammation, and fever.
Grants fire and smoke magic & skills.
Sacrifice things to flame to gain coalesce.`,
      image: "cards/fronts/110.webp"
    },
    "The Wintergrace": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Scales with arcane or tinge.
Immune to cold temperatures, frostbite, and hypothermia.
Grants ice and frost magic & skills.
Recharges coalesce in moonlight.`,
      image: "cards/fronts/111.webp"
    },
    "The Bronze Ring of Smiles": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Grants charisma, illusion,
deception, intimidation.
Grants gaze magic & skills.
Regain coalesce from relationships.`,
      image: "cards/fronts/112.webp"
    },
    "The Wand": {
      type: "Legendary Hero Artefact — Treasure",
      description: `When resolving arcane, add tinge. coalesce: Choose one spell: It can only be used by the wand, it only costs one coalesce to use that spell. This spell is ready at all times. Whenever you forget a spell, regain one coalesce.`,
      image: "cards/fronts/113.webp"
    },
    "The Pair and a Half": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Scales with skill.
Add one to skill when resolving.
The cloth is immune and impervious.
Mutes sounds made by the bearer.
Grants bizarre skills. Whenever you begin a cycle with no madness, regain one coalesce.`,
      image: "cards/fronts/114.webp"
    },
    "The Trickblade": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Scales with strength.
Add one strength when resolving.
Truestrike when thrust or thrown.
Grants bizarre skills. At night, regain one coalesce when any quest is revealed.`,
      image: "cards/fronts/115.webp"
    },
    "The Fisherman's Flask": {
      type: "Legendary Hero Artefact — Treasure",
      description: `When resolving: add two arcane.
Produces any substance as poured into the maw.
Grants bizarre magic.
When consuming potions, elixirs, and drinks, regain one coalesce.`,
      image: "cards/fronts/116.webp"
    },
    "Scathe's Memo Book": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Questions, predictions, and histories can be written on the page;
spells cast this way ignore requirements. Once locked, pages appear anew. At night, regain one coalesce whenever any story is revealed.`,
      image: "cards/fronts/117.webp"
    },
    "The Prismatic Glasses": {
      type: "Legendary Hero Artefact — Treasure",
      description: `When resolving: add two tinge.
Can detect attunement and prowess, and sense the unreadable.
Grants futuresight and scan. At night, regain one coalesce whenever any library is revealed.`,
      image: "cards/fronts/118.webp"
    },
    "The Coin": {
      type: "Legendary Hero Artefact — Treasure",
      description: `Gain luck.
When resolving situations, add luck. Anyone else holding the coin is also lucky. When used to pay or trade; a new coin may be found somewhere...
Grants mundane magic & skills. At the end of the cycle, if you have the highest madness and coins, regain one coalesce.`,
      image: "cards/fronts/119.webp"
    }
  },

  irises: {
    "Steady Sky Blue": {
      type: "Eyes — Iris",
      description: `When affected by any real or artificial light, regain one mana and gain favour after casting.`,
      image: "cards/fronts/040.webp"
    },
    "Bravely Bold Gold": {
      type: "Eyes — Iris",
      description: `Resist dread, panic, terror.
In a pinch, cast spells or act until a resource pool is completely empty.`,
      image: "cards/fronts/043.webp"
    },
    "Radiant Emerald Green": {
      type: "Eyes — Iris",
      description: `Occasionally, do not trigger tap.
You may pay energy instead of life.`,
      image: "cards/fronts/046.webp"
    },
    "Softly Strange Violet": {
      type: "Eyes — Iris",
      description: `Double your spell limit.
If blessed, +1 to interest when acting as negotiator. If cursed, +1 to patience when acting as negotiator.`,
      image: "cards/fronts/049.webp"
    },
    "Feverspin Crimson": {
      type: "Eyes — Iris",
      description: `After casting or combining three or more spells, gain empower.
Gain quick after using empower.`,
      image: "cards/fronts/052.webp"
    },
    "Amberbright Hazel": {
      type: "Eyes — Iris",
      description: `Resist moonworm effects.
Tap: Act as if touched by dawn.
Untap: Trigger a madness effect.`,
      image: "cards/fronts/055.webp"
    },
    "Honeydark Smoulder": {
      type: "Eyes — Iris",
      description: `After performing a physical action, the next spell gains favour.
After performing any spell, the next physical action gains favour.`,
      image: "cards/fronts/058.webp"
    },
    "Silver Slivers": {
      type: "Eyes — Iris",
      description: `Stop time:
Gain quick, and act, then tap.
At dawn, forfeit mana or power and then untap.`,
      image: "cards/fronts/061.webp"
    },
    "Otherworldly Odd": {
      type: "Eyes — Iris",
      description: `At the start of your turn, you must forget one spell, then gain another.
You can only possess five total spells of any kind.`,
      image: "cards/fronts/064.webp"
    },
    "Absolute Cloying Dark": {
      type: "Eyes — Iris",
      description: `If you have any madness spell, succeed madness resolves.
If you have the highest madness, ignore night effects.`,
      image: "cards/fronts/067.webp"
    }
  },

  items: {
    "Basic Buckler": {
      type: "Basic Artefact — Equipment",
      description: `Equip: Requires strength 2 or higher.
Gain armour 1. (reduce incoming damage by one)`,
      image: "cards/fronts/120.webp"
    },
    "Basic Shortsword": {
      type: "Basic Artefact — Equipment",
      description: `Equip: Requires strength 1 or higher.
When melee attacking using,
add 1 to resolves or damage.`,
      image: "cards/fronts/121.webp"
    },
    "Crested Shield": {
      type: "Basic Artefact — Equipment",
      description: `Equip: Requires strength 3 or higher.
Pay one stamina: Gain shield 2 during this combat.
(absorb two damage)
Skill 3 or higher: Pay one stamina: Parry incoming strike or slash attack.`,
      image: "cards/fronts/122.webp"
    },
    "Simple Shortbow": {
      type: "Basic Artefact — Equipment",
      description: `Equip: Requires skill 1 or higher.
Pay one stamina: Deal 1 pierce damage.
Skill 3 or higher: You can shoot three times.`,
      image: "cards/fronts/123.webp"
    },
    "Legionnaire Crossbow": {
      type: "Artefact — Equipment",
      description: `Equip: Requires skill 2 or higher.
Pay one stamina then channel to charge your shot: Deal 2 pierce damage.
Strength 5: Double the damage and the range.`,
      image: "cards/fronts/124.webp"
    },
    "Crysk Knife": {
      type: "Artefact — Equipment",
      description: `Equip: Requires skill 1 or higher.
Pay one stamina: After successful attack, prevent target from casting a spell or activating an ability.
Skill 3: Also add 3 pierce damage.`,
      image: "cards/fronts/125.webp"
    },
    "Whispering Shield": {
      type: "Artefact — Equipment",
      description: `Equip: Requires strength 3 or higher.
Pay one stamina: Gain shield 3.
(absorb three damage this combat)
Skill 3: Pay one stamina: Parry incoming magic.`,
      image: "cards/fronts/126.webp"
    },
    "Twisted Metal Arm": {
      type: "Artefact — Equipment",
      description: `Equip: Requires skill 3 or higher.
When resolving strength, add 1.
Pay stamina: Griplock an object, you cannot let go or drop this object until you choose to release it.`,
      image: "cards/fronts/127.webp"
    },
    "Intricate Metal Arm": {
      type: "Artefact — Equipment",
      description: `Equip: Requires skill 3 or higher.
Pay one empower: Electrify and magnetize arm.
Pay one stamina: Shock and paralyze attacker, can be used as a reaction.
Resist burn and freeze.`,
      image: "cards/fronts/128.webp"
    },
    "Arcanite Mining Gauntlet": {
      type: "Artefact — Equipment",
      description: `Equip: Requires strength 4 or higher.
Pay one stamina: Deal damage based on strength and stun a target, striking with devastating force. You may freely target walls, floors, etcetera.
Mastery 3: Socket a soulgem.`,
      image: "cards/fronts/129.webp"
    },
    "Arcanite Slingshot": {
      type: "Artefact — Arcane Equipment",
      description: `Pay one energy: Shoot a pebble of arcane energy. Activate arcane objects.
Mastery 3: Deal 1 true damage.`,
      image: "cards/fronts/130.webp"
    },
    "Arcane Gemsetting Tool": {
      type: "Artefact — Arcane Equipment",
      description: `Pay two stamina, two energy, and 1 of any resource:
Mastery 2: Install a soulgem.
Mastery 5: Remove a soulgem.
Arcane 20: Carve a soulgem socket.`,
      image: "cards/fronts/131.webp"
    },
    "Arcanite Battery Pack": {
      type: "Artefact — Arcane Equipment",
      description: `When socketed with a soulgem:
Provide required electricity to power devices, tools, and other equipment. You may pay one energy to activate this soulgem's socketed or unsocketed effects.`,
      image: "cards/fronts/132.webp"
    },
    "Arcanite Firearm": {
      type: "Artefact — Arcane Equipment",
      description: `Pay three energy: Shoot a bolt of arcane energy. Activate arcane objects, or deal damage equal to your arcane.
Requires Skill to aim accurately...`,
      image: "cards/fronts/133.webp"
    },
    "Arcanite Revolver": {
      type: "Artefact — Arcane Equipment",
      description: `Pay one energy: Deal damage equal to your mastery; then resolve one d6:
Shoot again for each unique result, otherwise tap this card. (e.g. roll a 1, fire again; roll a 5, fire again; roll a 3, fire again; roll a 1, gun jams, tap this card.) Pay 6 of any resource to reload and untap this card.
Requires Strength for the recoil. Physically striking with this weapon can activate arcane objects.`,
      image: "cards/fronts/134.webp"
    },
    "Moontooth": {
      type: "Artefact — Arcane Equipment",
      description: `Mastery 4: Swings blast seawater. The amount is equal to the user's mastery and strength combined (in litres).
Strength 6: All strikes push targets away. Force is incredible, forcing foes back a minimum of three meters. Maximum pushback is porportional to strength.`,
      image: "cards/fronts/135.webp"
    },
    "Saphir": {
      type: "Artefact — Arcane Equipment",
      description: `Mastery 2: Strikes gain quick and pierce. 
Skill 3: Strikes gain triplestrike. Each single attack hits three times.`,
      image: "cards/fronts/136.webp"
    },
    "Caladlo": {
      type: "Artefact — Equipment",
      description: `If target has armour, gain swift and doublestrike (each attack hits twice).
Strength & Skill 3 or higher: Remove and prevent target's shields. Target cannot gain shields for the rest of combat.`,
      image: "cards/fronts/137.webp"
    },
    "Matsubazue": {
      type: "Artefact — Equipment",
      description: `Channel to focus your mind and build strength:
Inflict concussive force or break bones instead of inflicting damage.
Skill 6: You may counter-attack any weapon-based attack. Can be used as areaction.`,
      image: "cards/fronts/138.webp"
    },
    "Woven Wreath": {
      type: "Artefact — Equipment",
      description: `You feel confident, pretty.
Anyone nearby winces with pain or starts crying when thinking of you negatively.`,
      image: "cards/fronts/139.webp"
    },
    "Cozy Scarf": {
      type: "Artefact — Equipment",
      description: `Seems to fold infinitely.
Stretches unnaturally long. Can conceal items within, but the weight cannot be ignored.`,
      image: "cards/fronts/140.webp"
    },
    "Clamping Ankle Bracers": {
      type: "Artefact — Equipment",
      description: `Allows movement, unimpeded.
Easily jump higher and farther.
Contains one empty soulgem socket.`,
      image: "cards/fronts/141.webp"
    },
    "Strand-Type Carry Device": {
      type: "Artefact — Arcane Equipment",
      description: `Pay one stamina: Allocate items to the device.
Do not lose stamina when moving, carrying, or running.
Items gain indestructible.`,
      image: "cards/fronts/142.webp"
    },
    "Strand-Type Cuff Device": {
      type: "Artefact — Arcane Equipment",
      description: `Pay three energy: Switch places with another bearer, you both gain 1 shield. (Absorb 1 damage; occasionally, nullify mundane damage instead)
Mastery 2: Awaken soulgem.`,
      image: "cards/fronts/143.webp"
    },
    "Strand-Type Choker Device": {
      type: "Artefact — Arcane Equipment",
      description: `Pay one energy: Gain favour momentarily.
Mastery 3: Socket a soulgem.`,
      image: "cards/fronts/145.webp"
    },
    "Catscratch Medallion": {
      type: "Artefact — Equipment",
      description: `You are more susceptible to dread, panic, horrify, and the ethereal.
Detect charms, traps, and understand hexes and curses.`,
      image: "cards/fronts/146.webp"
    },
    "Pegasus Soulgem Medallion": {
      type: "Legendary Artefact — Soulgem",
      description: `When held, amplifies any movement action. Holding your breath while falling slows descent. (Effectively float-fall slowly as if gravity was reduced to its square root.)`,
      image: "cards/fronts/147.webp"
    },
    "Mercurial Opal": {
      type: "Legendary Artefact — Soulgem",
      description: `For each resource pool at maximum, gain +1 to resolves or calculations. When socketed into a tool, gear, device, or machine, energizes indefinitely.`,
      image: "cards/fronts/148.webp"
    },
    "Cascading Crystal": {
      type: "Soulgem — Powerstone",
      description: `After receiving any force of physical impact, user can unleash equal force from the gem, effectively reflecting impacts. When socketed into a weapon or tool, object becomes extremely bouncy.`,
      image: "cards/fronts/149.webp"
    },
    "Spiderflame Diamond": {
      type: "Soulgem — Powerstone",
      description: `Remaining still, eyes closed, the user can detect movement further and further away. Can be used to vaguely sense things at a distance. When socketed, object becomes magnetic at-will. The user can simply declare the magnetism.`,
      image: "cards/fronts/150.webp"
    },
    "Abyssal Onyx": {
      type: "Soulgem — Powerstone",
      description: `Emits a light visible only to its user. Can devour artificial light in the surrounding area. When socketed, repels liquids, dust, and other small particles from the object.`,
      image: "cards/fronts/151.webp"
    },
    "Sharp Garnet": {
      type: "Soulgem — Powerstone",
      description: `All types of force exerted gain sharp and pierce. When socketed into a tool, gear, or wearable equipment, contacting a critical weakpoint causes target to shatter into dust.`,
      image: "cards/fronts/152.webp"
    },
    "Sakura Ruby": {
      type: "Soulgem — Powerstone",
      description: `Repeated actions gain +1. (Jumping, running, casting etcetera gain a gradual amplification)
When socketed, energizes tools and weapons to resonate at extreme speeds. (A blade would appear to vibrate imperceptibly fast, causing it to slice through almost anything.)`,
      image: "cards/fronts/153.webp"
    },
    "Cosmic Pearl": {
      type: "Soulgem — Powerstone",
      description: `If a spell or action would cost more than you have, use it then empty that resource pool. When socketed, energizes other nearby things.`,
      image: "cards/fronts/154.webp"
    },
    "Redsky Pearl": {
      type: "Soulgem — Powerstone",
      description: `When in darkness, untouched by any light, gain one empower if you have none. When socketed, object cannot freeze nor become wet; object maintains temperature as when it was socketed.`,
      image: "cards/fronts/155.webp"
    },
    "Coiling Amethyst": {
      type: "Soulgem — Powerstone",
      description: `Onlookers may become anxious. Gain favour when near a deep body of water or when resting. When socketed, object cannot fall apart.`,
      image: "cards/fronts/156.webp"
    },
    "Folded Moss": {
      type: "Soulgem — Powerstone",
      description: `Eating spiced food can bestow or remove curses and blessings. When socketed, object becomes squishy, rubbery, and impervious.`,
      image: "cards/fronts/157.webp"
    },
    "Sharp Sapphire": {
      type: "Soulgem — Powerstone",
      description: `When physically attacking, you may resolve again (but you must take the new result). When socketed, if object is a weapon, inflict terror on targets if you miss. (They are afflicted with dread and panic.)`,
      image: "cards/fronts/158.webp"
    },
    "Emanating Garnet": {
      type: "Soulgem — Powerstone",
      description: `When physically attacking, add endurance or potency. When socketed, if object is a weapon, deal crush and strike damage instead.`,
      image: "cards/fronts/159.webp"
    },
    "Sunsmoke Jade": {
      type: "Soulgem — Powerstone",
      description: `Unlock true power when socketed.`,
      image: "cards/fronts/160.webp"
    },
    "Ball Ruby": {
      type: "Soulgem — Powerstone",
      description: `When resting, you may reduce madness instead of recovering life and stamina. When socketed, object feels almost weightless.`,
      image: "cards/fronts/161.webp"
    },
    "Mesmer Diamond": {
      type: "Soulgem — Powerstone",
      description: `Wonderous tendrils of ivory are hewn beneath the skin.
If you would lose madness, you may instead gain 1 of any resource.
When socketed, puppet object freely.`,
      image: "cards/fronts/162.webp"
    },
    "Hollow Prism": {
      type: "Soulgem — Powerstone",
      description: `Store an amount of mana or energy inside this soulgem, then tap it off to the side.
Return this soulgem from a tapped position: release mana or energy, then gain one madness.
When socketed, you may command object to return to your hand or person.`,
      image: "cards/fronts/163.webp"
    },
    "Blooming Seaglass": {
      type: "Soulgem — Powerstone",
      description: `During any encounter, opponent gains slow and cannot gain favour. Mellowing the demeanor of any beast.
When socketed into a non-weapon, fascinates beasts, plants, and insects.`,
      image: "cards/fronts/164.webp"
    },
    "Starstone": {
      type: "Soulgem — Powerstone",
      description: `Resist dread, panic, and terror. Repels wormridden things. Kills nearby airborne infectious materials. Likewise sterilizes small amounts of water when submerged.
Socketed objects become suspended mid-air when released.`,
      image: "cards/fronts/165.webp"
    },
    "Starglass": {
      type: "Soulgem — Powerstone",
      description: `Repeat any spell cast by another if the cost is less than your Mastery.
When socketed, object whispers warnings and rumours.`,
      image: "cards/fronts/166.webp"
    },
    "Bicoded Twist": {
      type: "Soulgem — Powerstone",
      description: `Whenever you pay exactly two different costs, add 2 to values on that card then tap this soulgem off to the side.
Whenever you gain or lose madness, you may untap and return this card. Cannot be socketed.`,
      image: "cards/fronts/167.webp"
    },
    "Wet Deeprock": {
      type: "Soulgem — Powerstone",
      description: `Adheres to surfaces effortlessly. When imbued with mana or energy, becomes proportionally heavy. Effect dissipates over time, proportional to the mana or energy spent. Socketed object becomes cold and salty.`,
      image: "cards/fronts/168.webp"
    },
    "Polar Crystal": {
      type: "Soulgem — Powerstone",
      description: `Can store and release electricity.
When socketed, remove requirements, costs, tap effects and untap effects from object.`,
      image: "cards/fronts/169.webp"
    },
    "Potion of Healing": {
      type: "Item — Potion",
      description: `Regain 3 life.
You cannot gain beyond maximum life.`,
      image: "cards/fronts/170.webp",
      consumable: true,
      effect: function() {
        const maxLife = Number(loadState('maxLife', 10)) || 10;
        const currentLife = Number(loadState('life', 0)) || 0;
        const newLife = Math.min(maxLife, currentLife + 3);
        saveState('life', newLife);
        updateAllBars();
      }
    },
    "Potion of Refreshment": {
      type: "Item — Potion",
      description: `Regain 2 stamina.
You cannot gain beyond maximum stamina.`,
      image: "cards/fronts/174.webp",
      consumable: true,
      effect: function() {
        const maxStamina = Number(loadState('maxStamina', 10)) || 10;
        const currentStamina = Number(loadState('stamina', 0)) || 0;
        const newStamina = Math.min(maxStamina, currentStamina + 2);
        saveState('stamina', newStamina);
        updateAllBars();
      }
    },
    "Potion of Potency": {
      type: "Item — Potion",
      description: `Regain one empower.
Fragile.
Flammable.`,
      image: "cards/fronts/178.webp",
      consumable: true,
      effect: function() {
        const currentEmpower = Number(loadState('empower', 0)) || 0;
        const newEmpower = currentEmpower + 1;
        saveState('empower', newEmpower);
        updateAllBars();
      }
    },
    "Potion of Sunshine": {
      type: "Item — Potion",
      description: `Regain one mana. Fragile.
Tinge 11: Regain one additional mana when consuming this potion.
Tinge 22: Tastes pleasant, abating any current madness effect.`,
      image: "cards/fronts/182.webp",
      consumable: true,
      effect: function() {
        const maxMana = Number(loadState('maxMana', 10)) || 10;
        const currentMana = Number(loadState('mana', 0)) || 0;
        const tinge = Number(loadState('Tinge', 0)) || 0;
        
        // Base: regain 1 mana
        let manaToGain = 1;
        
        // Tinge 11+: regain 1 additional mana
        if (tinge >= 11) {
          manaToGain = 2;
        }
        
        const newMana = Math.min(maxMana, currentMana + manaToGain);
        saveState('mana', newMana);
        updateAllBars();
      }
    },
    "Potion of Sparkling Water": {
      type: "Item — Potion",
      description: `Fragile.
Gain Arcane Touch, duration is equal to your tinge or endurance, whichever is higher.
Arcane 6: Regain 2 energy.`,
      image: "cards/fronts/186.webp",
      consumable: true,
      effect: function() {
        const arcane = Number(loadState('Arcane', 0)) || 0;
        
        // Only regain energy if Arcane is 6 or higher
        if (arcane >= 6) {
          const maxEnergy = Number(loadState('maxEnergy', 10)) || 10;
          const currentEnergy = Number(loadState('energy', 0)) || 0;
          const newEnergy = Math.min(maxEnergy, currentEnergy + 2);
          saveState('energy', newEnergy);
          updateAllBars();
        }
      }
    },
    "Potion of Dreaming": {
      type: "Item — Potion",
      description: `Fragile. Choose one:
Sleep briefly, then awaken; or
Calm your nerves, remove 3 madness.`,
      image: "cards/fronts/190.webp"
    },
    "Murky Elixir": {
      type: "Item — Elixir",
      description: `Double any healing effect.
If you become poisoned, venomed, toxic etcetera, or any related status effect, reduce the duration of that effect to 1.
You are more easily surprised, startled, or intimidated after imbibing this elixir.`,
      image: "cards/fronts/193.webp"
    },
    "Beastblood Elixir": {
      type: "Item — Elixir",
      description: `Improves chances of befriending or intimidating some beasts.
Avid drinkers claim further effects. Your breath and body smell like wet dog, or vanilla?`,
      image: "cards/fronts/196.webp"
    },
    "Humeblood Elixir": {
      type: "Item — Elixir",
      description: `An inky, fizzy cola. Smells of copper with a hint of bacon. Caffeinates when hot; inebriates when cold. Helps to smooth over interactions or social situations.`,
      image: "cards/fronts/199.webp"
    },
    "Vial of Lunacy": {
      type: "Item — Elixir",
      description: `Duration is equal to your madness.
Combine strength and skill while affected by this elixir. Cruel energies empower your demeanor, you are more prone to outbursts and acting out intrusive thoughts.
Activate one madness effect.`,
      image: "cards/fronts/201.webp"
    },
    "Vial of Volpe": {
      type: "Item — Elixir",
      description: `A wonderful flavour tickles your tongue. Resolve one d20: If the result is 1~10, you may regain that much life or stamina, or one empower; if you roll 11~20, gain one madness. (e.g. if you roll a 10, you may choose to gain 10 life; if you roll an 11, you  must gain one madness.)`,
      image: "cards/fronts/204.webp"
    },
    "Heady Elixir": {
      type: "Item — Elixir",
      description: `Bestows a heady feeling for a time.
The imbiber experiences a sense of euphoria, becoming immune to negative moods and intimidation, but susceptible to seduction. Nullify reactions toward situations that would normally trigger an outburst.`,
      image: "cards/fronts/207.webp"
    },
    "Sparkwine": {
      type: "Item — Elixir",
      description: `Applying to the skin, protects and remedies sunburns. Useful during summer heat or the after effects of some light spells. When imbibed, causes a heady excitatory buzzing. Can be used to negate effects of certain sleep-inducing poisons or witchcraft.
Consecutive drinks increase the effect but reduce duration: double the effective potency but reduce remaining duration by 1.`,
      image: "cards/fronts/210.webp"
    },
    "Woebane Elixir": {
      type: "Item — Elixir",
      description: `Cherry smoke replaces your breath: React calmly to the world around you, act as if your soul has just awoken from a catnap. Useful in many situations. Can improve patience during negotiations.
Duration is equal to your current madness.`,
      image: "cards/fronts/213.webp"
    },
    "Swirling Cream": {
      type: "Item — Drink",
      description: `Minty sweetness coats your mouth, lips, and tongue: Soothe your nerves.
Abate an allergic reaction or become ridiculously intoxicated.`,
      image: "cards/fronts/216.webp"
    },
    "Sunset Sap": {
      type: "Item — Drink",
      description: `Chewey, jellylike substance popular among children and their parents.
Innocuous. Pernicious. Wonderful.`,
      image: "cards/fronts/219.webp"
    },
    "Lilypad Rime": {
      type: "Item — Drink",
      description: `Prized by brewers and mixers.
Some report a chilling effect.
Inebriates for a prolonged time, usually as a matter of one's madness.`,
      image: "cards/fronts/222.webp"
    },
    "Honeyseed Soma": {
      type: "Item — Drink",
      description: `Often taken as a remedy for nausea, headaches, stomach aches, pain, and dizziness. Results in a bouncy and delightfully comfortable mood.`,
      image: "cards/fronts/225.webp"
    }
  }
};

function createInventoryCard(index, slotType, data = {}) {
  const hasImage = data.image ? 'has-image' : '';
  const isLocked = data.locked ? 'locked' : '';
  const imgContent = data.image 
    ? `<img src="${data.image}" alt="${data.name || 'Item'}" />`
    : `<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`;
  
  return `
  <div class="inventory-item" data-index="${index}" data-slot="${slotType}">
    <div class="inv-image ${hasImage}">${imgContent}</div>
    
    <div class="inv-info">
      <input class="inv-name ${isLocked}" 
             placeholder="${placeholderForSlot(slotType)}" 
             value="${data.name || ''}" 
             ${isLocked ? 'readonly' : ''} />
      <div class="inv-type">${data.type || slotTypeLabel(slotType)}</div>
      <div class="inv-description">${data.description || '—'}</div>
    </div>
    
    <button class="inv-confirm-btn">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
    </button>
    <button class="inv-delete-btn">
      <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>`;
}

function placeholderForSlot(slot) {
  if (slot === 'artefact') return 'Soulbound Artefact';
  if (slot === 'iris') return 'Iris';
  return 'Item';
}

function slotTypeLabel(slot) {
  if (slot === 'artefact') return 'Soulbound Artefact';
  if (slot === 'iris') return 'Iris';
  return 'Item';
}

// Helper: Check if item type is consumable
function isConsumable(type) {
  if (!type) return false;
  const t = type.toLowerCase();
  return t.includes('potion') || t.includes('elixir') || t.includes('drink');
}

// Helper: Check if item grants carry bonus
const CARRY_BONUS_ITEMS = ['Cozy Scarf', 'Clamping Ankle Bracers', 'Strand-Type Carry Device'];

function hasCarryBonusItem() {
  return inventory.some(item => item?.name && CARRY_BONUS_ITEMS.includes(item.name));
}

// Calculate max carry capacity (items only, not artefact/iris)
function getMaxItemSlots() {
  const endurance = Number(loadState('Endurance', 0)) || 0;
  let base = 3 + endurance;
  if (hasCarryBonusItem()) base += 8;
  return base;
}

// Count current items (excluding artefact/iris slots)
function getCurrentItemCount() {
  return inventory.slice(2).filter(item => item?.name).length;
}

// 2025 Enhancement: Check if ALL item slots are populated
function areAllSlotsPopulated() {
  const itemSlots = inventory.slice(2); // Get all item slots
  return itemSlots.length === 0 || itemSlots.every(slot => slot?.name && slot.name.trim() !== '');
}

// Get total number of item slots (including empty ones)
function getTotalItemSlots() {
  return inventory.slice(2).length;
}

// Check if item already exists (for uniqueness), excluding a specific index
function itemAlreadyExists(name, excludeIndex = -1) {
  return inventory.some((item, i) => i !== excludeIndex && item?.name === name);
}

// 2025 Enhancement: Case-insensitive duplicate checking
function itemAlreadyExistsCaseInsensitive(name, excludeIndex = -1) {
  const searchLower = name.toLowerCase();
  return inventory.some((item, i) => i !== excludeIndex && item?.name?.toLowerCase() === searchLower);
}

function validateInventoryName(name, slot, excludeIndex = -1) {
  if (!name || name.trim().length === 0) return null;
  const trimmed = name.trim();
  
  // Get item data with improved fuzzy matching
  let itemData = null;
  let foundItem = null;
  
  if (slot === 'artefact') {
    foundItem = fuzzyMatch(inventoryDB.artefacts, trimmed);
    if (foundItem) {
      itemData = { name: foundItem.key, ...foundItem.data, locked: true };
    }
  } else if (slot === 'iris') {
    foundItem = fuzzyMatch(inventoryDB.irises, trimmed);
    if (foundItem) {
      itemData = { name: foundItem.key, ...foundItem.data, locked: true };
    }
  } else if (slot === 'item') {
    foundItem = fuzzyMatch(inventoryDB.items, trimmed);
    if (foundItem) {
      itemData = { name: foundItem.key, ...foundItem.data, locked: true };
    }
  }
  
  if (!itemData) {
    // Custom item
    itemData = { name: trimmed, type: slotTypeLabel(slot), description: '—', locked: false };
  }
  
  // Check uniqueness (allow duplicates only for consumables) - case insensitive
  if (itemData && itemAlreadyExistsCaseInsensitive(trimmed, excludeIndex) && !isConsumable(itemData.type)) {
    alert(`You already have "${trimmed}" in your inventory. Non-consumable items must be unique.`);
    return null;
  }
  
  return itemData;
}

// Helper function to find item data in inventoryDB
function findItemInDB(itemName) {
  if (!itemName) return null;
  
  // Check items section for exact match
  if (inventoryDB.items[itemName]) {
    return inventoryDB.items[itemName];
  }
  
  // Fuzzy match if exact match fails
  const fuzzyResult = fuzzyMatch(inventoryDB.items, itemName);
  if (fuzzyResult) {
    return fuzzyResult.data;
  }
  
  return null;
}

function bindInventoryEvents() {
  document.querySelectorAll('.inventory-item').forEach(card => {
    const index = +card.dataset.index;
    const slot = card.dataset.slot;
    const nameInput = card.querySelector('.inv-name');
    const confirmBtn = card.querySelector('.inv-confirm-btn');
    const deleteBtn = card.querySelector('.inv-delete-btn');
    const imageDiv = card.querySelector('.inv-image');
    
    // Show confirm button when name changes
    nameInput.addEventListener('input', () => {
      const currentValue = nameInput.value.trim();
      const savedName = inventory[index]?.name || '';
      if (currentValue !== savedName && currentValue.length > 0) {
        confirmBtn.classList.add('visible');
      } else {
        confirmBtn.classList.remove('visible');
      }
    });
    
    // Save on Enter
    nameInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveInventoryItem(index, slot, nameInput.value.trim());
        nameInput.blur();
      }
    });
    
    // Confirm button click
    confirmBtn.onclick = () => {
      saveInventoryItem(index, slot, nameInput.value.trim());
    };
    
    // Delete button with confirmation dialog
    deleteBtn.onclick = () => {
      const item = inventory[index];
      const itemName = item?.name || 'this item';
      
      if (confirm(`Discard "${itemName}"? This action cannot be undone.`)) {
        // Don't delete artefact/iris slots, just clear them
        if (index < 2) {
          inventory[index] = {};
        } else {
          inventory.splice(index, 1);
        }
        saveState('inventory', inventory);
        renderInventory();
      }
    };
    
    // Image click: Only consume for consumables, no zoom
    imageDiv.onclick = () => {
      const item = inventory[index];
      if (!item?.name) return;
      
      // Check if consumable
      if (isConsumable(item.type)) {
        if (confirm(`Consume "${item.name}"?`)) {
          // Execute item effect if it exists
          const itemData = findItemInDB(item.name);
          if (itemData && itemData.effect && typeof itemData.effect === 'function') {
            try {
              itemData.effect();
            } catch (error) {
              console.error('Error executing item effect:', error);
            }
          }
          
          // Remove the consumed item
          if (index < 2) {
            inventory[index] = {};
          } else {
            inventory.splice(index, 1);
          }
          saveState('inventory', inventory);
          renderInventory();
        }
      }
      // Non-consumables: could add image upload here
    };
  });
}

function saveInventoryItem(index, slot, name) {
  const result = validateInventoryName(name, slot, index);
  if (!result) {
    // Don't clear if validation failed due to duplicate
    if (!name || name.trim().length === 0) {
      inventory[index] = {};
    }
  } else {
    inventory[index] = result;
  }
  saveState('inventory', inventory);
  renderInventory();
}

// Override renderInventory to use cards
renderInventory = function() {
  inventoryList.innerHTML = '';
  
  // Ensure minimum slots
  while (inventory.length < 2) {
    inventory.push({});
  }
  
  // Update capacity display
  const capacityEl = document.getElementById('inventoryCapacity');
  if (capacityEl) {
    const current = getCurrentItemCount();
    const max = getMaxItemSlots();
    const isFull = current >= max;
    capacityEl.innerHTML = `Items: <span class="${isFull ? 'capacity-full' : ''}">${current} / ${max}</span>`;
  }
  
  inventory.forEach((item, i) => {
    const slotType = i === 0 ? 'artefact' : i === 1 ? 'iris' : 'item';
    const data = typeof item === 'object' ? item : {};
    inventoryList.innerHTML += createInventoryCard(i, slotType, data);
  });
  
  bindInventoryEvents();
  updateAddItemButtonState();
};

/* ========= MIND/SPELL SYSTEM ========= */
const mindBtn = document.getElementById('mindBtn');
const mindOverlay = document.getElementById('mindOverlay');
const spellList = document.getElementById('spellList');
const addSpellBtn = document.getElementById('addSpellBtn');

// Icon mapping for costs (relative to player2026.html location)
const COST_ICONS = {
  life: '../icons/Life1.png',
  stamina: '../icons/stamina1.png',
  empower: '../icons/empower1.png',
  mana: '../icons/mana1.png',
  energy: '../icons/energy1.png',
  coalesce: '../icons/crys.svg',
  potency: '../icons/potency7.png',
  mastery: '../icons/mastery4.png',
  tinge: '../icons/mana4.png',
  arcane: '../icons/moonworm.png',
  worm: '../icons/worm1.png',
  skill: '../icons/skl.png',
  strength: '../icons/str.png',
  madness: '../icons/madness.png',
  swap: '../icons/swap.svg',
  tap: '../icons/tap2.png',
  untap: '../icons/untap2.png',
  channel: '../icons/slow4.png',
  ready: '../icons/slow1.png',
  armour: '../icons/armour.svg',
  shield: '../icons/mshield.svg',
  generic: '../icons/crys.svg', // Generic cost - player chooses
  x: '../icons/crys.svg' // X cost - player inputs amount
};

// Spell Database - cards 380-531 regular, 532-549 special (artefact-locked)
// Structure: { id, name, subtitle, primaryType, secondaryType, cost, description, style }
// Cost format: array of {type, amount} where type matches COST_ICONS keys
// Special types: "generic" = player chooses resource, "x" = player inputs amount
// Total spells: 109
const spellDB = {
  "Sprint, Dash, Run": {
    name: "Sprint, Dash, Run",
    primaryType: "Basic",
    secondaryType: "Adventure Action",
    cost: [{"type": "stamina", "amount": 1}],
    description: "Simple movement action. \n(Affected by <img src='../icons/str.png' class='desc-icon' alt='str' /> or <img src='../icons/skl.png' class='desc-icon' alt='skl' />)\n<em>Quick! On the double!</em>",
    image: "cards/fronts/380.webp"
  },
  "Throw, Climb, Steal, Hide": {
    name: "Throw, Climb, Steal, Hide",
    primaryType: "Basic",
    secondaryType: "Adventure Action",
    cost: [{"type": "stamina", "amount": 1}],
    description: "Extra movement action. \nInteract with the environment. \n(Can require <img src='../icons/str.png' class='desc-icon' alt='str' /> or <img src='../icons/skl.png' class='desc-icon' alt='skl' />)\n<em>You gotta do what you gotta do...</em>",
    image: "cards/fronts/381.webp"
  },
  "Jump, Attack, Dodge, Evade": {
    name: "Jump, Attack, Dodge, Evade",
    primaryType: "Basic",
    secondaryType: "Adventure Reaction",
    cost: [{"type": "stamina", "amount": 1}],
    description: "When you have quick, \nusable as a reaction. \n(Can require <img src='../icons/str.png' class='desc-icon' alt='str' /> or <img src='../icons/skl.png' class='desc-icon' alt='skl' />)\n<em>Think fast!</em>",
    image: "cards/fronts/382.webp"
  },
  "Enhance": {
    name: "Enhance",
    primaryType: "Basic",
    secondaryType: "Magical Action",
    cost: [{"type": "empower", "amount": 1}],
    description: "Increase or improve any physical action proportional to <img src='../icons/potency8.png' class='desc-icon' alt='potency' />. \n<img src='../icons/str.png' class='desc-icon' alt='str' /> 5: Refund the next <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' /> used. (requires five <img src='../icons/str.png' class='desc-icon' alt='str' /> or higher)\n<em>Pooling light into limbs allows for superhuman strength, speed, or silliness.</em>",
    image: "cards/fronts/383.webp"
  },
  "Regenerate": {
    name: "Regenerate",
    primaryType: "Basic Spell",
    secondaryType: "Magical Action",
    cost: [{"type": "coalesce", "amount": 0}],
    description: "Remove <img src='../icons/madness.png' class='desc-icon' alt='madness' /> then:\nRegain <img src='../icons/Life1.png' class='desc-icon' alt='life' /><img src='../icons/Life1.png' class='desc-icon' alt='life' /> or\nRegain <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' /><img src='../icons/stamina1.png' class='desc-icon' alt='stamina' /> or\nRegain <img src='../icons/energy1.png' class='desc-icon' alt='energy' /><img src='../icons/energy1.png' class='desc-icon' alt='energy' />.\n<em>Blood for power.</em>",
    image: "cards/fronts/384.webp"
  },
  "Replenish": {
    name: "Replenish",
    primaryType: "Nature Spell",
    secondaryType: "Magical Action",
    cost: [{"type": "channel", "amount": 0}],
    description: "Tap <img src='../icons/tap2.png' class='desc-icon' alt='tap' />, you may remove 1 from any of your own duration counters, then: \n<img src='../icons/potency8.png' class='desc-icon' alt='potency' /> 3: Regain <img src='../icons/mana1.png' class='desc-icon' alt='mana' />. \n<img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> 3: Regain <img src='../icons/energy1.png' class='desc-icon' alt='energy' />. \nWhen you gain <img src='../icons/madness.png' class='desc-icon' alt='madness' /> or bathe: Untap <img src='../icons/untap2.png' class='desc-icon' alt='untap' />.\n<em>I become me, anew.</em>",
    image: "cards/fronts/385.webp"
  },
  "Arclight": {
    name: "Arclight",
    primaryType: "Basic Spell",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 1}],
    description: "Deal 2 damage.\nPay <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' />: Ricochet, hit one more target, dealing +1 damage.\nDim (double the cost in low light)\n<em>Thrown like a ball, \nhits like a hammer!</em>",
    image: "cards/fronts/390.webp"
  },
  "Metallicize": {
    name: "Metallicize",
    primaryType: "Enchantment",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 2}],
    description: "Create a skin-like shield <img src='../icons/mshield.svg' class='desc-icon' alt='shield' />, \nabsorb damage equal to tinge. \nSoftlight (nullify in moonlight)\n<em>Innerlight starts soft, \nbecoming strong and rubbery.</em>",
    image: "cards/fronts/393.webp"
  },
  "Veil": {
    name: "Veil",
    primaryType: "Quick Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 3}],
    description: "Block 2 damage. \nPay <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' />: Block +1 per <img src='../icons/potency8.png' class='desc-icon' alt='potency' />. \nDim (double cost in low light)\n<em>Useful in a pinch.</em>",
    image: "cards/fronts/395.webp"
  },
  "Sunkiss": {
    name: "Sunkiss",
    primaryType: "Enchantment",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 3}],
    description: "Target spell gains lightborne (counts as light-magic) until dawnlight, add <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> to values. \nHardlight (requires sunlight)\n<em>Blessed be thine, \nforever and for true.</em>",
    image: "cards/fronts/396.webp"
  },
  "Mark": {
    name: "Mark",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 2}],
    description: "Conjures a seal. \nSpells against target gain swift. \nTrack target through walls and at any distance.\n<em>Some light forms as words, shapes, lines, designed to act upon a certain place \nor a certain time.</em>",
    image: "cards/fronts/398.webp"
  },
  "Seal of Tripwire": {
    name: "Seal of Tripwire",
    primaryType: "Seal",
    secondaryType: "Light Trap",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 3}],
    description: "Inscribe two seals. \nFast movement triggers a string of hardened light between the two points, stuns or slows victims.\n<em>Hard to see, until it isn't.</em>",
    image: "cards/fronts/400.webp"
  },
  "Seal of Reflection": {
    name: "Seal of Reflection",
    primaryType: "Seal",
    secondaryType: "Light Trap",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 2}],
    description: "Inscribe a seal. \nUpon physical contact, trigger an amplified and opposite force. \nDim (double the cost in low light)\n<em>The strangeness of light \nis understood by few.</em>",
    image: "cards/fronts/402.webp"
  },
  "Seal of Grace": {
    name: "Seal of Grace",
    primaryType: "Seal",
    secondaryType: "Light Trap",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 2}],
    description: "Inscribe a seal. \nIf you would pay or lose <img src='../icons/Life1.png' class='desc-icon' alt='life' />, you may consume this instead.\nSoftlight (nullify in moonlight)\n<em>You forget the shape when it fades.</em>",
    image: "cards/fronts/404.webp"
  },
  "Seal of Sound": {
    name: "Seal of Sound",
    primaryType: "Seal",
    secondaryType: "Light Trap",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 2}],
    description: "Inscribe a seal. \nWith a clap, the user consumes the seal, causing thunderous sounds and shaking in its place.\n<em>Placed on a weapon, underfoot, or on a saddle, it makes for a wondrous surprise.</em>",
    image: "cards/fronts/406.webp"
  },
  "Seal of Burning Bones": {
    name: "Seal of Burning Bones",
    primaryType: "Seal",
    secondaryType: "Light",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 3}],
    description: "Inscribe a seal. \nTarget receives <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> additional damage over 3 duration. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Double the damage.\n<em>Intricate lines, no matter how beautiful, are still made of sunlight. It burns.</em>",
    image: "cards/fronts/408.webp"
  },
  "Imbue Light": {
    name: "Imbue Light",
    primaryType: "Enchantment",
    secondaryType: "Light Seal",
    cost: [{"type": "mana", "amount": 3}],
    description: "Infuse anything with light, empowering it for a time. \nAdd <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> when resolving. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Re-activate the seal.\n<em>Bright burning heat packed tightly, ready to burst... on purpose, of course.</em>",
    image: "cards/fronts/410.webp"
  },
  "Lasso": {
    name: "Lasso",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 2}],
    description: "Conjure a rope of light and throw it at a target. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Stun target. \nDim (double cost in low light)\n<em>Whoa there!</em>",
    image: "cards/fronts/412.webp"
  },
  "Pillar": {
    name: "Pillar",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 1}],
    description: "Conjure heavy a rod of light, useful for keeping doors open and switches pressed.\nChannel <img src='../icons/slow4.png' class='desc-icon' alt='channel' />: Levitate Pillar.\n<em>Now is the time to use that.</em>",
    image: "cards/fronts/414.webp"
  },
  "Aura Flash": {
    name: "Aura Flash",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 1}, {"type": "stamina", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Nullify incoming projectile magics for a duration equal to X. \nSoftlight (nullify in moonlight)\nTinge 10: Quick.\n<em>Deflection is protection!</em>",
    image: "cards/fronts/416.webp"
  },
  "Bubble": {
    name: "Bubble",
    primaryType: "Quick Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 2}, {"type": "stamina", "amount": 2}],
    description: "Throw a dome of protection around a target. Nullify one type of incoming damage; end upon sustaining another type.\n<em>Quick thinking saved them from the arrows, but not the rocks.</em>",
    image: "cards/fronts/418.webp"
  },
  "Haste": {
    name: "Haste",
    primaryType: "Enchantment",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 3}, {"type": "stamina", "amount": 2}, {"type": "empower", "amount": 1}],
    description: "Think, move, act, and react faster; all actions are considered quick. Effect ends upon taking damage. \nTinge 17: Act again immediately.\n<em>Prolong each moment.</em>",
    image: "cards/fronts/419.webp"
  },
  "Radiant Palms": {
    name: "Radiant Palms",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 2}],
    description: "Emit light from your palms. \nTinge 18: Create a blinding flash of light, stunning foes.\nTinge 30: Quick.\n<em>So useful, yet so inconvenient.</em>",
    image: "cards/fronts/420.webp"
  },
  "Sunblade": {
    name: "Sunblade",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 5}],
    description: "Wield a blade made of sunlight. Slash for 5 damage. Repeat again for each point of <img src='../icons/str.png' class='desc-icon' alt='str' />. \nHardlight (requires sunlight)\n<em>The executioner. \nKneel.</em>",
    image: "cards/fronts/422.webp"
  },
  "Sunhammer": {
    name: "Sunhammer",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 5}],
    description: "Wield a hammer made of sunlight. Strike for maximum <img src='../icons/mana1.png' class='desc-icon' alt='mana' />. \nStuns a target based on <img src='../icons/str.png' class='desc-icon' alt='str' />. \nHardlight (requires sunlight)\n<em>Righteous and mighty! Tremble!</em>",
    image: "cards/fronts/423.webp"
  },
  "Mirage Barrage": {
    name: "Mirage Barrage",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 7}, {"type": "empower", "amount": 1}, {"type": "stamina", "amount": 1}],
    description: "Conjure a myriad of small, \nfloating daggers made of sunlight, equal to maximum <img src='../icons/mana1.png' class='desc-icon' alt='mana' />. \nSlash each blade for <img src='../icons/str.png' class='desc-icon' alt='str' /> or <img src='../icons/skl.png' class='desc-icon' alt='skl' />. \nDim (double the cost in low light)\n<em>Now I'm motivated.</em>",
    image: "cards/fronts/424.webp"
  },
  "Lay On Hands": {
    name: "Lay On Hands",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Pay X using only <img src='../icons/mana1.png' class='desc-icon' alt='mana' />.\nTouch a fallen ally, revive them with life <img src='../icons/Life1.png' class='desc-icon' alt='life' /> equal to X.\n<em>Do not go quietly into the darkness. Seek the light and come home.</em>",
    image: "cards/fronts/425.webp"
  },
  "Lightbringer": {
    name: "Lightbringer",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 2}],
    description: "Pull a small object, creature, or other target toward you. \nPay <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' />: Pull a larger target. \nTinge 20: Griplock target.\n<em>Catch this!</em>",
    image: "cards/fronts/426.webp"
  },
  "Sphere Smash": {
    name: "Sphere Smash",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "life", "amount": 1}, {"type": "mana", "amount": 3}/*, {"type": "generic", "amount": 0}*/],
    description: "Floats and maintains speed toward any target; powered by <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> and <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' />. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Shatter, destroy stone walls with concussive force.\nSoftlight (nullify in moonlight)\n<em>Slow and steady.</em>",
    image: "cards/fronts/428.webp"
  },
  "Dawn Spear": {
    name: "Dawn Spear",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 2}, {"type": "mana", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Throw a spear of light, \nembedding into a surface. \nDeal <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> pierce damage.\n<img src='../icons/str.png' class='desc-icon' alt='str' /> and <img src='../icons/skl.png' class='desc-icon' alt='skl' /> 2: Climb and manoeuvre using spears.\n<em>Incredibly real, until the jealous moon waves it away.</em>",
    image: "cards/fronts/430.webp"
  },
  "Sunswipe": {
    name: "Sunswipe",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "mana", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Strike with the hands. \nCut and slice through objects.\nDeal damage based on <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> and <img src='../icons/skl.png' class='desc-icon' alt='skl' />. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Immediately cast again.\n<em>The arcs of light buzz and hum as if pulling thousands of wires.</em>",
    image: "cards/fronts/432.webp"
  },
  "Petals Of Brilliance": {
    name: "Petals Of Brilliance",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "life", "amount": 1}, {"type": "mana", "amount": 3}],
    description: "Bloom a flower made of light in the hand, blow petals outward. Amount are based on <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> and <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' />. \nPetals heal 1 <img src='../icons/Life1.png' class='desc-icon' alt='life' />.\n<em>Beautiful and fragile. Feels like a warm cheek pressed against your skin.</em>",
    image: "cards/fronts/434.webp"
  },
  "Shimmering Masonry": {
    name: "Shimmering Masonry",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "mana", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Conjure bricks made of light. Number of bricks is based on <img src='../icons/potency8.png' class='desc-icon' alt='potency' />.\n<img src='../icons/str.png' class='desc-icon' alt='str' /> or <img src='../icons/skl.png' class='desc-icon' alt='skl' /> 3: Climb bricks. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Launch bricks, dealing <img src='../icons/str.png' class='desc-icon' alt='str' />.\nSoftlight (nullify in moonlight)\n<em>Incredibly real, \nlest the moon wash them away.</em>",
    image: "cards/fronts/436.webp"
  },
  "Light Bolt": {
    name: "Light Bolt",
    primaryType: "Quick Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "mana", "amount": 2}],
    description: "Shoot a beam of light, knocking target and you back D20+6. \nDeal 3 pierce damage. \nChannel <img src='../icons/slow4.png' class='desc-icon' alt='channel' />: Ignore knockback.\n<em>Quite the shock at both ends.</em>",
    image: "cards/fronts/438.webp"
  },
  "Light Arrow": {
    name: "Light Arrow",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 4}/*, {"type": "generic", "amount": 0}*/],
    description: "Pierce using <img src='../icons/potency8.png' class='desc-icon' alt='potency' />. \nChannel <img src='../icons/slow4.png' class='desc-icon' alt='channel' />: Add current <img src='../icons/mana1.png' class='desc-icon' alt='mana' />. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Knockback per <img src='../icons/potency8.png' class='desc-icon' alt='potency' />.\nSoftlight (nullify in moonlight)\n<em>An art developed for war. Holding brings forth conviction, or doubt.</em>",
    image: "cards/fronts/440.webp"
  },
  "Sparkle": {
    name: "Sparkle",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "mana", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Toss a handful of diamond dust, floats in the air. Upon contact, victims receive 1 damage and are stunned for 1 duration.\n<em>An art developed for war. Holding brings forth conviction, or doubt.</em>",
    image: "cards/fronts/441.webp"
  },
  "Spiralis": {
    name: "Spiralis",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "stamina", "amount": 1}, {"type": "mana", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Shoot out tendrils of light, whipping out in a clockwise pattern. Upon contact, draw targets closer to you with force based on <img src='../icons/skl.png' class='desc-icon' alt='skl' />.\n<em>The right-hand-rule applies to the strangest of things.</em>",
    image: "cards/fronts/442.webp"
  },
  "Flash": {
    name: "Flash",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "mana", "amount": 3}, {"type": "stamina", "amount": 1}],
    description: "Dash in a direction, tackling obstacles. \nUpon contact, victims receive increasing damage and knockback. Distance, damage, and knockback are based on <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> & <img src='../icons/skl.png' class='desc-icon' alt='skl' />. Tinge 11: Quick.\n<em>Apex and zenith blur together at such extreme speed.</em>",
    image: "cards/fronts/443.webp"
  },
  "Intercept": {
    name: "Intercept",
    primaryType: "Quick Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Catch any spell. \nRedirect spell to any target.\n<em>Requires a tremendous \namount of focus. Focus!</em>",
    image: "cards/fronts/445.webp"
  },
  "Scorching Ray": {
    name: "Scorching Ray",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 4}],
    description: "Funnel an eye of sun. Always acts.\n<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Consume 1 <img src='../icons/mana1.png' class='desc-icon' alt='mana' /> and deal 1 damage each turn. Increase damage steadily, up to a maximum of <img src='../icons/potency8.png' class='desc-icon' alt='potency' />. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Dismiss Scorching Ray.\n<em>Feel the heat!</em>",
    image: "cards/fronts/446.webp"
  },
  "Field Crush": {
    name: "Field Crush",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "channel", "amount": 0}, {"type": "mana", "amount": 2}],
    description: "Press hands into the ground, and funnel <img src='../icons/mana1.png' class='desc-icon' alt='mana' /> into surrounding area. After a time, launch nearby targets into the air, based on Tinge.\n<em>Why hit with light when you could strike with the world?</em>",
    image: "cards/fronts/448.webp"
  },
  "Fingers Of Flame": {
    name: "Fingers Of Flame",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 3}],
    description: "Emit embers of flame from fingertips. Burn <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> damage. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Spread fire.\n<em>Concentrating the sun's warmth to such a small point results in combustion. Ouch.</em>",
    image: "cards/fronts/450.webp"
  },
  "Eruption": {
    name: "Eruption",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 4}],
    description: "Press hands into the ground, summon a burst of fire from a connected surface. Distance, size, and damage of pillar is based on Tinge.\n<em>Allow your collected heat to ebb out and rip through the world.</em>",
    image: "cards/fronts/452.webp"
  },
  "Flamelick": {
    name: "Flamelick",
    primaryType: "Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 3}],
    description: "Summon a whip of fire, inflict 2 burn per hit. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Repeat for each <img src='../icons/skl.png' class='desc-icon' alt='skl' />. \n\nSkill <img src='../icons/skl.png' class='desc-icon' alt='skl' /> 3: Manoeuvre.\n<em>The terrifying sound it makes drowns out the smells of burning grass and flesh.</em>",
    image: "cards/fronts/454.webp"
  },
  "Fire Shot": {
    name: "Fire Shot",
    primaryType: "Quick Spellcast",
    secondaryType: "Light",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Inflict burn, damage and duration is based on <img src='../icons/potency8.png' class='desc-icon' alt='potency' />. Nullify target's armour <img src='../icons/armour.svg' class='desc-icon' alt='armour' /> and shields <img src='../icons/mshield.svg' class='desc-icon' alt='shield' />. \nPay <img src='../icons/empower1.png' class='desc-icon' alt='empower' />: Cast twice.\n<em>Renders most metals useless.</em>",
    image: "cards/fronts/456.webp"
  },
  "Green Fever": {
    name: "Green Fever",
    primaryType: "Enchantment",
    secondaryType: "Nature",
    cost: [{"type": "life", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Increase physicks by X; \nremove bleed, poison, or toxic. \nDuration is equal to <img src='../icons/madness.png' class='desc-icon' alt='madness' />. Gain <img src='../icons/madness.png' class='desc-icon' alt='madness' /> when effect ends.\n<em>Nothing is more ferocious than\nmother nature's wrath.</em>",
    image: "cards/fronts/457.webp"
  },
  "Wild Eyes": {
    name: "Wild Eyes",
    primaryType: "Enchantment",
    secondaryType: "Nature",
    cost: [{"type": "life", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Improve magicks by X; \nremove dread, stun, or panic.\nDuration is equal to <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\nGain <img src='../icons/madness.png' class='desc-icon' alt='madness' /> when effect ends.\n<em>You get a little mean \nwhen you start seeing green.</em>",
    image: "cards/fronts/458.webp"
  },
  "Conceal": {
    name: "Conceal",
    primaryType: "Quick Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "stamina", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Coerce nearby vegetation to hide presence; very effective outdoors. \nIf undetected or unseen when cast, refund <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' />.\n<em>Look not here for I, \nfor here I am not.</em>",
    image: "cards/fronts/460.webp"
  },
  "Listen": {
    name: "Listen",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}, {"type": "stamina", "amount": 1}],
    description: "Silence the symphony around you, and let the world speak. \nIf successful, gain favour during next encounter or event.\n<em>You can hear it too, can't you?</em>",
    image: "cards/fronts/462.webp"
  },
  "Yummify": {
    name: "Yummify",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Enrich the deliciousness of any fruit or vegetable and it provides maximum nutrients or benefits. \nConsume item: Untap <img src='../icons/untap2.png' class='desc-icon' alt='untap' />.\n<em>If only everything good for you \ntasted this amazing!</em>",
    image: "cards/fronts/463.webp"
  },
  "Haze": {
    name: "Haze",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}, {"type": "energy", "amount": 1}],
    description: "Twilight (Cannot be used in \ndirect sunlight or moonlight) \nSummon sticky mist to cover position. Remove <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' /> from actions. Reduce all detection within mist.\n<em>Unseen. Unidentified. Unknown.</em>",
    image: "cards/fronts/464.webp"
  },
  "Bloomgift": {
    name: "Bloomgift",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}],
    description: "Encourage a vegetable or fruit-bearing tree or berry-bush to produce edible items. \nTinge 16: Act again.\n<em>A gift for you, and a gift for me. The fruits of our labour after all?</em>",
    image: "cards/fronts/465.webp"
  },
  "Mend": {
    name: "Mend",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Temporarily heal any target injury or wound; stop bleeding or poison. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Dismiss Mend.\n<em>Bind the flesh in her coil, vines and green abate the bleeding... For now.</em>",
    image: "cards/fronts/466.webp"
  },
  "Rootrope": {
    name: "Rootrope",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Command roots and vines beneath feet to intertwine. Create ropes, bridges, or bindings. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Dismiss Rootrope.\n<em>I asked for help. Amazing how useful things can come from unexpected places.</em>",
    image: "cards/fronts/467.webp"
  },
  "Growth": {
    name: "Growth",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Encourage the foliage around you to grow in a great burst of life. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Affected plants wither.\n<em>This place was once nothing but wilds as far as you could see. All it takes is time.</em>",
    image: "cards/fronts/468.webp"
  },
  "River": {
    name: "River",
    primaryType: "Quick Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "stamina", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Combine <img src='../icons/skl.png' class='desc-icon' alt='skl' /> and <img src='../icons/str.png' class='desc-icon' alt='str' />; move steadily and with flow. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Cleanse hands with clean or flowing water.\n<em>You cannot borrow what nature gives you. These things are sacred, and command your respect.</em>",
    image: "cards/fronts/470.webp"
  },
  "Mountain": {
    name: "Mountain",
    primaryType: "Enchant",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Combine <img src='../icons/str.png' class='desc-icon' alt='str' /> and endurance, then regain that much <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' /> stamina. \nWhenever you have 1 or less <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' /> stamina, resolve madness <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>The summit will remain \nwhen you are forgotten.</em>",
    image: "cards/fronts/472.webp"
  },
  "Breeze": {
    name: "Breeze",
    primaryType: "Quick Enchant",
    secondaryType: "Nature Arts",
    cost: [{"type": "empower", "amount": 1}, {"type": "mana", "amount": 1}, {"type": "stamina", "amount": 1}],
    description: "Become uplifted, reduce weight significantly; glide while falling.\nMomentum is problematic and you become dizzy more easily.\n<em>Falling, slowly, gently... \nlest the winds have other plans.</em>",
    image: "cards/fronts/474.webp"
  },
  "Myceliosum": {
    name: "Myceliosum",
    primaryType: "Quick Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "energy", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Activate local mycofauna effects and spells; or do nothing. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Consume fungal or mushroomic substances.\n<em>The heartbeat of an ancient beast beneath our feet. Humming, calm and foreboding.</em>",
    image: "cards/fronts/475.webp"
  },
  "Bestow Life": {
    name: "Bestow Life",
    primaryType: "Spellcast",
    secondaryType: "Nature Arts",
    cost: [{"type": "life", "amount": 1}],
    description: "Consume half of your current life <img src='../icons/Life1.png' class='desc-icon' alt='life' /> to revive one ally with half of their maximum life <img src='../icons/Life1.png' class='desc-icon' alt='life' />, mana <img src='../icons/mana1.png' class='desc-icon' alt='mana' />, and energy <img src='../icons/energy1.png' class='desc-icon' alt='energy' />.\n<em>I call upon ye from the land of roots and songs, return that which once was lost.</em>",
    image: "cards/fronts/476.webp"
  },
  "Hookshot": {
    name: "Hookshot",
    primaryType: "Spellcast",
    secondaryType: "Adventure Action",
    cost: [{"type": "energy", "amount": 1}, {"type": "stamina", "amount": 1}],
    description: "Pull self across terrain over a distance relative to <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> and <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' />.\n<em>Not usable on all surfaces.</em>",
    image: "cards/fronts/478.webp"
  },
  "Befriend": {
    name: "Befriend",
    primaryType: "Spellcast",
    secondaryType: "Beast Arts",
    cost: [{"type": "life", "amount": 2}, {"type": "stamina", "amount": 1}],
    description: "Attempt to befriend a beast.\nSuccess: Refund <img src='../icons/Life1.png' class='desc-icon' alt='life' />, gain a beastfriend and lose this card.\n<em>You never know until you try!</em>",
    image: "cards/fronts/479.webp"
  },
  "Summon Friend": {
    name: "Summon Friend",
    primaryType: "Spellcast",
    secondaryType: "Beast Arts",
    cost: [{"type": "life", "amount": 3}],
    description: "A beast may come to your aid. \nSuccess: Refund <img src='../icons/Life1.png' class='desc-icon' alt='life' />, gain a beastfriend and lose this card.\n<em>A furry friend never forgets a hand that feeds. Especially if that hand feeds a lot.</em>",
    image: "cards/fronts/480.webp"
  },
  "Embolden": {
    name: "Embolden",
    primaryType: "Spellcast",
    secondaryType: "Beast Arts",
    cost: [{"type": "life", "amount": 1}],
    description: "Empower summoned beast; \nif possible, it must switch forme. Beast gains quick and favour, and must act immediately.\n<em>There will come a time when such an act of heroism will be its last.</em>",
    image: "cards/fronts/481.webp"
  },
  "Mend Friend": {
    name: "Mend Friend",
    primaryType: "Spellcast",
    secondaryType: "Beast Arts",
    cost: [{"type": "life", "amount": 2}, {"type": "stamina", "amount": 1}],
    description: "Fully heal a summoned beast.\nTinge 13: For the next 1 duration, this beast takes no damage.\n<em>The bond between us and beasts is a thing of beauty... and patience.</em>",
    image: "cards/fronts/484.webp"
  },
  "Protect": {
    name: "Protect",
    primaryType: "Quick Action",
    secondaryType: "Beast Arts",
    cost: [{"type": "stamina", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "If you would sustain damage, swap places with beast friend, and the beast friend receives damage instead.\n<em>In our time of need, our furry friends \ndon't need to think twice.</em>",
    image: "cards/fronts/485.webp"
  },
  "Guardian": {
    name: "Guardian",
    primaryType: "Quick Action",
    secondaryType: "Beast Arts",
    cost: [{"type": "life", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "If beast friend would sustain damage, swap places with beast friend, and you receive the damage.\n<em>Even protectors need protectin'!</em>",
    image: "cards/fronts/486.webp"
  },
  "Innervate": {
    name: "Innervate",
    primaryType: "Enchant",
    secondaryType: "Potency",
    cost: [{"type": "channel", "amount": 0}, {"type": "mana", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Add 3 to physicks for 3 duration. \nPay <img src='../icons/stamina1.png' class='desc-icon' alt='stamina' />: Maintain Innervate duration.\nTinge 22: Cost is <img src='../icons/mana1.png' class='desc-icon' alt='mana' /><img src='../icons/mana1.png' class='desc-icon' alt='mana' />{1}.\n<em>Focus. Rejuvenate. Unleash.</em>",
    image: "cards/fronts/488.webp"
  },
  "Evoke": {
    name: "Evoke",
    primaryType: "Spellcast",
    secondaryType: "Potency",
    cost: [{"type": "empower", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Empower next light spell. \n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Sleep, or gain <img src='../icons/madness.png' class='desc-icon' alt='madness' />. \nTinge 15: Empower any spell.\n<em>Burn brightly that fire within.</em>",
    image: "cards/fronts/490.webp"
  },
  "Amplify": {
    name: "Amplify",
    primaryType: "Enchantment",
    secondaryType: "Potency",
    cost: [{"type": "empower", "amount": 2}],
    description: "Attach to a spell: \nIgnore requirements & negatives. \n(e.g. Cast Hardlight or Dim spells normally; ignore moonlight negations; etcetera.)\n<em>Burn a bit of the soul.</em>",
    image: "cards/fronts/492.webp"
  },
  "Spellsurge": {
    name: "Spellsurge",
    primaryType: "Enchantment",
    secondaryType: "Potency",
    cost: [{"type": "empower", "amount": 2}],
    description: "Attach to a spell: \nIncrease all values by 1. \nIf the spell does not list any damage or block values, it now deals or blocks 1 damage.\n<em>Use wisely. Or not.</em>",
    image: "cards/fronts/494.webp"
  },
  "Detect Magic": {
    name: "Detect Magic",
    primaryType: "Spellcast",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "Momentarily reveal magical traps, energies, and other secrets. \nArcane 6: \nPay <img src='../icons/mana1.png' class='desc-icon' alt='mana' /> or <img src='../icons/energy1.png' class='desc-icon' alt='energy' />, lasts until you sleep.\n<em>My senses are tingling...</em>",
    image: "cards/fronts/496.webp"
  },
  "Arcane Touch": {
    name: "Arcane Touch",
    primaryType: "Enchant",
    secondaryType: "Arcane Action",
    cost: [{"type": "energy", "amount": 1}],
    description: "Infuse the skin with arcane energy, transfer energy upon contact. \nActivate arcane relics. \nArcane 5: Snap fingers and return the <img src='../icons/energy1.png' class='desc-icon' alt='energy' /> to you, refunding the cost.\n<em>Long ago, the arcane was everywhere. Now, it's all gone... far away.</em>",
    image: "cards/fronts/497.webp"
  },
  "Arcane Blast": {
    name: "Arcane Blast",
    primaryType: "Spellcast",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 1}, {"type": "mana", "amount": 1}],
    description: "Deal 2 damage; knockback. Activates arcane relics. \n<img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> 3: Add <img src='../icons/potency8.png' class='desc-icon' alt='potency' />. \nArcane 6: Cast again for <img src='../icons/energy1.png' class='desc-icon' alt='energy' />.\n<em>Shot at incredible speed, this single straight line flies as if it yearns for somewhere else to be.</em>",
    image: "cards/fronts/500.webp"
  },
  "Arcane Shock": {
    name: "Arcane Shock",
    primaryType: "Spellcast",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 2}, {"type": "stamina", "amount": 1}],
    description: "Deal 1 damage to nearby targets. Activate nearby arcane relics. \n<img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> 3: Base damage is now <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' />.\nArcane 8: Cast again for <img src='../icons/energy1.png' class='desc-icon' alt='energy' />.\n<em>Crackling through the air, seeking.</em>",
    image: "cards/fronts/503.webp"
  },
  "Arcane Walk": {
    name: "Arcane Walk",
    primaryType: "Spellcast",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 1}, {"type": "stamina", "amount": 1}],
    description: "While moving: Leave a trail of ethereal footprints, for a time. \nWhen you stop moving, the footprints create a slippery path. \n<img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> 3: Activate arcane relics.\n<em>Tendrils pour out tenderly, waiting.</em>",
    image: "cards/fronts/506.webp"
  },
  "Levitate": {
    name: "Levitate",
    primaryType: "Enchantment",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 3}],
    description: "Lift self delicately and walk in the air, about 10cm high. \nAny damage ends the effect.\nArcane 10: Hover 1 meter.\n<em>Feels like skating but way more fun-- \nand way more dangerous!</em>",
    image: "cards/fronts/508.webp"
  },
  "Magnetohazard": {
    name: "Magnetohazard",
    primaryType: "Spellcast",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 1}, {"type": "mana", "amount": 1}, {"type": "empower", "amount": 1}],
    description: "Apply Arcane Touch twice, you may magnetize those things together or apart.\n<img src='../icons/slow4.png' class='desc-icon' alt='channel' />: Amplify magnetic force.\n<em>With a simple clap, you can momentarily marry things. Useful.</em>",
    image: "cards/fronts/510.webp"
  },
  "Arcfield": {
    name: "Arcfield",
    primaryType: "Spellcast",
    secondaryType: "Arcane",
    cost: [{"type": "energy", "amount": 2}, {"type": "stamina", "amount": 1}, {"type": "empower", "amount": 1}/*, {"type": "generic", "amount": 0}*/],
    description: "The surrounding area becomes infused with unstable energy. Spells cast within this area are cast at maximum Tinge or Arcane.\n<em>Ancient forces are ambivalent to our struggles. A raindrop in the ocean.</em>",
    image: "cards/fronts/511.webp"
  },
  "Shadowshock": {
    name: "Shadowshock",
    primaryType: "Quick Spellcast",
    secondaryType: "Madness Magic",
    cost: [/*{"type": "generic", "amount": 2}*/],
    description: "Twilight (Cannot be used in \ndirect sunlight or moonlight) \nReduce target life, power, or other stat equal to your current <img src='../icons/madness.png' class='desc-icon' alt='madness' />. \nLose this card or resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>The lingering feeling as if touched \nby a sneer made of oil.</em>",
    image: "cards/fronts/513.webp"
  },
  "Cursewax": {
    name: "Cursewax",
    primaryType: "Spellcast",
    secondaryType: "Madness Magic",
    cost: [/*{"type": "generic", "amount": 3}*/],
    description: "Twilight (Cannot be used in direct sunlight or moonlight) \nConjure a bespoke curse. \nLose this card or resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>Necessary acts are sometimes grotesque.</em>",
    image: "cards/fronts/515.webp"
  },
  "Uneasy Feeling": {
    name: "Uneasy Feeling",
    primaryType: "Spellcast",
    secondaryType: "Madness Magic",
    cost: [/*{"type": "generic", "amount": 2}*/],
    description: "Reduce, lower, or diminish something by the number of curses active among all players. \nLose this card or resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>That sinking feel won't go away? \nOh no...</em>",
    image: "cards/fronts/516.webp"
  },
  "Mind Thorn": {
    name: "Mind Thorn",
    primaryType: "Enchantment",
    secondaryType: "Madness Magic",
    cost: [/*{"type": "generic", "amount": 2}*/],
    description: "Afflict target with a phobia, with duration counters equal to remaining <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\nLose this card or resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>Can you feel the creep and crawl? \nThe breath against your ear?</em>",
    image: "cards/fronts/517.webp"
  },
  "Siphon Seal": {
    name: "Siphon Seal",
    primaryType: "Enchantment",
    secondaryType: "Madness Seal",
    cost: [{"type": "generic", "amount": 4}],
    description: "You cannot heal normally. \nIf target loses life, regain life. \nDismiss Siphon Seal:\nLose this card or resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>The circle of life is sometimes sinister.</em>",
    image: "cards/fronts/518.webp"
  },
  "Chiral Trepidations": {
    name: "Chiral Trepidations",
    primaryType: "Enchant",
    secondaryType: "Madness Magic",
    cost: [/*{"type": "generic", "amount": 3}, */{"type": "mana", "amount": 2}, {"type": "energy", "amount": 2}],
    description: "Instead of paying the last three costs in a spell, resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />. \nThis cannot affect the first cost. \nDismiss Chiral Trepidations:\nLose this card or resolve <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>It feels as if you've been split in twain \nby a mirror.</em>",
    image: "cards/fronts/520.webp"
  },
  "Nightmare Expansion": {
    name: "Nightmare Expansion",
    primaryType: "Spellcast",
    secondaryType: "Madness Magic",
    cost: [/*{"type": "generic", "amount": 0}*/],
    description: "Consume all remaining <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\nYou must reduce that many non-cursed targets' life to 1, then inflict terror on those targets. Lose this card if you targeted yourself.\n<em>Something evil lurks within us all.\nHere it comes.</em>",
    image: "cards/fronts/521.webp"
  },
  "Magick Missile": {
    name: "Magick Missile",
    primaryType: "Spellcast",
    secondaryType: "Beyond",
    cost: [{"type": "energy", "amount": 2}, {"type": "mana", "amount": 2}/*, {"type": "generic", "amount": 0}*/],
    description: "Swift (Cannot miss) \nDeal damage equal to combined <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> and <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' />, or divide that damage across many targets.\n<em>Best when wielded \nagainst the unwise.</em>",
    image: "cards/fronts/523.webp"
  },
  "Moonlake Handsign": {
    name: "Moonlake Handsign",
    primaryType: "Spellcast",
    secondaryType: "Beyond",
    cost: [/*{"type": "generic", "amount": 0}, */{"type": "mana", "amount": 1}],
    description: "Convert all light in area into moonlight. Any light spell or enchantment cast gains dim.\nEmpower wormridden things.\n<em>Those on the moon watch us carefully, and will send aid to their children.</em>",
    image: "cards/fronts/525.webp"
  },
  "Wormbolt": {
    name: "Wormbolt",
    primaryType: "Spellcast",
    secondaryType: "Beyond",
    cost: [/*{"type": "generic", "amount": 2}, */{"type": "energy", "amount": 1}],
    description: "Moonbless: Swift.\nHurl a festering ball of worm eggs that explode on impact.\nInflict slime.\n<em>A brief putrid stench accompanies this horrific blast of vile energy.</em>",
    image: "cards/fronts/527.webp"
  },
  "Wormiousness": {
    name: "Wormiousness",
    primaryType: "Spellcast",
    secondaryType: "Beyond",
    cost: [/*{"type": "generic", "amount": 3}, */{"type": "empower", "amount": 1}],
    description: "Moonbless:\nPay {1} instead of <img src='../icons/empower1.png' class='desc-icon' alt='empower' />.\nGain shield <img src='../icons/mshield.svg' class='desc-icon' alt='shield' /> equal to <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\nLose half <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>Adapt and overcome.\nEvolve and overwhelm.</em>",
    image: "cards/fronts/529.webp"
  },
  "Tentacle": {
    name: "Tentacle",
    primaryType: "Enchantment",
    secondaryType: "Beyond",
    cost: [/*{"type": "generic", "amount": 0}, */{"type": "empower", "amount": 1}, {"type": "life", "amount": 1}, {"type": "stamina", "amount": 1}],
    description: "After initial cast, you may pay life <img src='../icons/Life1.png' class='desc-icon' alt='life' /> to grow more and extend the length of tentacles.\nMoonbless: Double tentacles.\n<em>The pain oozes away. It feels as if you have always been this way. So natural.</em>",
    image: "cards/fronts/531.webp"
  },
  "Smile and Nod": {
    name: "Smile and Nod",
    primaryType: "Legendary Enchantment",
    secondaryType: "Skill",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Focus on a target: \nReduce power by your <img src='../icons/potency8.png' class='desc-icon' alt='potency' />.\nAdd <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> to patience or interest.\n<em>First impressions are important.</em>",
    image: "cards/fronts/532.webp"
  },
  "Socks": {
    name: "Socks",
    primaryType: "Legendary Enchantment",
    secondaryType: "Skill",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "When wearing only the socks:\nMake no sound when moving.\nWalk across still water, leaves, etc.\nNullifies 99% of physical force.\nRemove socks: Gain <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>Walking on eggshells? \nEasy. Very easy.</em>",
    image: "cards/fronts/533.webp"
  },
  "Glove": {
    name: "Glove",
    primaryType: "Legendary Enchantment",
    secondaryType: "Skill",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Intercept projectiles and some weapons aimed at the bearer.\nPointing terrifies most beasts.\nNullifies 90% of physical force.\nRemove glove: Gain <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>If a mountain fell, \nthe glove may refuse.</em>",
    image: "cards/fronts/534.webp"
  },
  "Make-a-Blade": {
    name: "Make-a-Blade",
    primaryType: "Legendary Quick Spell",
    secondaryType: "Skill",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Reshape the blade like clay rubber.\nThe bearer can extend or retract the blade or handle grip at will.\nWhistle, snap, or clap: Reset blade.\n<em>Maintains any shape, \nas per the bearer.</em>",
    image: "cards/fronts/535.webp"
  },
  "Fencing Forme": {
    name: "Fencing Forme",
    primaryType: "Legendary Enchantment",
    secondaryType: "Skill",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Reshape into a proficient weapon.\nParry most melee weapons freely.\n<img src='../icons/tap2.png' class='desc-icon' alt='tap' />: Slay, then reset Trickblade.\n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Apologize, or gain <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>Mighty, but fearful of cats.</em>",
    image: "cards/fronts/536.webp"
  },
  "Heatsoul": {
    name: "Heatsoul",
    primaryType: "Legendary Enchantment",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Affect body temperature during actions or events; \nboil water with palms, etc.\nControl flames and combustion.\nSummon anything sacrificed.\n<em>We see it in your eyes, \nthat fire within.</em>",
    image: "cards/fronts/537.webp"
  },
  "Coldsoul": {
    name: "Coldsoul",
    primaryType: "Legendary Enchantment",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Affect body temperature during actions or events; freeze water, etc.\nReduce any incoming damage taken.\nChange local zone weather.\nInterrupt some magic.\n<em>Regal and pure, \nsnow on the mountain.</em>",
    image: "cards/fronts/538.webp"
  },
  "Gaze and Influence": {
    name: "Gaze and Influence",
    primaryType: "Legendary Enchantment",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "While fixing eyes on a target: Influence their mood or thoughts.\nAlter their prowess by your own <img src='../icons/potency8.png' class='desc-icon' alt='potency' /> or <img src='../icons/mastery4.png' class='desc-icon' alt='mastery' /> or <img src='../icons/str.png' class='desc-icon' alt='str' /> or <img src='../icons/skl.png' class='desc-icon' alt='skl' />.\n<em>Eyes are a window to the soul, \nmakes for an easy heist.</em>",
    image: "cards/fronts/539.webp"
  },
  "Mundane": {
    name: "Mundane",
    primaryType: "Legendary Action",
    secondaryType: "",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Flip a coin: Lose, gain <img src='../icons/madness.png' class='desc-icon' alt='madness' /> and <img src='../icons/tap2.png' class='desc-icon' alt='tap' /> tap. \nWin, choose one:\nThrow, deal no damage, distract.\nAny one action cannot fail.\nReturn to senses, remove 1 ailment.\nSpend the coin to <img src='../icons/untap2.png' class='desc-icon' alt='untap' /> untap.\n<em>The usefulness is a matter of \nspace and time.</em>",
    image: "cards/fronts/540.webp"
  },
  "Ignite": {
    name: "Ignite",
    primaryType: "Legendary Quick Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Engulf the whole body or a single part in flame for a short time, \nthen you may:\nMaintain immolation.\nBillow and manipulate smoke.\n<em>This dark power... may your fiery imagination burn brightly.</em>",
    image: "cards/fronts/541.webp"
  },
  "Fingers of Frost": {
    name: "Fingers of Frost",
    primaryType: "Legendary Quick Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Calms and soothes the nature of some entities. Things touched will slowly cool down and freeze.\nCan be used as a quick reaction.\n<em>Eventually, winter kills everything.</em>",
    image: "cards/fronts/542.webp"
  },
  "Futuresight Glance": {
    name: "Futuresight Glance",
    primaryType: "Legendary Quick Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "See into the near future: \nYou may perform any other action immediately, and it becomes perfect or true.\n<em>Free will is a matter of perspective.</em>",
    image: "cards/fronts/543.webp"
  },
  "Fireball": {
    name: "Fireball",
    primaryType: "Legendary Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Conjure a Flaming Orb. \nDeal damage, with a chance to explode or ignite.\nUser may snuff out flames.\n<em>Fire. Beautiful. Devastating.</em>",
    image: "cards/fronts/544.webp"
  },
  "Frostbolt": {
    name: "Frostbolt",
    primaryType: "Legendary Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Conjure an Ice Lance. \nDeal true damage, spreading frost over time. \nUser may consume frost.\n<em>You cannot outrun the cold.</em>",
    image: "cards/fronts/545.webp"
  },
  "Pour": {
    name: "Pour",
    primaryType: "Legendary Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Pour any liquid substance.\nEmit any sound for a time.\nGain <img src='../icons/madness.png' class='desc-icon' alt='madness' />: Change substance.\n<em>Holding it grants a great sense of direction, but gets you a bit tipsy. Ha!</em>",
    image: "cards/fronts/546.webp"
  },
  "Scan": {
    name: "Scan",
    primaryType: "Legendary Spell",
    secondaryType: "Magick",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Choose one:\nUnderstand written words.\nDiscern a face's true intent. \nKnow the nature of the unfamiliar.\n<em>The world has always \nbeen this way.</em>",
    image: "cards/fronts/547.webp"
  },
  "Scribe": {
    name: "Scribe",
    primaryType: "Legendary Action",
    secondaryType: "",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Write in the book. What is writ was, is, or will be true...\nClose the book: Remove <img src='../icons/madness.png' class='desc-icon' alt='madness' />.\n<em>Book and pen are well-loved. Upon the first page \"Dear Scathe,\" is written.</em>",
    image: "cards/fronts/548.webp"
  },
  "Luck": {
    name: "Luck",
    primaryType: "Legendary Quick Action",
    secondaryType: "",
    cost: [{"type": "coalesce", "amount": 1}],
    description: "Flip coin, if you lose: Tap <img src='../icons/tap2.png' class='desc-icon' alt='tap' />.\nIf you win: \nResolve anything to your whim.\n<img src='../icons/untap2.png' class='desc-icon' alt='untap' />: Spend the coin.\n<em>In the end, \nmoney and fate are useless.</em>",
    image: "cards/fronts/549.webp"
  },
  // Flicker and Whisper - starter spells for certain Iris types
  "MISSINGNO": {
    name: "MISSINGNO NAMEFIELD",
    primaryType: "MISSINGNo PRIMARY TYPE",
    secondaryType: "Missingno Secondary Type",
    cost: [{ type: "life", amount: 1 },{ type: "stamina", amount: 1 },{ type: "mana", amount: 1 },{ type: "energy", amount: 1 },{ type: "empower", amount: 1 }],
    description: "Turn invisible then shadow-step a moderate distance. If you attack or take damage, lose invisibility, become stunned, halve all resource pools.\n<em>Now you see me...</em>",
    image: "../icons/999.webp"
  }
};

// Artefact to Legendary Spell mapping (532-549 range)
// Artefact to Legendary Spell(s) mapping - some artefacts grant multiple legendary spells
const ARTEFACT_LEGENDARY_SPELLS = {
  "The Bronze Ring of Smiles": [
    { id: 532, name: "Smile and Nod" },
    { id: 539, name: "Gaze and Influence" }
  ],
  "The Pair and a Half": [
    { id: 533, name: "Socks" },
    { id: 534, name: "Glove" }
  ],
  "The Trickblade": [
    { id: 535, name: "Make-a-Blade" },
    { id: 536, name: "Fencing Forme" }
  ],
  "The Darkflame": [
    { id: 537, name: "Heatsoul" },
    { id: 541, name: "Ignite" },
    { id: 544, name: "Fireball" }
  ],
  "The Wintergrace": [
    { id: 538, name: "Coldsoul" },
    { id: 542, name: "Fingers of Frost" },
    { id: 545, name: "Frostbolt" }
  ],
  "The Coin": [
    { id: 540, name: "Mundane" },
    { id: 549, name: "Luck" }
  ],
  "The Prismatic Glasses": [
    { id: 543, name: "Futuresight Glance" },
    { id: 547, name: "Scan" }
  ],
  "The Fisherman's Flask": [
    { id: 546, name: "Pour" }
  ],
  "Scathe's Memo Book": [
    { id: 548, name: "Scribe" }
  ],
  "The Wand": [] // The Wand has no legendary spells - allows any non-legendary spell to be slotted instead
};

// Track which legendary spells were originally assigned to the player
// This ensures they can only relearn spells from their artefact's pool
let assignedLegendarySpells = loadState('assignedLegendarySpells', {});

let spells = loadState('spells', []);
let mindOpen = false;
let castWarningDisabled = loadState('castWarningDisabled', false);

// Check if player has soulbound artefact and iris
function hasSoulboundAndIris() {
  return inventory[0]?.name && inventory[1]?.name;
}

// Get current Iris name
function getCurrentIris() {
  return inventory[1]?.name || '';
}

// Get current Soulbound Artefact name
function getCurrentArtefact() {
  return inventory[0]?.name || '';
}

// Update mind button state
function updateMindButtonState() {
  const allowed = hasSoulboundAndIris();
  mindBtn.classList.toggle('disabled', !allowed);
}

// Calculate spell slot configuration based on Iris
function getSpellSlotConfig() {
  const iris = getCurrentIris();
  const artefact = getCurrentArtefact();
  const mastery = Number(loadState('Mastery', 0)) || 0;
  const potency = Number(loadState('Potency', 0)) || 0;
  
  // Pair and a Half grants 2 legendary spell slots
  const legendarySlotOverride = (artefact === "The Pair and a Half") ? 2 : null;
  
  if (iris === "Softly Strange Violet") {
    // Violet: 2 legendary (or override), 2 starter (Arclight + Replenish), mastery+potency additional
    return {
      legendarySlots: legendarySlotOverride || 2,
      starterSlots: 2,
      starterSpells: ["Arclight", "Replenish"],
      flexSlots: mastery + potency,
      fixedTotal: false
    };
  } else if (iris === "Otherworldly Odd") {
    // Odd: 1 legendary (or override), 3 prefilled (Arclight, Replenish, Veil), 2 empty = 6 total
    return {
      legendarySlots: legendarySlotOverride || 1,
      starterSlots: 5, // 3 prefilled + 2 empty
      starterSpells: ["Arclight", "Replenish", "Veil"],
      flexSlots: 0,
      fixedTotal: true,
      totalSlots: (legendarySlotOverride || 1) + 5 // Adjust total if legendary slots change
    };
  } else {
    // Default: 1 legendary (or override), 1 starter (Arclight), max(mastery, potency) additional
    return {
      legendarySlots: legendarySlotOverride || 1,
      starterSlots: 1,
      starterSpells: ["Arclight"],
      flexSlots: Math.max(mastery, potency),
      fixedTotal: false
    };
  }
}

// Calculate total max spell slots
function getMaxSpellSlots() {
  const config = getSpellSlotConfig();
  if (config.fixedTotal) {
    return config.totalSlots;
  }
  return config.legendarySlots + config.starterSlots + config.flexSlots;
}

// Get number of legendary slots
function getLegendarySlotCount() {
  return getSpellSlotConfig().legendarySlots;
}

function getCurrentSpellCount() {
  return spells.filter(s => s?.name).length;
}

function updateAddSpellButtonState() {
  const config = getSpellSlotConfig();
  const maxSlots = getMaxSpellSlots();
  const legendaryCount = getLegendarySlotCount();
  const regularMax = maxSlots - legendaryCount;
  const regularCurrent = spells.slice(legendaryCount).filter(s => s?.name).length;
  const full = regularCurrent >= regularMax;
  
  // Don't disable button - keep it bright and clickable at all times
  addSpellBtn.innerHTML = full 
    ? 'Mind Full - Improve Mastery/Potency' 
    : '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Learn New Spell';
}

// Fuzzy spell lookup (case-insensitive)
/* ========= IMPROVED FUZZY MATCHING ========= */
// Enhanced fuzzy search that matches partial strings from the beginning
function fuzzyMatch(database, searchTerm) {
  if (!searchTerm) return null;
  const searchLower = searchTerm.toLowerCase().trim();
  
  // 1. Exact match (case-insensitive)
  for (const [key, data] of Object.entries(database)) {
    if (key.toLowerCase() === searchLower) {
      return { key, data };
    }
  }
  
  // 2. Starts with match (e.g., "Mur" matches "Murky Elixir")
  for (const [key, data] of Object.entries(database)) {
    if (key.toLowerCase().startsWith(searchLower)) {
      return { key, data };
    }
  }
  
  // 3. Word starts with match (e.g., "Fev" matches "Feverspin Crimson")
  for (const [key, data] of Object.entries(database)) {
    const words = key.toLowerCase().split(' ');
    if (words.some(word => word.startsWith(searchLower))) {
      return { key, data };
    }
  }
  
  // 4. Contains match (e.g., "dark" matches "Beastblood Elixir" if it contains "dark")
  for (const [key, data] of Object.entries(database)) {
    if (key.toLowerCase().includes(searchLower)) {
      return { key, data };
    }
  }
  
  return null;
}

function findSpellByName(name) {
  if (!name) return null;
  const result = fuzzyMatch(spellDB, name);
  return result ? { ...result.data, name: result.key } : null;
}

// Render cost as icons
function renderCostIcons(cost) {
  if (!cost || !Array.isArray(cost)) return '';
  
  return cost.map(c => {
    const iconPath = COST_ICONS[c.type] || COST_ICONS.generic;
    const amount = c.amount || 1;
    
    if (c.type === 'x') {
      return `<span class="cost-item cost-x" data-type="x"><img src="${iconPath}" alt="X" class="cost-icon" /><span class="cost-amount">X</span></span>`;
    } else if (c.type === 'generic') {
      return `<span class="cost-item cost-generic" data-type="generic"><img src="${iconPath}" alt="Any" class="cost-icon" /><span class="cost-amount">${amount}</span></span>`;
    } else {
      let icons = '';
      for (let i = 0; i < amount; i++) {
        icons += `<img src="${iconPath}" alt="${c.type}" class="cost-icon" title="${c.type}" />`;
      }
      return `<span class="cost-item" data-type="${c.type}">${icons}</span>`;
    }
  }).join('');
}

// Check if player can afford spell cost

// Deduct spell cost from resources

// Check if cost has variable components (X or generic)
function hasVariableCost(cost) {
  if (!cost || !Array.isArray(cost)) return { hasX: false, hasGeneric: false };
  return {
    hasX: cost.some(c => c.type === 'x'),
    hasGeneric: cost.some(c => c.type === 'generic')
  };
}

mindBtn.onclick = () => {
  if (!hasSoulboundAndIris()) {
    alert('Your mind cannot open without a Soulbound Artefact and Iris. Add them in your Inventory first.');
    return;
  }
  mindOpen = !mindOpen;
  mindOverlay.classList.toggle('visible', mindOpen);
  mindBtn.classList.toggle('active', mindOpen);
  if (mindOpen) {
    initializeSpells();
    renderSpells();
  }
};

mindOverlay.addEventListener('click', (e) => {
  if (e.target === mindOverlay) {
    mindOpen = false;
    mindOverlay.classList.remove('visible');
    mindBtn.classList.remove('active');
  }
});

// Initialize spells based on Iris configuration
function initializeSpells() {
  const config = getSpellSlotConfig();
  const legendaryCount = config.legendarySlots;
  const totalSlots = getMaxSpellSlots();
  const artefact = getCurrentArtefact();
  
  // Ensure we have the minimum slots
  while (spells.length < totalSlots) {
    spells.push({});
  }
  
  // Initialize legendary slots based on artefact type
  const legendarySpellList = ARTEFACT_LEGENDARY_SPELLS[artefact] || [];
  
  // Special handling for "The Wand" - allows any non-legendary spell with coalesce cost
  if (artefact === "The Wand") {
    // The Wand doesn't auto-assign legendary spells
    // Players can manually enter any non-legendary spell name
    // The cost will be handled specially in saveSpell
    for (let i = 0; i < legendaryCount; i++) {
      if (!spells[i]?.name) {
        spells[i] = {
          name: "",
          isLegendary: true,
          isWandSlot: true // Special flag for Wand slots
        };
      }
    }
  }
  // Special handling for "The Pair and a Half" - grants both legendary spells
  else if (artefact === "The Pair and a Half" && legendarySpellList.length === 2) {
    // Assign both spells to the two legendary slots
    for (let i = 0; i < 2; i++) {
      if (!spells[i]?.name && legendarySpellList[i]) {
        const legendarySpell = legendarySpellList[i];
        const spellData = spellDB[legendarySpell.name];
        
        if (spellData) {
          spells[i] = {
            ...spellData,
            isLegendary: true
          };
        } else {
          spells[i] = {
            name: legendarySpell.name,
            id: legendarySpell.id,
            image: `cards/fronts/${legendarySpell.id}.webp`,
            primaryType: "Legendary Spell",
            secondaryType: "",
            description: "A legendary spell granted by your Soulbound Artefact.",
            cost: [{ type: "coalesce", amount: 1 }],
            isLegendary: true
          };
        }
        
        // Track the assigned spell
        if (!assignedLegendarySpells[artefact]) {
          assignedLegendarySpells[artefact] = [];
        }
        if (!assignedLegendarySpells[artefact].includes(legendarySpell.name)) {
          assignedLegendarySpells[artefact].push(legendarySpell.name);
        }
      }
    }
  }
  // Normal artefacts - randomly assign one legendary spell from the pool
  else if (legendarySpellList.length > 0) {
    // Check if we've already assigned legendary spells for this artefact
    if (!assignedLegendarySpells[artefact] || assignedLegendarySpells[artefact].length === 0) {
      // First time - randomly select one spell from the pool
      const randomIndex = Math.floor(Math.random() * legendarySpellList.length);
      const selectedSpell = legendarySpellList[randomIndex];
      
      // Save this as the assigned spell for this artefact
      assignedLegendarySpells[artefact] = [selectedSpell.name];
      saveState('assignedLegendarySpells', assignedLegendarySpells);
      
      console.log(`Randomly assigned legendary spell for ${artefact}: ${selectedSpell.name}`);
    }
    
    // Initialize legendary slots with assigned spells
    for (let i = 0; i < legendaryCount; i++) {
      if (!spells[i]?.name && assignedLegendarySpells[artefact] && assignedLegendarySpells[artefact][i]) {
        const assignedSpellName = assignedLegendarySpells[artefact][i];
        const legendarySpell = legendarySpellList.find(s => s.name === assignedSpellName);
        
        if (legendarySpell) {
          const spellData = spellDB[legendarySpell.name];
          if (spellData) {
            spells[i] = {
              ...spellData,
              isLegendary: true
            };
          } else {
            spells[i] = {
              name: legendarySpell.name,
              id: legendarySpell.id,
              image: `cards/fronts/${legendarySpell.id}.webp`,
              primaryType: "Legendary Spell",
              secondaryType: "",
              description: "A legendary spell granted by your Soulbound Artefact.",
              cost: [{ type: "coalesce", amount: 1 }],
              isLegendary: true
            };
          }
        }
      }
    }
  }
  
  // Initialize starter spells if empty
  for (let i = 0; i < config.starterSpells.length; i++) {
    const slotIndex = legendaryCount + i;
    if (slotIndex < spells.length && !spells[slotIndex]?.name) {
      const starterName = config.starterSpells[i];
      const starterData = spellDB[starterName];
      if (starterData) {
        spells[slotIndex] = {
          ...starterData,
          prefilled: true // Prefilled but not locked - players can delete these
        };
      }
    }
  }
  
  saveState('spells', spells);
}

function renderSpells() {
  const config = getSpellSlotConfig();
  const maxSlots = getMaxSpellSlots();
  const legendaryCount = config.legendarySlots;
  
  const currentCount = getCurrentSpellCount();
  const capacityEl = document.getElementById('mindCapacity');
  if (capacityEl) {
    const isFull = currentCount >= maxSlots;
    capacityEl.innerHTML = `Spells: <span class="${isFull ? 'capacity-full' : ''}">${currentCount} / ${maxSlots}</span>`;
  }

  spellList.innerHTML = '';
  
  // Render legendary slots
  spellList.innerHTML += `<div class="spell-section-title">Legendary Spell${legendaryCount > 1 ? 's' : ''}</div>`;
  for (let i = 0; i < legendaryCount; i++) {
    spellList.innerHTML += createSpellCard(i, spells[i] || {}, true);
  }
  
  // Render regular slots
  spellList.innerHTML += '<div class="spell-section-title">Regular Spells</div>';
  for (let i = legendaryCount; i < spells.length && i < maxSlots; i++) {
    spellList.innerHTML += createSpellCard(i, spells[i] || {}, false);
  }
  
  bindSpellEvents();
  updateAddSpellButtonState();
}

function createSpellCard(index, data = {}, isLegendary = false) {
  const hasImage = data.image ? 'has-image' : '';
  const isLocked = data.locked ? 'locked' : '';
  const isPrefilled = data.prefilled ? 'prefilled' : '';
  const imgContent = data.image 
    ? `<img src="${data.image}" alt="${data.name || 'Spell'}" />`
    : `<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`;
  
  // Special placeholder for The Wand
  const artefact = getCurrentArtefact();
  let placeholder = isLegendary ? 'NEW LEGENDARY SPELL' : 'NEW SPELL';
  if (isLegendary && artefact === "The Wand") {
    placeholder = 'ENTER ANY NON-LEGENDARY SPELL';
  }
  
  const typeLabel = data.primaryType && data.secondaryType 
    ? `${data.primaryType} — ${data.secondaryType}` 
    : (data.type || (isLegendary ? 'Legendary Spell' : 'Regular Spell'));
  
  const costHtml = data.cost ? renderCostIcons(data.cost) : '';
  const canCast = data.name && canAffordSpell(data.cost);
  const showDelete = !data.locked;
  
  return `
  <div class="spell-slot${isLegendary ? ' legendary' : ''}" data-index="${index}" data-spell-name="${data.name || ''}">
    <div class="spell-left-column">
      <div class="spell-image ${hasImage}">${imgContent}</div>
      ${data.name ? `<button class="spell-cast-btn ${canCast ? '' : 'disabled'}" ${canCast ? '' : 'disabled'}>Cast</button>` : ''}
    </div>
    <div class="spell-info">
      <input class="spell-name ${isLocked}" placeholder="${placeholder}" value="${data.name || ''}" ${isLocked ? 'readonly' : ''} />
      <div class="spell-type">${typeLabel}</div>
      <div class="spell-subtitle">${data.subtitle || ''}</div>
      <div class="spell-description">${data.description || '—'}</div>
      <div class="spell-footer">
        <div class="spell-cost">${costHtml}</div>
      </div>
    </div>
    <button class="spell-confirm-btn"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></button>
    <button class="spell-delete-btn" style="${showDelete ? '' : 'display:none'}"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>`;
}

function bindSpellEvents() {
  document.querySelectorAll('.spell-slot').forEach(card => {
    const index = +card.dataset.index;
    const nameInput = card.querySelector('.spell-name');
    const confirmBtn = card.querySelector('.spell-confirm-btn');
    const deleteBtn = card.querySelector('.spell-delete-btn');
    const castBtn = card.querySelector('.spell-cast-btn');
    const imageDiv = card.querySelector('.spell-image');
    
    // Name input for learning new spells
    nameInput.addEventListener('input', () => {
      const hasChange = nameInput.value.trim() !== (spells[index]?.name || '');
      confirmBtn.classList.toggle('visible', hasChange && nameInput.value.trim().length > 0);
    });
    
    nameInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveSpell(index, nameInput.value.trim());
        nameInput.blur();
      }
    });
    
    confirmBtn.onclick = () => saveSpell(index, nameInput.value.trim());
    
    // Delete (forget) spell
    if (deleteBtn) {
      deleteBtn.onclick = () => {
        const spell = spells[index];
        if (spell?.locked) return;
        const spellName = spell?.name || 'this spell';
        if (confirm(`Forget ${spellName}?`)) {
          spells[index] = {};
          saveState('spells', spells);
          renderSpells();
        }
      };
    }
    
    // Cast spell
    if (castBtn) {
      castBtn.onclick = () => handleCastSpell(index);
    }
  });
}

/* ========= CASTING LOGIC ========= */
function castSpell(index) {
  const spell = spells[index];
  if (!spell || !spell.cost) return;

  // 1. Check stamina cost
  const staminaCostObj = spell.cost.find(c => c.type === 'stamina');
  const staminaCost = staminaCostObj ? staminaCostObj.amount : 0;
  
  if (stamina < staminaCost) {
    alert("Not enough Stamina!");
    return;
  }

  // 2. Check Heart costs
  const heartsToRemove = [];
  let success = true;

  for (const c of spell.cost) {
    if (c.type === 'stamina') continue;

    if (c.type === 'generic') {
      let found = 0;
      for (let i = hearts.length - 1; i >= 0; i--) {
        if (!heartsToRemove.includes(i)) {
          heartsToRemove.push(i);
          found++;
          if (found >= c.amount) break;
        }
      }
      if (found < c.amount) { success = false; break; }
    } 
    else if (c.type === 'choice') {
      let found = 0;
      // Look for any heart that matches the allowed options
      for (let i = hearts.length - 1; i >= 0; i--) {
        if (c.options.includes(hearts[i].type) && !heartsToRemove.includes(i)) {
          heartsToRemove.push(i);
          found++;
          if (found >= c.amount) break;
        }
      }
      if (found < c.amount) { success = false; break; }
    }
    else if (c.type === 'x') {
      for (let i = 0; i < hearts.length; i++) {
        if (!heartsToRemove.includes(i)) heartsToRemove.push(i);
      }
    } 
    else {
      // Specific color
      let found = 0;
      for (let i = hearts.length - 1; i >= 0; i--) {
        if (hearts[i].type === c.type && !heartsToRemove.includes(i)) {
          heartsToRemove.push(i);
          found++;
          if (found >= c.amount) break;
        }
      }
      if (found < c.amount) { success = false; break; }
    }
  }

  if (!success) {
    alert("Not enough Hearts of the required types!");
    return;
  }
  
  // 3. Deduct resources
  stamina -= staminaCost;
  
  // Remove hearts (highest index first to maintain array order)
  heartsToRemove.sort((a, b) => b - a);
  heartsToRemove.forEach(idx => hearts.splice(idx, 1));

  // 4. Save and Update UI
  saveState('stamina', stamina);
  saveState('hearts', hearts);
  renderStats();
  renderHearts();
  
  const spellCard = document.querySelectorAll('.spell-card')[index];
  if (spellCard) {
    spellCard.classList.add('cast-flash');
    setTimeout(() => spellCard.classList.remove('cast-flash'), 500);
  }
}

// Check if player has enough resources
function canAffordSpell(cost, xValue = 0, genericChoice = null) {
  if (!cost || !Array.isArray(cost)) return true;
  
  // Mapping spell cost types (DB) to localStorage keys (System)
  const resourceMap = {
    'life': 'life',
    'stamina': 'stamina',
    'empower': 'empower',
    'mana': 'mana',
    'energy': 'energy',
    'coalesce': 'coalesce', // coalesce in cards = Coalesce in code
    'coalesce': 'coalesce',
    'crys': 'coalesce' // Crys also maps to coalesce
  };

  for (const c of cost) {
    // Skip costs that aren't player resources (display but don't deduct)
    const nonPlayerResources = [
      'tap', 'untap', 'channel', 'ready', 'swap', 'arrow', 'action',
      'potency', 'mastery', 'tinge', 'arcane', 'worm', 'skill', 
      'strength', 'madness', 'armour', 'shield'
    ];
    if (nonPlayerResources.includes(c.type.toLowerCase())) {
      continue;
    }

    let typeToCheck = c.type.toLowerCase();
    let amount = c.amount || 1;
    
    // Handle X costs
    if (typeToCheck === 'x') {
      amount = xValue;
      typeToCheck = (genericChoice || 'mana').toLowerCase();
    } 
    // Handle Generic costs
    else if (typeToCheck === 'generic') {
      typeToCheck = (genericChoice || 'mana').toLowerCase();
    }

    const storageKey = resourceMap[typeToCheck];
    
    // If it's a valid resource, check amount
    if (storageKey) {
      const current = Number(loadState(storageKey, 0)) || 0;
      if (current < amount) return false;
    }
  }
  return true;
}

// Deduct resources and update UI
function deductSpellCost(cost, xValue = 0, genericChoice = null) {
  if (!cost || !Array.isArray(cost)) return;

  const resourceMap = {
    'life': 'life',
    'stamina': 'stamina',
    'empower': 'empower',
    'mana': 'mana',
    'energy': 'energy',
    'coalesce': 'coalesce',
    'coalesce': 'coalesce',
    'crys': 'coalesce'
  };
  
  for (const c of cost) {
    // Skip costs that aren't player resources (display but don't deduct)
    const nonPlayerResources = [
      'tap', 'untap', 'channel', 'ready', 'swap', 'arrow', 'action',
      'potency', 'mastery', 'tinge', 'arcane', 'worm', 'skill', 
      'strength', 'madness', 'armour', 'shield'
    ];
    if (nonPlayerResources.includes(c.type.toLowerCase())) {
      continue;
    }

    let typeToCheck = c.type.toLowerCase();
    let amount = c.amount || 1;
    
    if (typeToCheck === 'x') {
      amount = xValue;
      typeToCheck = (genericChoice || 'mana').toLowerCase();
    } else if (typeToCheck === 'generic') {
      typeToCheck = (genericChoice || 'mana').toLowerCase();
    }

    const storageKey = resourceMap[typeToCheck];
    
    if (storageKey) {
      const current = Number(loadState(storageKey, 0)) || 0;
      const newValue = Math.max(0, current - amount);
      saveState(storageKey, newValue);
      console.log(`Paid ${amount} ${storageKey}. New value: ${newValue}`);
    }
  }
  
  // Force UI update for all bars
  updateAllBars();
  updateBottomStats();
}

// Handle the button click
function handleCastSpell(index) {
  const spell = spells[index];
  if (!spell?.name) return;
  // Ensure we always use canonical spellDB data
  const canonical = findSpellByName(spell.name);
  const cost = canonical?.cost ?? spell.cost ?? [];

  const { hasX, hasGeneric } = hasVariableCost(spell.cost);
  let xValue = 0;
  let genericChoice = 'Mana';
  
  // 1. Handle "X" Variable Costs
  if (hasX) {
    // First ask which resource
    const resourceInput = prompt(
      `Pay X cost with which resource?\n(Type: Life, Stamina, Mana, Energy, Empower, or coalesce)`, 
      'Mana'
    );
    if (resourceInput === null) return; // User cancelled
    
    genericChoice = resourceInput.trim();
    const validChoices = ['life', 'stamina', 'mana', 'energy', 'empower', 'coalesce', 'coalesce', 'crys'];
    
    if (!validChoices.includes(genericChoice.toLowerCase())) {
      alert('Invalid resource. Please type: Life, Stamina, Mana, Energy, Empower, or coalesce.');
      return;
    }
    
    // Then ask for amount
    const input = prompt(`Enter value for X (How much ${genericChoice} to spend?):`, '1');
    if (input === null) return; // User cancelled
    xValue = parseInt(input) || 0;
    if (xValue <= 0) {
      alert('X must be at least 1');
      return;
    }
  }
  
  // 2. Handle "Generic" (Grey Crystal) Costs
  if (hasGeneric) {
    // Simple prompt for resource selection
    const rawChoice = prompt(
      `Pay Generic Cost with which resource?\n(Type: Life, Stamina, Mana, Energy, Empower, or coalesce)`, 
      'Mana'
    );
    if (rawChoice === null) return; // User cancelled
    
    genericChoice = rawChoice.trim();
    const validChoices = ['life', 'stamina', 'mana', 'energy', 'empower', 'coalesce', 'coalesce', 'crys'];
    
    if (!validChoices.includes(genericChoice.toLowerCase())) {
      alert('Invalid resource. Please type: Life, Stamina, Mana, Energy, Empower, or coalesce.');
      return;
    }
  }
  
  // 3. Check Affordability
  if (!canAffordSpell(spell.cost, xValue, genericChoice)) {
    alert('Not enough resources to cast this spell!');
    return;
  }
  
  // 4. Confirmation (Optional)
  if (!castWarningDisabled) {
    if (!confirm(`Cast "${spell.name}"?`)) return;
  }
  
  // 5. Deduct and Finish
  deductSpellCost(spell.cost, xValue, genericChoice);
  
  // Visual Feedback
  const btn = document.querySelector(`.spell-slot[data-index="${index}"] .spell-cast-btn`);
  if(btn) {
    const originalText = btn.textContent;
    btn.textContent = "Cast!";
    btn.style.background = "rgba(76, 175, 80, 0.6)";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = "";
    }, 1000);
  }
}


function saveSpell(index, name) {
  const legendaryCount = getLegendarySlotCount();
  const isLegendarySlot = index < legendaryCount;
  const artefact = getCurrentArtefact();
  
  if (!name) {
    // Don't clear locked/prefilled spells
    if (!spells[index]?.locked && !spells[index]?.prefilled) {
      spells[index] = {};
    }
  } else {
    // Fuzzy lookup
    const foundSpell = findSpellByName(name);
    
    // Validate legendary slot restrictions
    if (isLegendarySlot) {
      const legendarySpellList = ARTEFACT_LEGENDARY_SPELLS[artefact] || [];
      const assignedSpells = assignedLegendarySpells[artefact] || [];
      
      // Special handling for The Wand
      if (artefact === "The Wand") {
        // The Wand allows any NON-LEGENDARY spell
        if (foundSpell) {
          // Check if the spell is legendary (id >= 532)
          if (foundSpell.id && foundSpell.id >= 532) {
            alert("The Wand can only hold non-legendary spells!");
            return;
          }
          
          // Replace cost with single coalesce
          spells[index] = {
            ...foundSpell,
            cost: [{ type: "coalesce", amount: 1 }],
            isLegendary: true, // It's in a legendary slot
            isWandSlot: true,
            originalCost: foundSpell.cost // Preserve original for reference
          };
        } else {
          // Custom spell for The Wand
          spells[index] = {
            name,
            type: 'Spell (via The Wand)',
            description: 'Custom spell - The Wand reduces all costs to a single coalesce.',
            cost: [{ type: "coalesce", amount: 1 }],
            isLegendary: true,
            isWandSlot: true
          };
        }
      } 
      // Normal legendary slots - restrict to assigned pool
      else {
        // First, try to fuzzy match the input to find the actual spell name
        let spellNameToCheck = name;
        let matchedSpell = foundSpell;
        
        // If foundSpell exists, use its name for validation (fuzzy match succeeded)
        if (foundSpell) {
          spellNameToCheck = foundSpell.name;
        }
        
        // Check if the spell (or fuzzy-matched spell) is from the artefact's legendary pool
        const isFromPool = legendarySpellList.some(s => 
          s.name.toLowerCase() === spellNameToCheck.toLowerCase()
        );
        
        if (!isFromPool) {
          const poolNames = legendarySpellList.map(s => s.name).join(', ');
          alert(`This legendary slot can only learn spells from ${artefact}'s pool:\n${poolNames}`);
          return;
        }
        
        // Valid legendary spell from pool
        if (matchedSpell) {
          spells[index] = {
            ...matchedSpell,
            isLegendary: true
          };
        } else {
          // Find the spell in the legendary list (for fallback)
          const legendarySpell = legendarySpellList.find(s => 
            s.name.toLowerCase() === spellNameToCheck.toLowerCase()
          );
          
          if (legendarySpell) {
            spells[index] = {
              name: legendarySpell.name,
              id: legendarySpell.id,
              image: `cards/fronts/${legendarySpell.id}.webp`,
              primaryType: "Legendary Spell",
              secondaryType: "",
              description: "A legendary spell granted by your Soulbound Artefact.",
              cost: [{ type: "coalesce", amount: 1 }],
              isLegendary: true
            };
          } else {
            spells[index] = {
              name: spellNameToCheck,
              type: 'Legendary Spell',
              description: 'Custom legendary spell - no data available.',
              cost: [],
              isLegendary: true
            };
          }
        }
      }
    } else {
      // Regular spell slot - no restrictions
      if (foundSpell) {
        spells[index] = {
          ...foundSpell,
          isLegendary: false
        };
      } else {
        // Custom spell (not in database)
        spells[index] = {
          name,
          type: 'Regular Spell',
          description: 'Custom spell - no data available.',
          cost: []
        };
      }
    }
  }
  saveState('spells', spells);
  renderSpells();
}

addSpellBtn.onclick = () => {
  const maxSlots = getMaxSpellSlots();
  const legendaryCount = getLegendarySlotCount();
  const regularMax = maxSlots - legendaryCount;
  
  // Check if all regular spell slots are full
  const regularCurrent = spells.slice(legendaryCount).filter(s => s?.name).length;
  
  if (regularCurrent >= regularMax) {
    // All slots full - show warning
    alert('Please improve Mastery or Potency to expand spell slots!');
    return;
  }
  
  // Find first empty regular spell slot
  let emptySlotIndex = -1;
  for (let i = legendaryCount; i < spells.length; i++) {
    if (!spells[i]?.name) {
      emptySlotIndex = i;
      break;
    }
  }
  
  // If no empty slots exist but we need more, create them
  if (emptySlotIndex === -1 && spells.length < maxSlots) {
    emptySlotIndex = spells.length;
    spells.push({});
  }
  
  if (emptySlotIndex === -1) {
    alert('Please improve Mastery or Potency to expand spell slots!');
    return;
  }
  
  // Get all learnable spells from spellDB
  // Exclude: legendary spells (id >= 532), and types "Madness Magic", "Beyond", "Basic"
  const excludedTypes = ["Madness Magic", "Beyond", "Basic"];
  
  const learnableSpells = Object.values(spellDB).filter(spell => {
    // Exclude legendary spells (id >= 532)
    if (spell.id && spell.id >= 532) {
      return false;
    }
    
    // Exclude forbidden primary types
    if (spell.primaryType && excludedTypes.includes(spell.primaryType)) {
      return false;
    }
    
    // Exclude forbidden secondary types
    if (spell.secondaryType && excludedTypes.includes(spell.secondaryType)) {
      return false;
    }
    
    return true;
  });
  
  if (learnableSpells.length === 0) {
    alert('No spells available to learn!');
    return;
  }
  
  // Randomly select a spell
  const randomIndex = Math.floor(Math.random() * learnableSpells.length);
  const randomSpell = learnableSpells[randomIndex];
  
  // Assign the spell to the empty slot
  spells[emptySlotIndex] = {
    ...randomSpell,
    isLegendary: false
  };
  
  saveState('spells', spells);
  renderSpells();
  
  console.log(`Learned random spell: ${randomSpell.name}`);
};

// Update mind button state when inventory changes
const originalRenderInventoryForMind = renderInventory;
renderInventory = function() {
  originalRenderInventoryForMind();
  updateMindButtonState();
};

// Initialize mind button state on page load
setTimeout(() => {
  updateMindButtonState();
}, 100);
// Helper function to render spell cost (keep your existing version)
function renderSpellCost(costs) {
  if (!costs || !Array.isArray(costs)) return '';
  
  return costs.map(cost => {
    // Handle Stamina icons
    if (cost.type === 'stamina') {
      return `<span class="cost-stamina" style="color:#ffcc00; font-weight:bold; margin: 0 4px;">⚡${cost.amount}</span>`;
    }
    
    // Handle Generic/X
    if (cost.type === 'generic' || cost.type === 'x') {
      return `<span class="cost-${cost.type}">${cost.amount || 'X'}</span>`;
    }

    // Handle Choice (e.g., Listen, Focus)
    if (cost.type === 'choice') {
      const optionsHtml = cost.options.map(opt => {
        const icon = COST_ICONS[opt] || COST_ICONS.generic;
        return `<div class="cost-icon mini" style="background-image: url('${icon}')"></div>`;
      }).join('<span class="choice-slash">/</span>');
      
      return `
      <div class="cost-choice-group">
        ${optionsHtml}
        ${cost.amount > 1 ? `<span class="cost-amount" style="margin-left:2px">x${cost.amount}</span>` : ''}
      </div>`;
    }

    // Default specific color
    const icon = COST_ICONS[cost.type] || COST_ICONS.generic;
    return `
    <div class="cost-icon" style="background-image: url('${icon}')">
      ${cost.amount > 1 ? `<span class="cost-amount">${cost.amount}</span>` : ''}
    </div>`;
  }).join('');
}
</script>
</body>
</html>