<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gameplay Guide</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
body { background: #1e1e2f; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; }
.container { width: 400px; background: linear-gradient(145deg, #2e2e3e, #1c1c28); border-radius: 16px; padding: 24px; box-shadow: 0 0 20px rgba(0,0,0,0.5); text-align: center; position: relative; }
.header { display: flex; justify-content: space-between; margin-bottom: 16px; }
.day-label { font-size: 1.2rem; font-weight: bold; }
.slot-label { font-size: 1.2rem; font-weight: bold; }
.text-area { height: 120px; margin: 16px 0; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; overflow-y: auto; text-align: left; }
.button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
.button:disabled { opacity: 0.4; cursor: default; }
.act-btn { background: #ffb347; color: #1e1e2f; }
.map-btn { background: #ffd700; color: #1e1e2f; }
.next-btn { background: #ff7f50; color: #fff; }
.dawn-btn { background: #87ceeb; color: #1e1e2f; }
.night-btn { background: #6a5acd; color: #fff; }
.interstitial-btn { background: #ff6347; color: #fff; }
.checkbox { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 2px solid #fff; cursor: pointer; transition: all 0.2s; user-select: none; }
.checkbox.checked { background: #32cd32; color: #1e1e2f; }
.reset-btn { position: absolute; top: 16px; left: 16px; padding: 8px 12px; background: #ff4d4d; border: none; border-radius: 12px; cursor: pointer; color: #fff; font-weight: bold; }
</style>
</head>
<body>

<button class="reset-btn" onclick="resetGame()">RESET</button>

<div class="container">
  <div class="header">
    <div class="day-label" id="dayLabel">DAWN of Cycle 1</div>
    <div class="slot-label" id="slotLabel">[0]</div>
  </div>
  <div class="text-area" id="textArea">All players gain one level and regain all light mana!</div>
  
  <div id="checkboxes" style="display:none;">
    <div class="checkbox" id="actCheckbox">ACT</div>
    <div class="checkbox" id="mapCheckbox">MAP</div>
  </div>
  
  <button class="button" id="mainButton">CONTINUE</button>
</div>

<script>
/* State */
let cycle = 1;           // starts at 1, showing Dawn [0] initially
let slot = 0;            // 0 = DAWN, 1..11 = day, 12..17 = night slots
let isNight = false;
let nightStep = 0;       // 0..5 maps to slots 12..17
let phaseMode = null;    // used for special 'deep' (Deep of Night) handling

/* Texts */
const dayText = [
  "You may play any card.",
  "You may play any card.",
  "You may play any card. If you choose a B or C card, gain one empower.",
  "You may play any card.",
  "You may play any card.",
  "You must play a B or C card.",
  "You may play any card.",
  "You may play any card.",
  "You may play any card.",
  "You may play any card.",
  "You must play a B or C card."
];

const nightText = [
  "You must play a B card. Add +1 coin to reward pile.",
  "You must play a C card. Double reward pile.",
  "You must play a B card. Double reward pile.",
  "You must play a C card. Double reward pile.",
  "You must play a B card. Double reward pile.",
  "You must play a C card."
];

/* --- Dynamic Flavor Text Configuration --- */
const dayFlavorTable = {
  7: [
    { text: "<i>If you play a Discovery card, find a coin.</i>", chance: 0.10 },
  ],
  8: [
    { text: "<i>If you play a Discovery card, find a coin.</i>", chance: 0.10 },
  ],
  9: [
    { text: "<i>If you play a Discovery card, find a coin.</i>", chance: 0.10 },
  ],
  10: [
    { text: "<i>If you play a Discovery card, find a coin.</i>", chance: 0.10 },
    { text: "<i>The shadows seem to whisper...</i>", chance: 0.05, cycleModifier: (c) => Math.min(1, 0.05 + 0.03*c) }
  ]
};

const nightFlavorTable = {
  12: [
    { text: "<i>A faint light flickers in the darkness...</i>", chance: 0.05 }
  ],
  14: [
    { text: "<i>If you ignore the warning, lose 1 life.</i>", chance: 0.05, cycleModifier: (c)=> Math.min(1, 0.05 + 0.02*c) }
  ]
};

/* Helper: roll flavor text for a slot and cycle */
function getSlotFlavor(slotNum, cycleCount, table) {
  const flavors = table[slotNum] || [];
  let result = "";
  flavors.forEach(f => {
    let prob = f.chance;
    if (f.cycleModifier) prob = f.cycleModifier(cycleCount);
    if (Math.random() < prob) result += "<br><br>" + f.text;
  });
  return result;
}

/* Overwrite your dayText/nightText functions to include random flavor */
function getDayText(slot) {
  let baseText = [
    "You may play any card.",
    "You may play any card.",
    "You may play any card. <br>If you choose a <b>B</b> or <b>C</b> card, gain one empower.",
    "You may play any card.",
    "You may play any card.",
    "You <b>must</b> play a <b>B</b> or <b>C</b> card.",
    "You may play any card.",
    "You may play any card.",
    "You may play any card.",
    "You may play any card.",
    "You <b>must</b> play a <b>B</b> or <b>C</b> card."
  ][slot - 1] || "";

  baseText += getSlotFlavor(slot, cycle, dayFlavorTable);
  return baseText;
}

function getNightText(nStep) {
  const baseText = [
    "You <b>must</b> play a B card. Add +1 coin to reward pile.",
    "You <b>must</b> play a C card. Double reward pile.",
    "You <b>must</b> play a B card. Double reward pile.",
    "You <b>must</b> play a C card. Double reward pile.",
    "You <b>must</b> play a B card. Double reward pile.",
    "You <b>must</b> play a C card."
  ][nStep] || "";

  return baseText + getSlotFlavor(12 + nStep, cycle, nightFlavorTable);
}

/* --- Integrate into updateUI --- */
function updateUI(){
  cleanupTransientButtons();

  if (slot === 0){
    // DAWN
    dayLabel.innerText = `DAWN of Cycle ${cycle}`;
    slotLabel.innerText = '[0]';
    textArea.innerHTML = "All players gain one level and regain all light mana!";
    checkboxesDiv.style.display = 'none';
    mainButton.style.display = 'block';
    mainButton.innerText = 'CONTINUE';
    mainButton.disabled = false;
    phaseMode = null;
    return;
  }

  if (!isNight && slot > 0 && slot <= daySlots){
    dayLabel.innerText = `The ${ordinal(cycle)} Day`;
    slotLabel.innerText = `[${slot}]`;
    textArea.innerHTML = getDayText(slot);
    checkboxesDiv.style.display = 'flex';
    restoreStableCheckboxes();
    actCheckbox.classList.remove('checked');
    mapCheckbox.classList.remove('checked');
    mainButton.innerText = 'NEXT PLAYER';
    mainButton.disabled = true;
    mainButton.style.display = 'block';
    phaseMode = null;
    return;
  }

  if (isNight){
    dayLabel.innerText = `The ${ordinal(cycle)} Night`;
    slotLabel.innerText = `[${12 + nightStep}]`;
    textArea.innerHTML = getNightText(nightStep);
    checkboxesDiv.style.display = 'flex';
    restoreStableCheckboxes();
    actCheckbox.classList.remove('checked');
    mapCheckbox.classList.remove('checked');
    mainButton.innerText = (nightStep === nightSlots - 1) ? 'END THE NIGHT' : 'NEXT PLAYER';
    mainButton.disabled = true;
    mainButton.style.display = 'block';
    phaseMode = null;
    return;
  }
}


const daySlots = 11;
const nightSlots = 6;

/* Elements */
const dayLabel = document.getElementById('dayLabel');
const slotLabel = document.getElementById('slotLabel');
const textArea = document.getElementById('textArea');
const mainButton = document.getElementById('mainButton');
const checkboxesDiv = document.getElementById('checkboxes');

/* Stable checkbox nodes */
let actCheckbox = document.getElementById('actCheckbox');
let mapCheckbox = document.getElementById('mapCheckbox');

/* Helpers */
function ordinal(n){
  return ["First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh"][n-1] || n + "th";
}

function enableMainIfBothChecked(){
  if (!actCheckbox || !mapCheckbox) { mainButton.disabled = true; return; }
  mainButton.disabled = !(actCheckbox.classList.contains('checked') && mapCheckbox.classList.contains('checked'));
}

/* centralised Dawn entry - increments cycle once */
function goToDawn(increment = true){
  if (increment) cycle++;
  isNight = false;
  nightStep = 0;
  slot = 0;
  phaseMode = null;
  cleanupTransientButtons();
  restoreStableCheckboxes(); // ensure ACT/MAP exists and reset
  updateUI();
}

/* restore (or ensure) ACT/MAP stable DOM nodes and listeners */
function restoreStableCheckboxes(){
  // If the checkboxes container got rewritten (deep of night), recreate stable nodes
  if (!document.getElementById('actCheckbox') || !document.getElementById('mapCheckbox')) {
    checkboxesDiv.innerHTML = '<div class="checkbox" id="actCheckbox">ACT</div><div class="checkbox" id="mapCheckbox">MAP</div>';
    actCheckbox = document.getElementById('actCheckbox');
    mapCheckbox = document.getElementById('mapCheckbox');
    actCheckbox.addEventListener('click', toggleCheckbox);
    mapCheckbox.addEventListener('click', toggleCheckbox);
  }
  // reset visuals
  actCheckbox.classList.remove('checked');
  mapCheckbox.classList.remove('checked');
}

/* cleanup any transient buttons created by interstitials */
function cleanupTransientButtons(){
  document.querySelectorAll('.container button.dawn-btn, .container button.night-btn, .container button.interstitial-btn').forEach(b => b.remove());
}

/* checkbox toggle */
function toggleCheckbox(){
  this.classList.toggle('checked');
  enableMainIfBothChecked();
}

/* UI update */
function updateUI(){
  cleanupTransientButtons();

  if (slot === 0){
    // DAWN
    dayLabel.innerText = `DAWN of Cycle ${cycle}`;
    slotLabel.innerText = '[0]';
    textArea.innerHTML = "All players gain one level and regain all light mana!";
    checkboxesDiv.style.display = 'none';
    mainButton.style.display = 'block';
    mainButton.innerText = 'CONTINUE';
    mainButton.disabled = false;
    phaseMode = null;
    return;
  }

  if (!isNight && slot > 0 && slot <= daySlots){
    dayLabel.innerText = `The ${ordinal(cycle)} Day`;
    slotLabel.innerText = `[${slot}]`;
    textArea.innerHTML = dayText[slot-1] || "";
    checkboxesDiv.style.display = 'flex';
    restoreStableCheckboxes();
    actCheckbox.classList.remove('checked');
    mapCheckbox.classList.remove('checked');
    mainButton.innerText = 'NEXT PLAYER';
    mainButton.disabled = true;
    mainButton.style.display = 'block';
    phaseMode = null;
    return;
  }

  if (isNight){
    dayLabel.innerText = `The ${ordinal(cycle)} Night`;
    slotLabel.innerText = `[${12 + nightStep}]`;
    textArea.innerHTML = nightText[nightStep] || "";
    checkboxesDiv.style.display = 'flex';
    restoreStableCheckboxes();
    actCheckbox.classList.remove('checked');
    mapCheckbox.classList.remove('checked');
    mainButton.innerText = (nightStep === nightSlots - 1) ? 'END THE NIGHT' : 'NEXT PLAYER';
    mainButton.disabled = true;
    mainButton.style.display = 'block';
    phaseMode = null;
    return;
  }
}

/* DUSK choice (creates its own two buttons) */
function showDuskChoice(){
  checkboxesDiv.style.display = 'none';
  mainButton.style.display = 'none';
  textArea.innerHTML = "DUSK: Choose to proceed to DAWN or enter NIGHT.";

  const dawnBtn = document.createElement('button');
  dawnBtn.className = 'button dawn-btn';
  dawnBtn.innerText = 'Proceed to DAWN';
  dawnBtn.disabled = true;

  const nightBtn = document.createElement('button');
  nightBtn.className = 'button night-btn';
  nightBtn.innerText = 'Enter NIGHT';
  nightBtn.disabled = true;

  document.querySelector('.container').appendChild(dawnBtn);
  document.querySelector('.container').appendChild(nightBtn);

  let cooldown = 3;
  const interval = setInterval(()=> {
    cooldown--;
    if (cooldown <= 0){
      dawnBtn.disabled = false;
      nightBtn.disabled = false;
      clearInterval(interval);
    }
  },1000);

  dawnBtn.addEventListener('click', ()=>{
    // go to next dawn (increment once)
    dawnBtn.remove(); nightBtn.remove();
    goToDawn(true);
  });

  nightBtn.addEventListener('click', ()=>{
    dawnBtn.remove(); nightBtn.remove();
    isNight = true;
    nightStep = 0;
    slot = 12;
    updateUI();
  });
}

/* Interstitial between night slots (end night or continue) */
function showContinueNightInterstitial(){
  checkboxesDiv.style.display = 'none';
  mainButton.style.display = 'none';
  textArea.innerHTML = "Choose your next action wisely...";

  const endBtn = document.createElement('button');
  endBtn.className = 'button interstitial-btn';
  endBtn.innerText = 'Loot the rewards, proceed to DAWN';

  const contBtn = document.createElement('button');
  contBtn.className = 'button interstitial-btn';
  contBtn.innerText = 'Continue the night...';

  document.querySelector('.container').appendChild(endBtn);
  document.querySelector('.container').appendChild(contBtn);

  endBtn.addEventListener('click', ()=>{
    // End night -> go to next dawn (increment)
    endBtn.remove(); contBtn.remove();
    goToDawn(true);
  });

  contBtn.addEventListener('click', ()=>{
    // continue night to next night slot
    endBtn.remove(); contBtn.remove();
    nightStep++;
    slot++;
    updateUI();
  });
}

/* Deep of Night view — uses phaseMode 'deep' and mainButton handles continue */
function showDeepOfNight() {
  // set phase mode so main handler knows how to behave
  phaseMode = 'deep';

  // set title and labels correctly
  dayLabel.innerText = `The Deep Of The ${ordinal(cycle)} Night`;
  slotLabel.innerText = "[17]";

  textArea.innerHTML = "Congratulations, you have survived the night...";

  // replace checkboxes with loot + level
  checkboxesDiv.innerHTML = '';
  const lootBtn = document.createElement('div'); 
  lootBtn.className = 'checkbox'; 
  lootBtn.innerText = 'Loot the rewards!!';

  const levelBtn = document.createElement('div'); 
  levelBtn.className = 'checkbox'; 
  levelBtn.innerText = 'Everyone gain 1 level!';

  checkboxesDiv.appendChild(lootBtn);
  checkboxesDiv.appendChild(levelBtn);
  checkboxesDiv.style.display = 'flex';

  mainButton.innerText = 'NEXT PLAYER';
  mainButton.disabled = true;
  mainButton.style.display = 'block';

  function checkDeep() {
    mainButton.disabled = !(lootBtn.classList.contains('checked') && levelBtn.classList.contains('checked'));
  }

  lootBtn.addEventListener('click', () => { 
    lootBtn.classList.toggle('checked'); 
    checkDeep(); 
  });
  levelBtn.addEventListener('click', () => { 
    levelBtn.classList.toggle('checked'); 
    checkDeep(); 
  });
}


/* Main central handler (single listener) */
function handleMainButton(){
  // If we're in deep-of-night mode, use central goToDawn (increment)
  if (phaseMode === 'deep'){
    goToDawn(true);
    return;
  }

  // Normal flows:
  if (!isNight){
    if (slot === 0){
      // Dawn continue -> go to first day slot
      slot = 1;
      updateUI();
      return;
    }
    if (slot < daySlots){
      slot++;
      updateUI();
      return;
    }
    // finished daySlots -> show dusk prompt
    showDuskChoice();
    return;
  } else {
    // Night flows
    if (nightStep < nightSlots - 1){
      // show interstitial (end/continue)
      showContinueNightInterstitial();
      return;
    } else {
      // last night slot -> deep of night
      showDeepOfNight();
      return;
    }
  }
}

/* Reset logic */
function resetGame(){
  if (!confirm("Are you sure you want to reset all game data?")) return;
  cycle = 1;
  slot = 0;
  isNight = false;
  nightStep = 0;
  phaseMode = null;
  cleanupTransientButtons();
  // restore stable checkboxes
  checkboxesDiv.innerHTML = '<div class="checkbox" id="actCheckbox">ACT</div><div class="checkbox" id="mapCheckbox">MAP</div>';
  actCheckbox = document.getElementById('actCheckbox');
  mapCheckbox = document.getElementById('mapCheckbox');
  actCheckbox.addEventListener('click', toggleCheckbox);
  mapCheckbox.addEventListener('click', toggleCheckbox);
  actCheckbox.classList.remove('checked');
  mapCheckbox.classList.remove('checked');
  checkboxesDiv.style.display = 'none';
  dayLabel.innerText = "DAWN of Cycle 1";
  slotLabel.innerText = "[0]";
  textArea.innerHTML = "All players gain one level and regain all light mana!";
  mainButton.innerText = "CONTINUE";
  mainButton.disabled = false;
  mainButton.style.display = 'block';
}

/* Attach listeners and initialise */
mainButton.addEventListener('click', handleMainButton);
actCheckbox.addEventListener('click', toggleCheckbox);
mapCheckbox.addEventListener('click', toggleCheckbox);

/* initial UI */
updateUI();
</script>
</body>
</html>
